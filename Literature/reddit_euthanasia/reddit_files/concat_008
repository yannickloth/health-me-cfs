SML.dm("BWsefVxP0Y",[],(async()=>{var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,s=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),a=(e,n)=>{for(var r in n)t(e,r,{get:n[r],enumerable:!0})},l=(s,a,l)=>(l=null!=s?e(i(s)):{},((e,i,s,a)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let l of r(i))!o.call(e,l)&&l!==s&&t(e,l,{get:()=>i[l],enumerable:!(a=n(i,l))||a.enumerable});return e})(s&&s.__esModule?l:t(l,"default",{value:s,enumerable:!0}),s)),u=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)},d=(e,t,n)=>(u(e,t,"read from private field"),n?n.call(e):t.get(e)),c=s(((e,t)=>{var n,r;n=e,r=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function i(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch{return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function o(){console.log&&(console.log.apply||Function.prototype.apply.apply(console.log,[console,arguments]))}function s(t,n){for(var i=0;i<r.length;i++){var o=r[i];this[o]=i<t?e:this.methodFactory(o,t,n)}this.log=this.debug}function a(e,n,r){return function(){typeof console!==t&&(s.call(this,n,r),this[e].apply(this,arguments))}}function l(r,s,l){return function(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&n?o:void 0!==console[r]?i(console,r):void 0!==console.log?i(console,"log"):e)}(r)||a.apply(this,arguments)}function u(e,n,i){var o,a=this;n=null==n?"WARN":n;var u="loglevel";function d(){var e;if(typeof window!==t&&u){try{e=window.localStorage[u]}catch{}if(typeof e===t)try{var n=window.document.cookie,r=n.indexOf(encodeURIComponent(u)+"=");-1!==r&&(e=/^([^;]+)/.exec(n.slice(r))[1])}catch{}return void 0===a.levels[e]&&(e=void 0),e}}"string"==typeof e?u+=":"+e:"symbol"==typeof e&&(u=void 0),a.name=e,a.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},a.methodFactory=i||l,a.getLevel=function(){return o},a.setLevel=function(n,i){if("string"==typeof n&&void 0!==a.levels[n.toUpperCase()]&&(n=a.levels[n.toUpperCase()]),!("number"==typeof n&&n>=0&&n<=a.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(o=n,!1!==i&&function(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t&&u){try{return void(window.localStorage[u]=n)}catch{}try{window.document.cookie=encodeURIComponent(u)+"="+n+";"}catch{}}}(n),s.call(a,n,e),typeof console===t&&n<a.levels.SILENT)return"No console available for logging"},a.setDefaultLevel=function(e){n=e,d()||a.setLevel(e,!1)},a.resetLevel=function(){a.setLevel(n,!1),function(){if(typeof window!==t&&u){try{return void window.localStorage.removeItem(u)}catch{}try{window.document.cookie=encodeURIComponent(u)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}()},a.enableAll=function(e){a.setLevel(a.levels.TRACE,e)},a.disableAll=function(e){a.setLevel(a.levels.SILENT,e)};var c=d();null==c&&(c=n),a.setLevel(c,!1)}var d=new u,c={};d.getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=c[e];return t||(t=c[e]=new u(e,d.getLevel(),d.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return d.noConflict=function(){return typeof window!==t&&window.log===d&&(window.log=h),d},d.getLoggers=function(){return c},d.default=d,d},"function"==typeof define&&define.amd?define(r):"object"==typeof t&&t.exports?t.exports=r():n.log=r()})),h=s(((e,t)=>{var n,r="object"==typeof Reflect?Reflect:null,i=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};n=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}t.exports=s,t.exports.once=function(e,t){return new Promise((function(n,r){function i(n){e.removeListener(t,o),r(n)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}f(e,t,o,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&f(e,"error",t,n)}(e,i,{once:!0})}))},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function l(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function d(e,t,n,r){var i,o,s;if(l(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),s=o[t]),void 0===s)s=o[t]=n,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(i=u(e))>0&&s.length>i&&!s.warned){s.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=s.length}return e}function c(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=c.bind(r);return i.listener=n,r.wrapFn=i,i}function m(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):p(i,i.length)}function v(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function p(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function f(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(o){r.once&&e.removeEventListener(t,i),n(o)}))}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),s.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return u(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,o=this._events;if(void 0!==o)r=r&&void 0===o.error;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var l=o[e];if(void 0===l)return!1;if("function"==typeof l)i(l,this,t);else{var u=l.length,d=p(l,u);for(n=0;n<u;++n)i(d[n],this,t)}return!0},s.prototype.addListener=function(e,t){return d(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return d(this,e,t,!0)},s.prototype.once=function(e,t){return l(t),this.on(e,h(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,h(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,r,i,o,s;if(l(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},s.prototype.listeners=function(e){return m(this,e,!0)},s.prototype.rawListeners=function(e){return m(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):v.call(e,t)},s.prototype.listenerCount=v,s.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}})),m=s((e=>{var t=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,n=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,r=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,i=/\\([\u000b\u0020-\u00ff])/g,o=/([\\"])/g,s=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function a(e){var t=String(e);if(r.test(t))return t;if(t.length>0&&!n.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(o,"\\$1")+'"'}function l(e){this.parameters=Object.create(null),this.type=e}e.format=function(e){if(!e||"object"!=typeof e)throw new TypeError("argument obj is required");var t=e.parameters,n=e.type;if(!n||!s.test(n))throw new TypeError("invalid type");var i=n;if(t&&"object"==typeof t)for(var o,l=Object.keys(t).sort(),u=0;u<l.length;u++){if(o=l[u],!r.test(o))throw new TypeError("invalid parameter name");i+="; "+o+"="+a(t[o])}return i},e.parse=function(e){if(!e)throw new TypeError("argument string is required");var n="object"==typeof e?function(e){var t;if("function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]),"string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof n)throw new TypeError("argument string is required to be a string");var r=n.indexOf(";"),o=-1!==r?n.substr(0,r).trim():n.trim();if(!s.test(o))throw new TypeError("invalid media type");var a=new l(o.toLowerCase());if(-1!==r){var u,d,c;for(t.lastIndex=r;d=t.exec(n);){if(d.index!==r)throw new TypeError("invalid parameter format");r+=d[0].length,u=d[1].toLowerCase(),'"'===(c=d[2])[0]&&(c=c.substr(1,c.length-2).replace(i,"$1")),a.parameters[u]=c}if(r!==n.length)throw new TypeError("invalid parameter format")}return a}})),v=s((e=>{function t(e,t){var r=typeof Symbol<"u"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return n(e,t)}}(e))||t){r&&(e=r);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){l=!0,s=e},f:function(){try{!a&&null!=r.return&&r.return()}finally{if(l)throw s}}}}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function r(e,t,n){return function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(e,"__esModule",{value:!0}),e.NamespacedMap=void 0;var i=function(){function e(n){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(this,"internalMap",new Map),n){var r,i=t(n);try{for(i.s();!(r=i.n()).done;){var o=r.value;this.set(o[0],o[1])}}catch(e){i.e(e)}finally{i.f()}}}return r(e,[{key:"get",value:function(e){return e.name&&this.internalMap.has(e.name)?this.internalMap.get(e.name):e.altName&&this.internalMap.has(e.altName)?this.internalMap.get(e.altName):null}},{key:"set",value:function(e,t){e.name&&this.internalMap.set(e.name,t),e.altName&&this.internalMap.set(e.altName,t)}},{key:"has",value:function(e){return!!this.get(e)}},{key:"delete",value:function(e){e.name&&this.internalMap.delete(e.name),e.altName&&this.internalMap.delete(e.altName)}},{key:"hasNamespaced",value:function(e){return this.internalMap.has(e)}},{key:"getNamespaced",value:function(e){return this.internalMap.get(e)}}]),e}();e.NamespacedMap=i})),p=s((e=>{function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e){var n=o();return function(){var r,i=a(e);if(n){var o=a(this).constructor;r=Reflect.construct(i,arguments,o)}else r=i.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,r)}}function r(e){var t="function"==typeof Map?new Map:void 0;return r=function(e){if(null===e||!function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(typeof t<"u"){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return i(e,arguments,a(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),s(n,e)},r(e)}function i(e,t,n){return(i=o()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&s(i,n.prototype),i}).apply(null,arguments)}function o(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch{return!1}}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.InvalidEventError=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&s(e,t)}(r,e);var t=n(r);function r(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),t.call(this,e)}return function(e){return Object.defineProperty(e,"prototype",{writable:!1}),e}(r)}(r(Error));e.InvalidEventError=l})),f=s((e=>{function t(e,t,n){return function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(e,"__esModule",{value:!0}),e.ExtensibleEvent=void 0;var n=function(){function e(t){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),this.wireFormat=t}return t(e,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),e}();e.ExtensibleEvent=n})),g=s((e=>{function t(e){return null!=e}Object.defineProperty(e,"__esModule",{value:!0}),e.isOptionalAString=function(e){return t(e)&&"string"==typeof e},e.isProvided=t})),y=s((e=>{function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function r(e){var n=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch{return!1}}();return function(){var r,o=i(e);if(n){var s=i(this).constructor;r=Reflect.construct(o,arguments,s)}else r=o.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,r)}}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(e,"__esModule",{value:!0}),e.UnstableValue=e.NamespacedValue=void 0;var a=function(){function e(t,n){if(o(this,e),this.stable=t,this.unstable=n,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return s(e,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(e){return!!this.name&&this.name===e||!!this.altName&&this.altName===e}},{key:"findIn",value:function(e){var t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}},{key:"includedIn",value:function(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}]),e}();e.NamespacedValue=a;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),n(e,t)}(i,e);var t=r(i);function i(e,n){var r;if(o(this,i),!(r=t.call(this,e,n)).unstable)throw new Error("Unstable value must be supplied");return r}return s(i,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),i}(a);e.UnstableValue=l})),E=s((e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.M_TEXT=e.M_NOTICE=e.M_MESSAGE=e.M_HTML=e.M_EMOTE=void 0;var t=y(),n=new t.UnstableValue("m.message","org.matrix.msc1767.message");e.M_MESSAGE=n;var r=new t.UnstableValue("m.text","org.matrix.msc1767.text");e.M_TEXT=r;var i=new t.UnstableValue("m.html","org.matrix.msc1767.html");e.M_HTML=i;var o=new t.UnstableValue("m.emote","org.matrix.msc1767.emote");e.M_EMOTE=o;var s=new t.UnstableValue("m.notice","org.matrix.msc1767.notice");e.M_NOTICE=s})),b=s((e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.isEventTypeSame=function(e,t){if("string"==typeof e)return"string"==typeof t?t===e:t.matches(e);if("string"==typeof t)return e.matches(t);var n=t,r=e;return n.matches(r.name)||n.matches(r.altName)}})),_=s((e=>{function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.MessageEvent=void 0;var n=f(),r=g(),i=p(),o=E(),s=b();function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){v(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){var n=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch{return!1}}();return function(){var r,i=m(e);if(n){var o=m(this).constructor;r=Reflect.construct(i,arguments,o)}else r=i.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}(this,r)}}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(n,e);var t=c(n);function n(e){var s;(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,n),v(h(s=t.call(this,e)),"text",void 0),v(h(s),"html",void 0),v(h(s),"renderings",void 0);var a=o.M_MESSAGE.findIn(s.wireContent),l=o.M_TEXT.findIn(s.wireContent),u=o.M_HTML.findIn(s.wireContent);if((0,r.isProvided)(a)){if(!Array.isArray(a))throw new i.InvalidEventError("m.message contents must be an array");var d=a.find((function(e){return!(0,r.isProvided)(e.mimetype)||"text/plain"===e.mimetype})),c=a.find((function(e){return"text/html"===e.mimetype}));if(!d)throw new i.InvalidEventError("m.message is missing a plain text representation");s.text=d.body,s.html=null==c?void 0:c.body,s.renderings=a}else{if(!(0,r.isOptionalAString)(l))throw new i.InvalidEventError("Missing textual representation for event");s.text=l,s.html=u,s.renderings=[{body:l,mimetype:"text/plain"}],s.html&&s.renderings.push({body:s.html,mimetype:"text/html"})}return s}return function(e,t,n){u(e.prototype,t),u(e,n),Object.defineProperty(e,"prototype",{writable:!1})}(n,[{key:"isEmote",get:function(){return o.M_EMOTE.matches(this.wireFormat.type)||(0,r.isProvided)(o.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return o.M_NOTICE.matches(this.wireFormat.type)||(0,r.isProvided)(o.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,o.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var e=v({},o.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var t=this.renderings[0].mimetype;(void 0===t||"text/plain"===t)&&(e=v({},o.M_TEXT.name,this.renderings[0].body))}return e}},{key:"serialize",value:function(){var e;return{type:"m.room.message",content:l(l({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(e=this.html)&&void 0!==e?e:void 0})}}}],[{key:"from",value:function(e,t){var r;return new n({type:o.M_MESSAGE.name,content:(r={},v(r,o.M_TEXT.name,e),v(r,o.M_HTML.name,t),r)})}}]),n}(n.ExtensibleEvent);e.MessageEvent=y})),R=s((e=>{function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.NoticeEvent=void 0;var n=_(),r=E(),i=b();function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(){return a=typeof Reflect<"u"&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=d(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},a.apply(this,arguments)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){var n=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch{return!1}}();return function(){var r,i=d(e);if(n){var o=d(this).constructor;r=Reflect.construct(i,arguments,o)}else r=i.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,r)}}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(n,e);var t=u(n);function n(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),t.call(this,e)}return function(e,t,n){s(e.prototype,t),s(e,n),Object.defineProperty(e,"prototype",{writable:!1})}(n,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,i.isEventTypeSame)(e,r.M_NOTICE)||a(d(n.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=a(d(n.prototype),"serialize",this).call(this);return e.content.msgtype="m.notice",e}}],[{key:"from",value:function(e,t){var i;return new n({type:r.M_NOTICE.name,content:(i={},o(i,r.M_TEXT.name,e),o(i,r.M_HTML.name,t),i)})}}]),n}(n.MessageEvent);e.NoticeEvent=c})),T=s((e=>{function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.EmoteEvent=void 0;var n=_(),r=E(),i=b();function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(){return a=typeof Reflect<"u"&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=d(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},a.apply(this,arguments)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){var n=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch{return!1}}();return function(){var r,i=d(e);if(n){var o=d(this).constructor;r=Reflect.construct(i,arguments,o)}else r=i.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,r)}}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(n,e);var t=u(n);function n(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),t.call(this,e)}return function(e,t,n){s(e.prototype,t),s(e,n),Object.defineProperty(e,"prototype",{writable:!1})}(n,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,i.isEventTypeSame)(e,r.M_EMOTE)||a(d(n.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=a(d(n.prototype),"serialize",this).call(this);return e.content.msgtype="m.emote",e}}],[{key:"from",value:function(e,t){var i;return new n({type:r.M_EMOTE.name,content:(i={},o(i,r.M_TEXT.name,e),o(i,r.M_HTML.name,t),i)})}}]),n}(n.MessageEvent);e.EmoteEvent=c})),S=s((e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.LEGACY_M_ROOM_MESSAGE=void 0,e.parseMRoomMessage=function(e){var i,s,u;if(o.M_MESSAGE.findIn(e.content)||o.M_TEXT.findIn(e.content))return new t.MessageEvent(e);var d,c=null===(i=e.content)||void 0===i?void 0:i.msgtype,h=null===(s=e.content)||void 0===s?void 0:s.body,m="org.matrix.custom.html"===(null===(u=e.content)||void 0===u?void 0:u.format)?e.content.formatted_body:null;return"m.text"===c?new t.MessageEvent(a(a({},e),{},{content:a(a({},e.content),{},(d={},l(d,o.M_TEXT.name,h),l(d,o.M_HTML.name,m),d))})):"m.notice"===c?new n.NoticeEvent(a(a({},e),{},{content:a(a({},e.content),{},(v={},l(v,o.M_TEXT.name,h),l(v,o.M_HTML.name,m),v))})):"m.emote"===c?new r.EmoteEvent(a(a({},e),{},{content:a(a({},e.content),{},(p={},l(p,o.M_TEXT.name,h),l(p,o.M_HTML.name,m),p))})):null;var v,p};var t=_(),n=R(),r=T(),i=y(),o=E();function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=new i.NamespacedValue("m.room.message");e.LEGACY_M_ROOM_MESSAGE=u})),w=s((e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.parseMMessage=function(e){return n.M_EMOTE.matches(e.type)?new r.EmoteEvent(e):n.M_NOTICE.matches(e.type)?new i.NoticeEvent(e):new t.MessageEvent(e)};var t=_(),n=E(),r=T(),i=R()})),I=s((e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.M_POLL_START=e.M_POLL_RESPONSE=e.M_POLL_KIND_UNDISCLOSED=e.M_POLL_KIND_DISCLOSED=e.M_POLL_END=void 0;var t=y(),n=new t.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");e.M_POLL_KIND_DISCLOSED=n;var r=new t.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");e.M_POLL_KIND_UNDISCLOSED=r;var i=new t.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");e.M_POLL_START=i;var o=new t.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");e.M_POLL_RESPONSE=o;var s=new t.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");e.M_POLL_END=s})),O=s((e=>{function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.PollStartEvent=e.PollAnswerSubevent=void 0;var n=I(),r=_(),i=E(),o=p(),s=y(),a=b(),l=f();function u(e){return function(e){if(Array.isArray(e))return d(e)}(e)||function(e){if(typeof Symbol<"u"&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return d(e,t)}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){M(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function v(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t,n){return t&&v(e.prototype,t),n&&v(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function R(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&T(e,t)}function T(e,t){return(T=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function S(e){var n=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch{return!1}}();return function(){var r,i=O(e);if(n){var o=O(this).constructor;r=Reflect.construct(i,arguments,o)}else r=i.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return w(e)}(this,r)}}function w(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function O(e){return(O=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var P=function(e){R(n,e);var t=S(n);function n(e){var r;m(this,n),M(w(r=t.call(this,e)),"id",void 0);var i=e.content.id;if(!i||"string"!=typeof i)throw new o.InvalidEventError("Answer ID must be a non-empty string");return r.id=i,r}return g(n,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:h({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(e,t){return new n({type:"org.matrix.sdk.poll.answer",content:M({id:e},i.M_TEXT.name,t)})}}]),n}(r.MessageEvent);e.PollAnswerSubevent=P;var C=function(e){R(l,e);var t=S(l);function l(e){var i;m(this,l),M(w(i=t.call(this,e)),"question",void 0),M(w(i),"kind",void 0),M(w(i),"rawKind",void 0),M(w(i),"maxSelections",void 0),M(w(i),"answers",void 0);var s=n.M_POLL_START.findIn(i.wireContent);if(!s.question)throw new o.InvalidEventError("A question is required");if(i.question=new r.MessageEvent({type:"org.matrix.sdk.poll.question",content:s.question}),i.rawKind=s.kind,n.M_POLL_KIND_DISCLOSED.matches(i.rawKind)?i.kind=n.M_POLL_KIND_DISCLOSED:i.kind=n.M_POLL_KIND_UNDISCLOSED,i.maxSelections=Number.isFinite(s.max_selections)&&s.max_selections>0?s.max_selections:1,!Array.isArray(s.answers))throw new o.InvalidEventError("Poll answers must be an array");var a=s.answers.slice(0,20).map((function(e){return new P({type:"org.matrix.sdk.poll.answer",content:e})}));if(a.length<=0)throw new o.InvalidEventError("No answers available");return i.answers=a,i}return g(l,[{key:"isEquivalentTo",value:function(e){return(0,a.isEventTypeSame)(e,n.M_POLL_START)}},{key:"serialize",value:function(){var e;return{type:n.M_POLL_START.name,content:(e={},M(e,n.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map((function(e){return e.serialize().content}))}),M(e,i.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map((function(e,t){return"".concat(t+1,". ").concat(e.text)})).join("\n"))),e)}}}],[{key:"from",value:function(e,t,r){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new l({type:n.M_POLL_START.name,content:(o={},M(o,i.M_TEXT.name,e),M(o,n.M_POLL_START.name,{question:M({},i.M_TEXT.name,e),kind:r instanceof s.NamespacedValue?r.name:r,max_selections:a,answers:t.map((function(e){return M({id:u(Array(16)).map((function(){return k.charAt(Math.floor(Math.random()*k.length))})).join("")},i.M_TEXT.name,e)}))}),o)})}}]),l}(l.ExtensibleEvent);e.PollStartEvent=C;var k="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"})),M=s((e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.REFERENCE_RELATION=void 0;var t=new(y().NamespacedValue)("m.reference");e.REFERENCE_RELATION=t})),P=s((e=>{function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.PollResponseEvent=void 0;var n=f(),r=I(),i=p(),o=M(),s=b();function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){var n=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch{return!1}}();return function(){var r,i=c(e);if(n){var o=c(this).constructor;r=Reflect.construct(i,arguments,o)}else r=i.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return d(e)}(this,r)}}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(n,e);var t=u(n);function n(e){var r;(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,n),h(d(r=t.call(this,e)),"internalAnswerIds",void 0),h(d(r),"internalSpoiled",void 0),h(d(r),"pollEventId",void 0);var s=r.wireContent["m.relates_to"];if(!o.REFERENCE_RELATION.matches(null==s?void 0:s.rel_type)||"string"!=typeof(null==s?void 0:s.event_id))throw new i.InvalidEventError("Relationship must be a reference to an event");return r.pollEventId=s.event_id,r.validateAgainst(null),r}return function(e,t,n){a(e.prototype,t),a(e,n),Object.defineProperty(e,"prototype",{writable:!1})}(n,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(e){var t=r.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null==t?void 0:t.answers))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);var n=t.answers;if(n.some((function(e){return"string"!=typeof e}))||0===n.length)return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);if(e){if(n.some((function(t){return!e.answers.some((function(e){return e.id===t}))})))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);n=n.slice(0,e.maxSelections)}this.internalAnswerIds=n,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,r.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:r.M_POLL_RESPONSE.name,content:h({"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:this.pollEventId}},r.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(e,t){return new n({type:r.M_POLL_RESPONSE.name,content:h({"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:t}},r.M_POLL_RESPONSE.name,{answers:e})})}}]),n}(n.ExtensibleEvent);e.PollResponseEvent=m})),C=s((e=>{function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.PollEndEvent=void 0;var n=I(),r=p(),i=M(),o=_(),s=E(),a=b();function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){g(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){var n=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch{return!1}}();return function(){var r,i=v(e);if(n){var o=v(this).constructor;r=Reflect.construct(i,arguments,o)}else r=i.apply(this,arguments);return function(e,n){if(n&&("object"===t(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return m(e)}(this,r)}}function m(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(e){return(v=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}(l,e);var t=h(l);function l(e){var n;(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,l),g(m(n=t.call(this,e)),"pollEventId",void 0),g(m(n),"closingMessage",void 0);var s=n.wireContent["m.relates_to"];if(!i.REFERENCE_RELATION.matches(null==s?void 0:s.rel_type)||"string"!=typeof(null==s?void 0:s.event_id))throw new r.InvalidEventError("Relationship must be a reference to an event");return n.pollEventId=s.event_id,n.closingMessage=new o.MessageEvent(n.wireFormat),n}return function(e,t,n){d(e.prototype,t),d(e,n),Object.defineProperty(e,"prototype",{writable:!1})}(l,[{key:"isEquivalentTo",value:function(e){return(0,a.isEventTypeSame)(e,n.M_POLL_END)}},{key:"serialize",value:function(){return{type:n.M_POLL_END.name,content:u(g({"m.relates_to":{rel_type:i.REFERENCE_RELATION.name,event_id:this.pollEventId}},n.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(e,t){var r;return new l({type:n.M_POLL_END.name,content:(r={"m.relates_to":{rel_type:i.REFERENCE_RELATION.name,event_id:e}},g(r,n.M_POLL_END.name,{}),g(r,s.M_TEXT.name,t),r)})}}]),l}(f().ExtensibleEvent);e.PollEndEvent=y})),k=s((e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.parseMPoll=function(e){return t.M_POLL_START.matches(e.type)?new n.PollStartEvent(e):t.M_POLL_RESPONSE.matches(e.type)?new r.PollResponseEvent(e):t.M_POLL_END.matches(e.type)?new i.PollEndEvent(e):null};var t=I(),n=O(),r=P(),i=C()})),A=s((e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ExtensibleEvents=void 0;var t=v(),n=p(),r=S(),i=w(),o=E(),s=I(),a=k();function l(e,t){var n=typeof Symbol<"u"&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return u(e,t)}}(e))||t){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{!s&&null!=n.return&&n.return()}finally{if(a)throw o}}}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){function e(){(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,e),c(this,"interpreters",new t.NamespacedMap([[r.LEGACY_M_ROOM_MESSAGE,r.parseMRoomMessage],[o.M_MESSAGE,i.parseMMessage],[o.M_EMOTE,i.parseMMessage],[o.M_NOTICE,i.parseMMessage],[s.M_POLL_START,a.parseMPoll],[s.M_POLL_RESPONSE,a.parseMPoll],[s.M_POLL_END,a.parseMPoll]])),c(this,"_unknownInterpretOrder",[o.M_MESSAGE])}return function(e,t,n){d(e.prototype,t),d(e,n),Object.defineProperty(e,"prototype",{writable:!1})}(e,[{key:"unknownInterpretOrder",get:function(){var e;return null!==(e=this._unknownInterpretOrder)&&void 0!==e?e:[]},set:function(e){this._unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){this.interpreters.set(e,t)}},{key:"parse",value:function(e){try{if(this.interpreters.hasNamespaced(e.type))return this.interpreters.getNamespaced(e.type)(e);var t,r=l(this.unknownInterpretOrder);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(this.interpreters.has(i)){var o=this.interpreters.get(i)(e);if(o)return o}}}catch(e){r.e(e)}finally{r.f()}return null}catch(e){if(e instanceof n.InvalidEventError)return null;throw e}}}],[{key:"defaultInstance",get:function(){return e._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return e.defaultInstance.unknownInterpretOrder},set:function(t){e.defaultInstance.unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,n){e.defaultInstance.registerInterpreter(t,n)}},{key:"parse",value:function(t){return e.defaultInstance.parse(t)}}]),e}();e.ExtensibleEvents=h,c(h,"_defaultInstance",new h)})),L=s((e=>{Object.defineProperty(e,"__esModule",{value:!0})})),D=s((e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.LegacyMsgType=void 0,e.isEventLike=function(e,n){var i=e.content;return n===t.Text?r.M_MESSAGE.matches(e.type)||"m.room.message"===e.type&&"m.text"===(null==i?void 0:i.msgtype):n===t.Emote?r.M_EMOTE.matches(e.type)||"m.room.message"===e.type&&"m.emote"===(null==i?void 0:i.msgtype):n===t.Notice&&(r.M_NOTICE.matches(e.type)||"m.room.message"===e.type&&"m.notice"===(null==i?void 0:i.msgtype))};var t,n,r=E();e.LegacyMsgType=t,(n=t||(e.LegacyMsgType=t={})).Text="m.text",n.Notice="m.notice",n.Emote="m.emote"})),N=s((e=>{Object.defineProperty(e,"__esModule",{value:!0});var t=A();Object.keys(t).forEach((function(n){"default"===n||"__esModule"===n||n in e&&e[n]===t[n]||Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[n]}})}));var n=L();Object.keys(n).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===n[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return n[t]}})}));var r=p();Object.keys(r).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===r[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return r[t]}})}));var i=y();Object.keys(i).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===i[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return i[t]}})}));var o=v();Object.keys(o).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===o[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return o[t]}})}));var s=g();Object.keys(s).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===s[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return s[t]}})}));var a=D();Object.keys(a).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===a[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return a[t]}})}));var l=b();Object.keys(l).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===l[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return l[t]}})}));var u=S();Object.keys(u).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===u[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return u[t]}})}));var d=w();Object.keys(d).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===d[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return d[t]}})}));var c=k();Object.keys(c).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===c[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return c[t]}})}));var h=M();Object.keys(h).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===h[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return h[t]}})}));var m=f();Object.keys(m).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===m[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return m[t]}})}));var N=E();Object.keys(N).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===N[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return N[t]}})}));var x=_();Object.keys(x).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===x[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return x[t]}})}));var U=T();Object.keys(U).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===U[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return U[t]}})}));var j=R();Object.keys(j).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===j[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return j[t]}})}));var B=I();Object.keys(B).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===B[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return B[t]}})}));var F=O();Object.keys(F).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===F[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return F[t]}})}));var $=P();Object.keys($).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===$[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return $[t]}})}));var q=C();Object.keys(q).forEach((function(t){"default"===t||"__esModule"===t||t in e&&e[t]===q[t]||Object.defineProperty(e,t,{enumerable:!0,get:function(){return q[t]}})}))})),x={};a(x,{Category:()=>Tn,ClientEvent:()=>yr,ClientPrefix:()=>ut,ConditionKind:()=>Kn,ConditionOperator:()=>jn,ConnectionError:()=>Ze,ContentHelpers:()=>Qn,DEFAULT_FILTER:()=>bn,DEFAULT_FILTER_WITHOUT_NOT_AGGREGATED_RELATIONS:()=>_n,DMMemberCountCondition:()=>Bn,Device:()=>Ir,DeviceVerification:()=>wr,Direction:()=>Tt,DuplicateStrategy:()=>Gt,EVENT_VISIBILITY_CHANGE_TYPE:()=>Z,EventEmitterEvents:()=>Ue,EventRedeliveredKey:()=>G,EventStatus:()=>xt,EventTimeline:()=>wt,EventTimelineSet:()=>Vt,EventType:()=>V,FeatureSupport:()=>Lt,GET_LOGIN_TOKEN_CAPABILITY:()=>fr,GLOBAL_COUNTER_KEY:()=>wn,HTTPError:()=>Qe,HttpApiEvent:()=>et,INVITES_COUNTER_KEY:()=>In,IdentityPrefix:()=>dt,IndexedDBStore:()=>Br,JoinRule:()=>Ge,KNOWN_SAFE_ROOM_VERSION:()=>ln,LOCAL_NOTIFICATION_SETTINGS_PREFIX:()=>ne,LocalStorageErrors:()=>Hr,MAIN_ROOM_TIMELINE:()=>q,MAIN_TIMELINE_COUNTER_KEY:()=>Pn,M_HTML:()=>Wr,M_MESSAGE:()=>qr,M_TEXT:()=>Kr,MatrixClient:()=>Er,MatrixError:()=>Xe,MatrixEvent:()=>Bt,MatrixEventEvent:()=>jt,MatrixHttpApi:()=>Et,MatrixScheduler:()=>bt,MediaPrefix:()=>ct,MemoryStore:()=>Ye,Method:()=>yt,MsgType:()=>z,NotificationCountType:()=>dn,PEEK_KEY:()=>Sn,PUSHER_DEVICE_ID:()=>te,PUSHER_ENABLED:()=>ee,PendingEventOrdering:()=>vr,PowerLevelActions:()=>He,Preset:()=>We,PushRuleActionName:()=>xn,PushRuleKind:()=>Wn,REFERENCE_RELATION:()=>Gr,ReceiptType:()=>$,RelationType:()=>H,Relations:()=>Kt,RelationsEvent:()=>qt,RestrictedAllowType:()=>Ve,Room:()=>hn,RoomCreateTypeField:()=>J,RoomEvent:()=>cn,RoomMember:()=>Fe,RoomMemberEvent:()=>Be,RoomNameType:()=>vn,RoomState:()=>Je,RoomStateEvent:()=>ze,RoomSummary:()=>Ht,RoomType:()=>Y,RoomVersionStability:()=>pr,RuleId:()=>Gn,SERVICE_TYPES:()=>Pr,SPAM_INVITES_COUNTER_KEY:()=>On,SyncAccumulator:()=>Tr,SyncState:()=>kn,THREADS_COUNTER_KEY:()=>Mn,THREAD_RELATION_TYPE:()=>Nt,Thread:()=>Dt,ThreadEvent:()=>At,TimelineIndex:()=>Mr,TimelineWindow:()=>Or,ToDeviceMessageId:()=>Q,TweakName:()=>Un,TypedEventEmitter:()=>je,UNREAD_THREAD_NOTIFICATIONS:()=>Rn,UNSIGNED_THREAD_ID_FIELD:()=>re,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:()=>X,UNSTABLE_MSC3852_LAST_SEEN_UA:()=>mr,User:()=>Rt,UserEvent:()=>_t,Visibility:()=>Ke,W3_REPORTING_LABEL_KEY:()=>Cn,amendClientOpts:()=>zr,anySignal:()=>rt,createClient:()=>Jr,decodeBase64:()=>rr,encodeBase64:()=>er,encodeUnpaddedBase64:()=>tr,encodeUnpaddedBase64Url:()=>nr,getHttpUriForMxc:()=>Ce,getSerializedMessagesFilter:()=>yn,getSerializedSyncFilter:()=>gn,getSerializedTimelineFilter:()=>En,getSyncFilter:()=>fn,inMainTimelineForReceipt:()=>_r,isDmMemberCountCondition:()=>Fn,isEventTypeSame:()=>Vr,parseErrorResponse:()=>it,retryNetworkOperation:()=>st,threadIdForReceipt:()=>br,timeoutSignal:()=>nt});var U,j,B,F,$=((U=$||{}).Read="m.read",U.FullyRead="m.fully_read",U.ReadPrivate="m.read.private",U),q="main",K=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){let e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}},W=class extends K{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}},G="com.reddit.redelivered",V=((F=V||{}).RoomCanonicalAlias="m.room.canonical_alias",F.RoomCreate="m.room.create",F.RoomJoinRules="m.room.join_rules",F.RoomMember="m.room.member",F.RoomPowerLevels="m.room.power_levels",F.RoomName="m.room.name",F.RoomTopic="m.room.topic",F.RoomAvatar="m.room.avatar",F.RoomPinnedEvents="m.room.pinned_events",F.RoomHistoryVisibility="m.room.history_visibility",F.RoomGuestAccess="m.room.guest_access",F.RoomServerAcl="m.room.server_acl",F.RoomTombstone="m.room.tombstone",F.RoomPredecessor="org.matrix.msc3946.room_predecessor",F.SpaceChild="m.space.child",F.SpaceParent="m.space.parent",F.RoomRedaction="m.room.redaction",F.RoomMessage="m.room.message",F.Sticker="m.sticker",F.RoomMessageFeedback="m.room.message.feedback",F.Reaction="m.reaction",F.PollStart="org.matrix.msc3381.poll.start",F.Typing="m.typing",F.Receipt="m.receipt",F.Presence="m.presence",F.FullyRead="m.fully_read",F.Tag="m.tag",F.SpaceOrder="org.matrix.msc3230.space_order",F.PushRules="m.push_rules",F.Direct="m.direct",F.IgnoredUserList="m.ignored_user_list",F.RoomKey="m.room_key",F.RoomKeyRequest="m.room_key_request",F.ForwardedRoomKey="m.forwarded_room_key",F.Dummy="m.dummy",F),H=((B=H||{}).Annotation="m.annotation",B.Replace="m.replace",B.Reference="m.reference",B.Thread="m.thread",B),z=((j=z||{}).Text="m.text",j.Emote="m.emote",j.Notice="m.notice",j.Image="m.image",j.File="m.file",j.Audio="m.audio",j.Location="m.location",j.Video="m.video",j.KeyVerificationRequest="m.key.verification.request",j),J="type",Y=(e=>(e.Space="m.space",e.UnstableCall="org.matrix.msc3417.call",e.ElementVideo="io.element.video",e))(Y||{}),Q="org.matrix.msgid",X=new W("io.element.functional_members","io.element.functional_members"),Z=new W("m.visibility","org.matrix.msc3531.visibility"),ee=new W("enabled","org.matrix.msc3881.enabled"),te=new W("device_id","org.matrix.msc3881.device_id"),ne=new W("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),re=new W("thread_id","org.matrix.msc4023.thread_id"),ie=new Map;function oe(e){return e instanceof String&&(e=e.toString()),ie.has(e)||ie.set(e,e),ie.get(e)}function se(e,t){let n=null!=t?t:new URLSearchParams;for(let[t,r]of Object.entries(e))null!=r&&(Array.isArray(r)?r.forEach((e=>{n.append(t,String(e))})):n.append(t,String(r)));return n}function ae(e,t){for(let n in t){if(!t.hasOwnProperty(n))continue;let r=t[n];null!=r&&(e=e.replace(n,encodeURIComponent(r)))}return e}function le(e,t,n){let r;if(n){for(r=e.length-1;r>=0;r--)if(t(e[r],r,e))return e.splice(r,1),!0}else for(r=0;r<e.length;r++)if(t(e[r],r,e))return e.splice(r,1),!0;return!1}function ue(e){return JSON.parse(JSON.stringify(e))}function de(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("number"==typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object)||e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!de(e[n],t[n]))return!1}else{for(let n in t)if(t.hasOwnProperty(n)!==e.hasOwnProperty(n))return!1;for(let n in e)if(t.hasOwnProperty(n)!==e.hasOwnProperty(n)||!de(e[n],t[n]))return!1}return!0}function ce(e){if("object"!=typeof e||null==e||Array.isArray(e))return e;let t=[];for(let[n,r]of Object.entries(e))t.push([n,ce(r)]);return t.sort(((e,t)=>function(e,t){return e<t?-1:e>t?1:0}(e[0],t[0]))),t}function he(e){return"number"==typeof e&&isFinite(e)}function me(e){return"string"==typeof e?e.normalize("NFD").replace(pe,""):""}function ve(e){return"string"==typeof e?e.replace(/[\u202d-\u202e]/g,""):""}var pe=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function fe(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ge(e){return fe(e).replace(/\\\*/g,".*").replace(/\?/g,".")}function ye(e,t){return new Promise((n=>{setTimeout(n,e,t)}))}function Ee(){let e,t,n=new Promise(((n,r)=>{e=n,t=r}));return{resolve:e,reject:t,promise:n}}function be(e,t){let n=e.map((e=>Promise.resolve(e).then((e=>t(e)))));return Promise.all(n).then((()=>{}))}function _e(e){return Promise.resolve(e())}var Re=new Intl.Collator;function Te(e){return["m.read","m.read.private"].includes(e)}function Se(e){return e instanceof Map?we(e):Array.isArray(e)?e.map((e=>Se(e))):e}function we(e){let t=new Map;for(let[n,r]of e)t.set(n,Se(r));return Object.fromEntries(t.entries())}function Ie(e){return"__proto__"===e||"prototype"===e||"constructor"===e}function Oe(e){return!(Ie(e.room_id)||Ie(e.sender)||Ie(e.user_id)||Ie(e.event_id))}var Me=class extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}};function Pe(e,t){var n;return!(!t.has(e.sender)||"m.room.name"===e.type)&&("m.room.member"!==e.type||!t.has(null!=(n=e.state_key)?n:""))}function Ce(e,t,n,r,i,o=!1){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return o?t:"";let s=t.slice(6),a="/_matrix/media/v3/download/",l={};n&&(l.width=Math.round(n).toString()),r&&(l.height=Math.round(r).toString()),i&&(l.method=i),Object.keys(l).length>0&&(a="/_matrix/media/v3/thumbnail/");let u=s.indexOf("#"),d="";return u>=0&&(d=s.slice(u),s=s.slice(0,u)),e+a+s+(0===Object.keys(l).length?"":"?"+se(l))+d}var ke=l(c()),Ae="matrix";function Le(e){let t=e;t.getChild=t.withPrefix=function(e){return function(e){let t=ke.default.getLogger(`${Ae}-${e}`);return t.prefix!==e&&(Le(t),t.prefix=e,t.setLevel(ke.default.levels.DEBUG,!1)),t}((this.prefix||"")+e)}}ke.default.methodFactory=function(e,t,n){return function(...e){this.prefix&&e.unshift(this.prefix)}};var De=ke.default.getLogger(Ae);De.setLevel(ke.default.levels.DEBUG,!1),Le(De);var Ne,xe=l(h()),Ue=(e=>(e.NewListener="newListener",e.RemoveListener="removeListener",e.Error="error",e))(Ue||{}),je=class extends xe.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e,...t){return super.emit(e,...t)}async emitPromised(e,...t){let n=this.listeners(e);return Promise.allSettled(n.map((e=>e(...t)))).then((()=>n.length>0))}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return void 0===e?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}},Be=((Ne=Be||{}).Membership="RoomMember.membership",Ne.Name="RoomMember.name",Ne.PowerLevel="RoomMember.powerLevel",Ne.Typing="RoomMember.typing",Ne.Profile="RoomMember.profile",Ne),Fe=class extends je{constructor(e,t){super(),this.roomId=e,this.userId=t,this._isOutOfBand=!1,this.modified=-1,this.requestedProfileInfo=!1,this.typing=!1,this.powerLevel=0,this.powerLevelNorm=0,this.events={},this.memberEvents=new Map,this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}get profile(){return this._profile}set profile(e){this._profile=e}get flair(){var e,t,n;return null!=(n=Object.values(null!=(t=null==(e=this.profile)?void 0:e.flairs)?t:{}).at(0))?n:null}setMembershipEvent(e,t){var n,r,i,o;let s=null!=(n=e.getDirectionalContent().displayname)?n:"";if("m.room.member"!==e.getType())return;this._isOutOfBand=!1,this.events.member=e;let a=e.getId();a&&this.memberEvents.set(a,e);let l=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&De.trace(`membership event with membership undefined (forwardLooking: ${e.forwardLooking})!`,e.getContent(),"prevcontent is ",e.getPrevContent());let u=this.name;var d,c;this.name=(d=this.userId,(c=s)&&c!==d&&me(c)?ve(c):d),this.rawDisplayName=ve(null!=(r=e.getDirectionalContent().displayname)?r:""),(!this.rawDisplayName||!me(this.rawDisplayName))&&(this.rawDisplayName=this.userId),l!==this.membership&&(this.updateModifiedTime(),this.emit("RoomMember.membership",e,this,l)),u!==this.name&&(this.updateModifiedTime(),this.emit("RoomMember.name",e,this,u)),a&&"join"===this.membership&&(this.profile=null==(o=null==(i=e.getUnsigned())?void 0:i["m.relations"])?void 0:o["com.reddit.profile"],this.emit("RoomMember.profile",e,this))}getMembershipEvents(){return Array.from(this.memberEvents.values())}setPowerLevelEvent(e){if("m.room.power_levels"!==e.getType()||""!==e.getStateKey())return;let t=e.getDirectionalContent(),n=t.users_default||0,r=t.users||{};Object.values(r).forEach((e=>{n=Math.max(n,e)}));let i=this.powerLevel,o=this.powerLevelNorm;void 0!==r[this.userId]&&Number.isInteger(r[this.userId])?this.powerLevel=r[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,n>0&&(this.powerLevelNorm=100*this.powerLevel/n),(i!==this.powerLevel||o!==this.powerLevelNorm)&&(this.updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;let t=this.typing;this.typing=!1;let n=e.getContent().user_ids;Array.isArray(n)&&(-1!==n.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit("RoomMember.typing",e,this)))}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return"leave"===this.membership&&void 0!==this.events.member&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){let e=this.events.member,t=e.getContent(),n=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return n}}getAvatarUrl(e,t,n,r,i=!0,o){let s=this.getMxcAvatarUrl();return(s||i)&&Ce(e,s,t,n,r,o)||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:void 0}};var $e,qe,Ke=((qe=Ke||{}).Public="public",qe.Private="private",qe),We=(e=>(e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat",e))(We||{}),Ge=(e=>(e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted",e))(Ge||{}),Ve=(($e=Ve||{}).RoomMembership="m.room_membership",$e),He=(e=>(e.Ban="ban",e.Kick="kick",e.Redact="redact",e))(He||{}),ze=(e=>(e.Events="RoomState.events",e.Members="RoomState.members",e.NewMember="RoomState.newMember",e.Update="RoomState.update",e))(ze||{}),Je=class e extends je{constructor(e,t={status:0}){super(),this.roomId=e,this.oobMemberFlags=t,this.sentinels={},this.joinedMemberCount=null,this.summaryJoinedMemberCount=null,this.invitedMemberCount=null,this.summaryInvitedMemberCount=null,this.members={},this.events=new Map,this.paginationToken=null}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce(((e,t)=>"join"===t.membership?e+1:e),0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce(((e,t)=>"invite"===t.membership?e+1:e),0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter((t=>!e.includes(t.userId)))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new Fe(this.roomId,e);let n=this.members[e];null!=n&&n.events.member&&t.setMembershipEvent(n.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());return this.events.get(e).get(t)||null}clone(){let t=new e(this.roomId,this.oobMemberFlags),n=this.oobMemberFlags.status;return this.oobMemberFlags.status=0,Array.from(this.events.values()).forEach((e=>{t.setStateEvents(Array.from(e.values()))})),this.oobMemberFlags.status=n,null!==this.summaryInvitedMemberCount&&t.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&t.setJoinedMemberCount(this.getJoinedMemberCount()),2==this.oobMemberFlags.status&&this.getMembers().forEach((e=>{var n;e.isOutOfBand()&&(null==(n=t.getMember(e.userId))||n.markOutOfBand())})),t}setUnknownStateEvents(e){let t=e.filter((e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey())));this.setStateEvents(t)}setStateEvents(e){e.forEach((e=>{if(e.getRoomId()!==this.roomId||!e.isState())return;let t=this.getStateEventMatching(e);this.setStateEvent(e),this.emit("RoomState.events",e,this,t)})),e.forEach((e=>{if(e.getRoomId()===this.roomId&&e.isState())if("m.room.member"===e.getType()){let t=e.getStateKey(),n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),this.updateMember(n),this.emit("RoomState.members",e,this,n)}else if("m.room.power_levels"===e.getType()){if(""!==e.getStateKey())return;Object.values(this.members).forEach((t=>{let n=t.getLastModifiedTime();t.setPowerLevelEvent(e),n!==t.getLastModifiedTime()&&this.emit("RoomState.members",e,this,t)})),this.sentinels={}}})),this.emit("RoomState.update",this)}getOrCreateMember(e,t){let n=this.members[e];return n||(n=new Fe(this.roomId,e),this.members[e]=n,this.emit("RoomState.newMember",t,this,n)),n}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}getStateEventMatching(e){var t,n;return null!=(n=null==(t=this.events.get(e.getType()))?void 0:t.get(e.getStateKey()))?n:null}updateMember(e){let t=this.getStateEvents("m.room.power_levels","");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}outOfBandMembersReady(){return 2===this.oobMemberFlags.status}markOutOfBandMembersStarted(){0===this.oobMemberFlags.status&&(this.oobMemberFlags.status=1)}markOutOfBandMembersFailed(){1===this.oobMemberFlags.status&&(this.oobMemberFlags.status=0)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach((t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])})),De.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=0}setOutOfBandMembers(e){De.log(`LL: RoomState about to set ${e.length} OOB members ...`),1===this.oobMemberFlags.status&&(De.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=2,e.forEach((e=>this.setOutOfBandMember(e))),this.emit("RoomState.update",this))}setOutOfBandMember(e){if("m.room.member"!==e.getType())return;let t=e.getStateKey(),n=this.getMember(t);if(n&&!n.isOutOfBand())return;let r=this.getOrCreateMember(t,e);r.setMembershipEvent(e,this),r.markOutOfBand(),this.setStateEvent(e),this.updateMember(r),this.emit("RoomState.members",e,this,r)}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}maySendRedactionForEvent(e,t){let n=this.getMember(t);if(!n||"leave"===n.membership||e.status||e.isRedacted())return!1;let r=this.maySendEvent("m.room.redaction",t);return e.getSender()===t?r:this.hasSufficientPowerLevelFor("redact",n.powerLevel)}hasSufficientPowerLevelFor(e,t){let n=this.getStateEvents("m.room.power_levels",""),r={};n&&(r=n.getContent());let i=50;return he(r[e])&&(i=r[e]),t>=i}maySendMessage(e){return this.maySendEventOfType("m.room.message",e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!!t.credentials.userId&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,n){let r,i=this.getStateEvents("m.room.power_levels",""),o={},s=0,a=0,l=0;if(i){r=i.getContent(),o=r.events||{},s=Number.isSafeInteger(r.state_default)?r.state_default:50;let e=r.users&&r.users[t];Number.isSafeInteger(e)?l=e:Number.isSafeInteger(r.users_default)&&(l=r.users_default),Number.isSafeInteger(r.events_default)&&(a=r.events_default)}let u=n?s:a;return Number.isSafeInteger(o[e])&&(u=o[e]),l>=u}mayTriggerNotifOfType(e,t){let n=this.getMember(t);if(!n)return!1;let r=this.getStateEvents("m.room.power_levels",""),i=50;return r&&r.getContent()&&r.getContent().notifications&&he(r.getContent().notifications[e])&&(i=r.getContent().notifications[e]),n.powerLevel>=i}getJoinRule(){var e;let t=this.getStateEvents("m.room.join_rules","");return(null!=(e=null==t?void 0:t.getContent())?e:{}).join_rule||"invite"}findPredecessor(e=!1){if(e){let e=this.getStateEvents("org.matrix.msc3946.room_predecessor","");if(e){let t=e.getContent(),n=t.predecessor_room_id,r=t.last_known_event_id;"string"!=typeof r&&(r=void 0);let i=t.via_servers;if(Array.isArray(i)||(i=void 0),"string"==typeof n)return{roomId:n,eventId:r,viaServers:i}}}let t=this.getStateEvents("m.room.create","");if(t){let e=t.getContent().predecessor;if(e){let t=e.room_id;if("string"==typeof t){let n=e.event_id;return("string"!=typeof n||""===n)&&(n=void 0),{roomId:t,eventId:n}}}}return null}},Ye=class{constructor(e={}){this.rooms={},this.peeks={},this.users={},this.syncToken=null,this.accountData=new Map,this.oobMembers=new Map,this.pendingEvents={},this.pendingToDeviceBatches=[],this.nextToDeviceBatchId=0,this.currentUser=void 0,this.onRoomMember=(e,t,n)=>{var r;if("invite"===n.membership)return;let i=this.users[n.userId]||(null==(r=this.createUser)?void 0:r.call(this,n.userId));n.name&&(i.setDisplayName(n.name),n.events.member&&i.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&i.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[i.userId]=i},this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this.onRoomMember),e.currentState.getMembers().forEach((t=>{this.onRoomMember(null,e.currentState,t)}))}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener("RoomState.members",this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map((function(e){return e.summary}))}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}getRoomPeek(e){return this.peeks[e]||null}storePeek(e,t){t?this.peeks[e]=t:delete this.peeks[e]}scrollback(e,t){return[]}async storeRoomEvents(e,t){}storeAccountDataEvents(e){e.forEach((e=>{Object.keys(e.getContent()).length?this.accountData.set(e.getType(),e):this.accountData.delete(e.getType())}))}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.accountData=new Map,Promise.resolve()}resetAllData(){return this.rooms={},this.users={},this.syncToken=null,this.accountData=new Map,Promise.resolve()}deleteUserData(e){var t,n;for(let r of e){let e=null==(n=null==(t=this.accountData.get("m.direct"))?void 0:t.event)?void 0:n.content;e&&delete e[r],delete this.users[r]}return Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getCurrentUser(){return Promise.resolve(this.currentUser)}storeCurrentUser(e){return this.currentUser=e,Promise.resolve()}async getPendingEvents(e){var t;return null!=(t=this.pendingEvents[e])?t:[]}async setPendingEvents(e,t){this.pendingEvents[e]=t}saveToDeviceBatches(e){for(let t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}async getOldestToDeviceBatch(){return 0===this.pendingToDeviceBatches.length?null:this.pendingToDeviceBatches[0]}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter((t=>t.id!==e)),Promise.resolve()}async destroy(){}},Qe=class extends Error{constructor(e,t){super(e),this.httpStatus=t}},Xe=class extends Qe{constructor(e={},t,n,r){let i=e.error||"Unknown message";t&&(i=`[${t}] ${i}`),n&&(i=`${i} (${n})`),super(`MatrixError: ${i}`,t),this.httpStatus=t,this.url=n,this.event=r,this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}},Ze=class extends Error{constructor(e,t,n){super(e+(t?`: ${t.message}`:"")),this.url=n}get name(){return"ConnectionError"}},et=(e=>(e.SessionLoggedOut="Session.logged_out",e.NoConsent="no_consent",e))(et||{}),tt=l(m());function nt(e){let t=new AbortController;return setTimeout((()=>{t.abort()}),e),t.signal}function rt(e){let t=new AbortController;function n(){for(let t of e)t.removeEventListener("abort",r)}function r(){t.abort(),n()}for(let t of e){if(t.aborted){r();break}t.addEventListener("abort",r)}return{signal:t.signal,cleanup:n}}function it(e,t){let n;try{n=function(e){let t;if(t=ot(e)?e.getResponseHeader("Content-Type"):e.headers.get("Content-Type"),!t)return null;try{return(0,tt.parse)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e)}catch(e){return e}return"application/json"===(null==n?void 0:n.type)&&t?new Xe(JSON.parse(t),e.status,ot(e)?e.responseURL:e.url):"text/plain"===(null==n?void 0:n.type)?new Qe(`Server returned ${e.status} error: ${t}`,e.status):new Qe(`Server returned ${e.status} error`,e.status)}function ot(e){return"getResponseHeader"in e}async function st(e,t){let n=0,r=null;for(;n<e;)try{if(n>0){let e=1e3*Math.pow(2,n);De.log(`network operation failed ${n} times, retrying in ${e}ms...`),await ye(e)}return await t()}catch(e){if(!(e instanceof Ze))throw e;n+=1,r=e}throw r}var at,lt=class{constructor(e,t){this.eventEmitter=e,this.opts=t,this.abortController=new AbortController,function(e,t){for(let n of t)if(!e.hasOwnProperty(n))throw new Error("Missing required key: "+n)}(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):window.fetch(e,t)}async authedRequest(e,t,n,r,i={}){n||(n={});let o={...i};this.opts.accessToken&&(o.headers||(o.headers={}),o.headers.Authorization||(o.headers.Authorization="Bearer "+this.opts.accessToken),n.access_token&&delete n.access_token);try{return await this.request(e,t,n,r,o)}catch(s){let a=s;if(("M_UNKNOWN_TOKEN"===a.errcode||"M_MISSING_TOKEN"===a.errcode)&&!o.doNotAttemptTokenRefresh&&await this.tryRefreshToken())return this.authedRequest(e,t,n,r,{...i,doNotAttemptTokenRefresh:!0});throw"M_UNKNOWN_TOKEN"!=a.errcode||null!=o&&o.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==a.errcode&&this.eventEmitter.emit("no_consent",a.message,a.data.consent_uri):this.eventEmitter.emit("Session.logged_out",a),a}}async tryRefreshToken(){var e;if(!this.opts.refreshToken||!this.opts.tokenRefreshFunction)return!1;try{let{accessToken:e,refreshToken:t}=await this.opts.tokenRefreshFunction(this.opts.refreshToken);return this.opts.accessToken=e,this.opts.refreshToken=t,!0}catch(t){return null==(e=this.opts.logger)||e.warn("Failed to refresh token",t),!1}}request(e,t,n,r,i){let o=this.getUrl(t,n,null==i?void 0:i.prefix,null==i?void 0:i.baseUrl);return this.requestOtherUrl(e,o,r,i)}async requestOtherUrl(e,t,n,r={}){var i,o,s,a,l,u,d;let c=this.sanitizeUrlForLogs(t);null==(i=this.opts.logger)||i.debug(`FetchHttpApi: --\x3e ${e} ${c}`);let h=Object.assign({},r.headers||{}),m=null==(o=r.json)||o,v=m&&(null==(s=null==n?void 0:n.constructor)?void 0:s.name)===Object.name;m&&(v&&!h["Content-Type"]&&(h["Content-Type"]="application/json"),h.Accept||(h.Accept="application/json"));let p,f=null!=(a=r.localTimeoutMs)?a:this.opts.localTimeoutMs,g=null!=(l=r.keepAlive)&&l,y=[this.abortController.signal];void 0!==f&&y.push(nt(f)),r.abortSignal&&y.push(r.abortSignal),p=v?JSON.stringify(n):n;let E,{signal:b,cleanup:_}=rt(y),R=Date.now();try{E=await this.fetch(t,{signal:b,method:e,body:p,headers:h,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"default",credentials:"omit",keepalive:g,priority:r.priority}),null==(u=this.opts.logger)||u.debug(`FetchHttpApi: <-- ${e} ${c} [${Date.now()-R}ms ${E.status}]`)}catch(t){throw null==(d=this.opts.logger)||d.debug(`FetchHttpApi: <-- ${e} ${c} [${Date.now()-R}ms ${t}]`),"AbortError"===t.name?t:new Ze(`fetch failed. Error name: ${t.name}. Method: ${e}.`,t,c)}finally{_()}if(!E.ok)throw it(E,await E.text());return(void 0!==r.onlyData?r.onlyData:this.opts.onlyData)?m?E.json():E.text():E}sanitizeUrlForLogs(e){try{let t;t="string"==typeof e?new URL(e):e;let n=new URLSearchParams;for(let e of t.searchParams.keys())n.append(e,"xxx");let r=n.toString(),i=r?`?${r}`:"";return t.origin+t.pathname+i}catch{return"??"}}getUrl(e,t,n,r){let i=null!=r?r:this.opts.baseUrl,o=i.endsWith("/")?i.slice(0,-1):i,s=new URL(o+(null!=n?n:this.opts.prefix)+e);return t&&se(t,s.searchParams),s}},ut=(e=>(e.V1="/_matrix/client/v1",e.V3="/_matrix/client/v3",e.Unstable="/_matrix/client/unstable",e))(ut||{}),dt=(e=>(e.V2="/_matrix/identity/v2",e))(dt||{}),ct=(e=>(e.V1="/_matrix/media/v3",e.V3="/_matrix/media/v3",e))(ct||{}),ht=0,mt=[];function vt(e,t,...n){(t=t||0)<0&&(t=0);let r=Date.now()+t,i=ht++,o={runAt:r,func:e,params:n,key:i},s=function(e,t){let n=0,r=e.length;for(;n<r;){let i=n+r>>1;t(e[i])>0?r=i:n=i+1}return n}(mt,(function(e){return e.runAt-r}));return mt.splice(s,0,o),ft(),i}function pt(e){if(0===mt.length)return;let t;for(t=0;t<mt.length;t++)if(mt[t].key==e){mt.splice(t,1);break}0===t&&ft()}function ft(){at&&window.clearTimeout(at);let e=mt[0];if(!e)return;let t=Date.now(),n=Math.min(e.runAt-t,1e3);at=window.setTimeout(gt,n)}function gt(){let e=Date.now(),t=[];for(;;){let n=mt[0];if(!n||n.runAt>e)break;let r=mt.shift();r.key,t.push(r)}ft();for(let e of t)try{e.func.apply(window,e.params)}catch(e){De.error("Uncaught exception in callback function",e)}}var yt=(e=>(e.Get="GET",e.Put="PUT",e.Post="POST",e.Delete="DELETE",e))(yt||{}),Et=class extends lt{constructor(){super(...arguments),this.uploads=[]}uploadContent(e,t={}){var n,r,i,o;let s=null==(n=t.includeFilename)||n,a=null!=(r=t.abortController)?r:new AbortController,l=(null!=(i=t.type)?i:e.type)||"application/octet-stream",u=null!=(o=t.name)?o:e.name,d={loaded:0,total:0,abortController:a},c=Ee();if(window.XMLHttpRequest){let n=new window.XMLHttpRequest,r=function(){n.abort(),c.reject(new Error("Timeout"))},i=vt(r,3e4);n.onreadystatechange=function(){if(n.readyState===window.XMLHttpRequest.DONE){pt(i);try{if(0===n.status)throw new DOMException(n.statusText,"AbortError");if(!n.responseText)throw new Error("No response body.");n.status>=400?c.reject(it(n,n.responseText)):c.resolve(JSON.parse(n.responseText))}catch(e){if("AbortError"===e.name)return void c.reject(e);c.reject(new Ze("request failed",e))}}},n.upload.onprogress=e=>{var n;pt(i),d.loaded=e.loaded,d.total=e.total,i=vt(r,3e4),null==(n=t.progressHandler)||n.call(t,{loaded:e.loaded,total:e.total})};let o=this.getUrl("/upload",void 0,"/_matrix/media/v3");s&&u&&o.searchParams.set("filename",encodeURIComponent(u)),n.open("POST",o.href),this.opts.accessToken&&n.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),n.setRequestHeader("Content-Type",l),n.send(e),a.signal.addEventListener("abort",(()=>{n.abort()}))}else{let t={};s&&u&&(t.filename=u);let n={"Content-Type":l};this.authedRequest("POST","/upload",t,e,{prefix:"/_matrix/media/v3",headers:n,abortSignal:a.signal}).then((e=>this.opts.onlyData?e:e.json())).then(c.resolve,c.reject)}return d.promise=c.promise.finally((()=>{le(this.uploads,(e=>e===d))})),a.signal.addEventListener("abort",(()=>{le(this.uploads,(e=>e===d)),c.reject(new DOMException("Aborted","AbortError"))})),this.uploads.push(d),d.promise}cancelUpload(e){let t=this.uploads.find((t=>t.promise===e));return!!t&&(t.abortController.abort(),!0)}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:"/_matrix/media/v3/upload",params:{access_token:this.opts.accessToken}}}},bt=class e{constructor(t=e.RETRY_BACKOFF_RATELIMIT,n=e.QUEUE_MESSAGES){this.retryAlgorithm=t,this.queueAlgorithm=n,this.queues={},this.activeQueues=[],this.procFn=null,this.processQueue=e=>{let t=this.peekNextEvent(e);t?(this.queues[e].length,Promise.resolve().then((()=>this.procFn(t.event))).then((n=>{t.attempts>0&&t.event.setRetried(!0),this.removeNextEvent(e),t.event.getId(),t.defer.resolve(n),this.processQueue(e)}),(n=>{t.attempts+=1;let r=this.retryAlgorithm(t.event,t.attempts,n);t.attempts,t.event.getId(),-1===r?(De.info("Queue '%s' giving up on event %s",e,t.event.getId()),this.clearQueue(e,n)):setTimeout(this.processQueue,r,e)}))):this.disableQueue(e)}}static RETRY_BACKOFF_RATELIMIT(e,t,n){if(400===n.httpStatus||403===n.httpStatus||401===n.httpStatus||n instanceof Ze||"M_TOO_LARGE"===n.name)return-1;if("M_LIMIT_EXCEEDED"===n.name){let e=n.data.retry_after_ms;if(e>0)return e}return t>4?-1:1e3*Math.pow(2,t)}static QUEUE_MESSAGES(e){return"m.room.message"===e.getType()||e.hasAssociation()?"message":null}getQueueForEvent(e){let t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map((function(e){return e.event})):null}removeEventFromQueue(e){let t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let n=!1;return le(this.queues[t],(t=>t.event.getId()===e.getId()&&(n=!0,!0))),n}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){let t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);let n=Ee();return this.queues[t].push({event:e,defer:n,attempts:0}),e.getId(),this.startProcessingQueues(),n.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter((e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0)).forEach((e=>{this.activeQueues.push(e),this.processQueue(e)}))}disableQueue(e){let t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),De.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){let n;for(De.info("clearing queue '%s'",e);n=this.removeNextEvent(e);)n.defer.reject(t);this.disableQueue(e)}peekNextEvent(e){let t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){let t=this.queues[e];if(Array.isArray(t))return t.shift()}};var _t=(e=>(e.DisplayName="User.displayName",e.AvatarUrl="User.avatarUrl",e.Presence="User.presence",e.CurrentlyActive="User.currentlyActive",e.LastPresenceTs="User.lastPresenceTs",e))(_t||{}),Rt=class e extends je{constructor(e){super(),this.userId=e,this.modified=-1,this.presence="offline",this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={},this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(t,n){let r=new e(t);return n.reEmitter.reEmit(r,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),r}setPresenceEvent(e){if("m.presence"!==e.getType())return;let t=null===this.events.presence;this.events.presence=e;let n=[];(e.getContent().presence!==this.presence||t)&&n.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&n.push("User.currentlyActive"),this.presence=e.getContent().presence,n.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(let t of n)this.emit(t,e,this)}setDisplayName(e){let t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){let t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}},Tt=(e=>(e.Backward="b",e.Forward="f",e))(Tt||{}),St=class e{constructor(e){var t,n;this.eventTimelineSet=e,this.events=[],this.baseIndex=0,this.startToken=null,this.endToken=null,this.prevTimeline=null,this.nextTimeline=null,this.paginationRequests={b:null,f:null},this.roomId=null!=(n=null==(t=e.room)?void 0:t.roomId)?n:null,this.roomId&&(this.startState=new Je(this.roomId),this.endState=new Je(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}static setEventMetadata(e,t,n){var r,i,o,s;null!=(i=null==(r=e.sender)?void 0:r.events)&&i.member||(e.sender=t.getSentinelMember(e.getSender())),!(null!=(s=null==(o=e.target)?void 0:o.events)&&s.member)&&"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&n&&(e.forwardLooking=!1)}initialiseState(e){var t,n;if(this.events.length>0)throw new Error("Cannot initialise state after events are added");null==(t=this.startState)||t.setStateEvents(e),null==(n=this.endState)||n.setStateEvents(e)}forkLive(t){let n=this.getState(t),r=new e(this.eventTimelineSet);return r.startState=null==n?void 0:n.clone(),r.endState=n,this.endState=null==n?void 0:n.clone(),r}fork(t){let n=this.getState(t),r=new e(this.eventTimelineSet);return r.startState=null==n?void 0:n.clone(),r.endState=null==n?void 0:n.clone(),r}getRoomId(){return this.roomId}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(t){if(t==e.BACKWARDS)return this.startState;if(t==e.FORWARDS)return this.endState;throw new Error("Invalid direction '"+t+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:"b"===e?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:"b"===t?this.startToken=e:this.endToken=e}getNeighbouringTimeline(t){if(t==e.BACKWARDS)return this.prevTimeline;if(t==e.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+t+"'")}setNeighbouringTimeline(t,n){if(this.getNeighbouringTimeline(n))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+n+")");if(n==e.BACKWARDS)this.prevTimeline=t;else{if(n!=e.FORWARDS)throw new Error("Invalid direction '"+n+"'");this.nextTimeline=t}this.setPaginationToken(null,n)}addEvent(t,n){let r=n.toStartOfTimeline,i=n.roomState;i||(i=r?this.startState:this.endState);let o,s=this.getTimelineSet();s.room&&(e.setEventMetadata(t,i,r),t.isState()&&s.room.getUnfilteredTimelineSet()===s&&(null==i||i.setStateEvents([t]),(!t.sender||"m.room.member"===t.getType()&&!r)&&e.setEventMetadata(t,i,r))),o=r?0:this.events.length,this.events.splice(o,0,t),r&&this.baseIndex++}insertEvent(t,n,r){let i=this.getTimelineSet();i.room&&(e.setEventMetadata(t,r,!1),t.isState()&&i.room.getUnfilteredTimelineSet()===i&&(r.setStateEvents([t]),(!t.sender||"m.room.member"===t.getType())&&e.setEventMetadata(t,r,!1))),this.events.splice(n,0,t)}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){let n=this.events[t];if(n.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,n}return null}removeAllEvents(){this.events=[]}toString(){return this.name}};St.BACKWARDS="b",St.FORWARDS="f";var wt=St,It=class{constructor(e){this.target=e,this.reEmitters=new WeakMap}reEmit(e,t){let n=this.reEmitters.get(e);n||(n=new Map,this.reEmitters.set(e,n));for(let r of t){if(n.has(r))continue;let t=(...t)=>{"error"===r&&0===this.target.listenerCount("error")||this.target.emit(r,...t,e)};e.on(r,t),n.set(r,t)}}stopReEmitting(e,t){let n=this.reEmitters.get(e);if(n){for(let r of t)e.off(r,n.get(r)),n.delete(r);0===n.size&&this.reEmitters.delete(e)}}},Ot=class extends It{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}};function Mt(e,t,n,r=!1){return new Bt({content:{[t.getId()]:{[n]:{[e]:{ts:t.getTs(),...!r&&{thread_id:br(t)}}}}},type:"m.receipt",room_id:t.getRoomId()})}var Pt,Ct,kt=class extends je{constructor(){super(...arguments),this.receipts=new Me((()=>new Map)),this.receiptCacheByEventId=new Map}getReadReceiptForUserId(e,t=!1,n="m.read"){var r,i;let[o,s]=null!=(i=null==(r=this.receipts.get(n))?void 0:r.get(e))?i:[null,null];return t?o:null!=s?s:o}compareReceipts(e,t){var n;return null!=(n=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))?n:e.data.ts-t.data.ts}getEventReadUpTo(e,t=!1){let n=this.getLatestReceipt(e,t);return n&&this.receiptPointsAtConsistentEvent(n)?n.eventId:null}receiptPointsAtConsistentEvent(e){var t;let n=this.findEventById(e.eventId);if(!n)return!1;if(null==(t=e.data)||!t.thread_id)return!0;if(e.data.thread_id===q){if(_r(n))return!0}else if(n.threadRootId===e.data.thread_id)return!0;return De.warn(`Ignoring receipt because its thread_id (${e.data.thread_id}) disagrees with the thread root (${n.threadRootId}) of the referenced event (event ID = ${e.eventId})`),!1}getLatestReceipt(e,t){var n,r;let i,o=this.getReadReceiptForUserId(e,t,"m.read"),s=this.getReadReceiptForUserId(e,t,"m.read.private");return null!=o&&o.eventId&&null!=s&&s.eventId&&(i=this.compareReceipts(o,s)),i?null!=(r=i<0?s:o)?r:null:null!=(n=null!=s?s:o)?n:null}addReceiptToStructure(e,t,n,r,i){var o,s,a;let l=this.receipts.getOrCreate(t),u=l.get(n);u||(u=[null,null],l.set(n,u));let d=u[0];i&&(d=null!=(o=u[1])?o:u[0]);let c={eventId:e,data:r};if(d&&this.compareReceipts(d,c)>=0)return;let h=i?u[0]:c,m=i?c:u[1],v=null;h&&m&&(v=this.getUnfilteredTimelineSet().compareEventOrdering(h.eventId,m.eventId));let p=null===v||v<0,f=null!=(s=u[1])?s:u[0];if(i&&p?u[1]=c:i||(u[0]=c,p||(u[1]=null)),f!==(null!=(a=u[1])?a:u[0])){if(f&&this.receiptCacheByEventId.get(f.eventId)){let e=f.eventId;this.receiptCacheByEventId.set(e,this.receiptCacheByEventId.get(e).filter((e=>e.type!==t||e.userId!==n))),this.receiptCacheByEventId.get(e).length<1&&this.receiptCacheByEventId.delete(e)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:n,type:t,data:r})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){let t=this.getReadReceiptForUserId(e,!1),n=this.timeline[this.timeline.length-1];n&&(null==t?void 0:t.eventId)===n.getId()&&e===n.getSender()&&(this.setUnread("total",0),this.setUnread("highlight",0))}addLocalEchoReceipt(e,t,n,r=!1){this.addReceipt(Mt(e,t,n,r),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return Te(e.type)})).map((function(e){return e.userId}))}},At=(e=>(e.New="Thread.new",e.Update="Thread.update",e.NewReply="Thread.newReply",e.ViewThread="Thread.viewThread",e.Delete="Thread.delete",e))(At||{}),Lt=(e=>(e[e.None=0]="None",e[e.Experimental=1]="Experimental",e[e.Stable=2]="Stable",e))(Lt||{}),Dt=class extends kt{constructor(e,t,n){var r;if(super(),this.id=e,this.rootEvent=t,this.timeline=[],this._currentUserParticipated=!1,this.replyCount=0,this.pendingReplyCount=0,this.localEvents=[],this.initialEventsFetched=!1,this.replayEvents=[],this.onTimelineReset=async()=>{await this.processRootEventPromise,this.processRootEventPromise=void 0},this.onBeforeRedaction=(e,t)=>{null!=e&&e.isRelation(Nt.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit("Thread.update",this))},this.onRedaction=async(e,t,n)=>{var r;if(n===this.id)if(this.replyCount<=0){for(let e of this.timeline)this.clearEventMetadata(e);this.lastEvent=this.rootEvent,this._currentUserParticipated=!1,this.emit("Thread.delete",this)}else(null==(r=this.lastEvent)?void 0:r.getId())===e.getAssociatedId()&&(await this.processRootEventPromise,this.processRootEventPromise=void 0),await this.updateThreadMetadata()},this.onTimelineEvent=(e,t,n)=>{if(!n){let n=e.getSender();if(n&&t&&this.shouldSendLocalEchoReceipt(n,e)&&t.addLocalEchoReceipt(n,e,"m.read"),e.getId()!==this.id&&e.isRelation(Nt.name)){let e=this.getRootEventBundledRelationship();e?this.replyCount=e.count:this.replyCount++}}this.onEcho(e,null!=n&&n)},this.onLocalEcho=e=>{this.onEcho(e,!1)},this.onEcho=async(e,t)=>{e.threadRootId===this.id&&this.lastEvent!==e&&(await this.updateThreadMetadata(),e.isRelation(Nt.name)&&(t||(this.lastEvent=void 0,this.updateLocalEvent(e),this.emit("Thread.newReply",this,e))))},this.setMaxListeners(1e3),null==n||!n.room)throw new Error("element-web#22141: A thread requires a room in order to function");this.room=n.room,this.client=n.client,this.pendingEventOrdering=null!=(r=n.pendingEventOrdering)?r:"chronological",this.timelineSet=new Vt(this.room,{pendingEvents:!0},this),this.reEmitter=new Ot(this),this.reEmitter.reEmit(this.timelineSet,["Room.timeline","Room.timelineReset"]),this.room.on("Event.beforeRedaction",this.onBeforeRedaction),this.room.on("Room.redaction",this.onRedaction),this.room.on("Room.localEchoUpdated",this.onLocalEcho),this.room.on("Room.timelineReset",this.onTimelineReset),this.timelineSet.on("Room.timeline",this.onTimelineEvent),this.processReceipts(n.receipts),this.updateThreadMetadata(!!this.client.reduceEventFetchingStrategy),this.setEventMetadata(this.rootEvent)}async fetchRootEvent(){this.rootEvent=this.room.findEventById(this.id);try{let e=await this.client.fetchRoomEvent(this.roomId,this.id),t=this.client.getEventMapper();this.rootEvent=t(e)}catch(e){De.error("Failed to fetch thread root to construct thread with",e)}await this.processEvent(this.rootEvent)}shouldSendLocalEchoReceipt(e,t){var n;let r=null==(n=this.getReadReceiptForUserId(e))?void 0:n.eventId;if(r){let e=this.findEventById(r);if(e&&e.getTs()>t.getTs())return!1}return!0}get roomState(){return this.room.getLiveTimeline().getState(wt.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||(this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState}),this.timeline=this.events)}insertEventIntoTimeline(e){let t=e.getId();t&&(this.findEventById(t)||(this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState),this.timeline=this.events))}addEvents(e,t){e.forEach((e=>this.addEvent(e,t,!1))),this.updateThreadMetadata()}async addEvent(e,t,n=!0){var r,i,o;this.setEventMetadata(e);let s=this.lastReply(),a=!s||e.localTimestamp>=s.localTimestamp,l=e.getId(),u=!!l&&!!this.timelineSet.findEventById(l);if(t||!this.initialEventsFetched||!a&&u){if(e.isRelation("m.annotation")||e.isRelation("m.replace"))return this.initialEventsFetched?this.insertEventIntoTimeline(e):null==(r=this.replayEvents)||r.push(e),null==(i=this.timelineSet.relations)||i.aggregateParentEvent(e),void(null==(o=this.timelineSet.relations)||o.aggregateChildEvent(e,this.timelineSet));this.initialEventsFetched&&(t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e))}else this.addEventToTimeline(e,!1);e.getId()!==this.id&&e.isRelation(Nt.name)&&!t&&a&&(this.lastEvent=void 0),n&&(this.emit("Thread.newReply",this,e),this.updateThreadMetadata())}async processEvent(e){e&&this.setEventMetadata(e),this.timeline=this.events}processReceipts(e=[]){for(let{eventId:t,receiptType:n,userId:r,receipt:i,synthetic:o}of e)this.addReceiptToStructure(t,n,r,i,o)}getRootEventBundledRelationship(e=this.rootEvent){return null==e?void 0:e.getServerAggregatedRelation(Nt.name)}async processRootEvent(){let e=this.getRootEventBundledRelationship();if(e){this.replyCount=e.count,this._currentUserParticipated=!!e.current_user_participated;let t=this.client.getEventMapper();this.lastEvent=t({...e.latest_event,room_id:this.roomId}),this.updatePendingReplyCount(),await this.processEvent(this.lastEvent)}}updatePendingReplyCount(){let e=("detached"===this.pendingEventOrdering?this.room.getPendingEvents():this.events).filter((e=>{var t;return e.threadRootId===this.id&&e.isRelation(Nt.name)&&null!==e.status&&e.getId()!==(null==(t=this.lastEvent)?void 0:t.getId())}));this.lastPendingEvent=e.length?e[e.length-1]:void 0,this.pendingReplyCount=e.length}async resetLiveTimeline(e,t){let n=this.liveTimeline;this.timelineSet.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);let r,i,o=this.liveTimeline;e&&(r=(await this.client.createMessagesRequest(this.roomId,e,1,"f")).end),t&&(i=(await this.client.createMessagesRequest(this.roomId,t,1,"b")).start),t&&n.getPaginationToken("f")===t&&n.setPaginationToken(null!=i?i:null,"f"),e&&o.getPaginationToken("b")===e&&o.setPaginationToken(null!=r?r:null,"b")}async updateThreadFromRootEvent(){!this.initialEventsFetched&&!this.lastEvent&&await this.processRootEvent(),this.client.reduceEventFetchingStrategy||await this.fetchRootEvent(),await this.processRootEvent()}async updateThreadMetadata(e=!1){if(this.updatePendingReplyCount(),this.processRootEventPromise||(this.processRootEventPromise=this.updateThreadFromRootEvent()),await this.processRootEventPromise,!this.initialEventsFetched&&!e){this.initialEventsFetched=!0;try{await this.client.paginateEventTimeline(this.liveTimeline,{backwards:!0,limit:Math.max(1,this.length)});for(let e of this.replayEvents)this.addEvent(e,!1);this.replayEvents=null,this.emit("Room.timelineReset",this.room,this.timelineSet,!0)}catch(e){De.error("Failed to load start of newly created thread: ",e),this.initialEventsFetched=!1}}this.emit("Thread.update",this)}setEventMetadata(e){e&&(wt.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){var t,n,r;e&&(e.setThread(void 0),null==(r=null==(n=null==(t=e.event)?void 0:t.unsigned)?void 0:n["m.relations"])||delete r[Nt.name])}getLocalEvents(){return this.localEvents}updateLocalEvent(e){this.removeLocalEvent(e.getId()),null!==e.status&&this.localEvents.push(e)}removeLocalEvent(e){if(!e)return;let t=this.localEvents.findIndex((t=>t.getId()===e));t>-1&&this.localEvents.splice(t,1)}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(e=e=>e.isRelation("m.thread")){for(let t=this.timeline.length-1;t>=0;t--){let n=this.timeline[t];if(e(n))return n}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return null!=(t=null!=(e=this.lastPendingEvent)?e:this.lastEvent)?t:this.lastReply()}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof Bt}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var n,r;let i=e===this.client.getUserId(),o=this.timeline[this.timeline.length-1];if(i&&o){let e=o.getTs()<this.room.getOldestThreadedReceiptTs(),t=o.getId();if(e&&t)return t}let s=super.getEventReadUpTo(e,t);if(o){let t=this.room.getLastUnthreadedReceiptFor(e);if(!t)return s;for(let e=(null==(n=this.timeline)?void 0:n.length)-1;e>=0;--e){let n=this.timeline[e];if(n.getId()===s)return s;if(n.getTs()<t.ts)return null!=(r=n.getId())?r:s}}return s}hasUserReadEvent(e,t){var n,r,i,o,s,a;if(e===this.client.getUserId()){let t=(null!=(r=null==(n=this.lastReply())?void 0:n.getTs())?r:0)<this.room.getOldestThreadedReceiptTs(),l=null!=(o=null==(i=this.room.getLastUnthreadedReceiptFor(e))?void 0:i.ts)?o:0,u=(null!=(a=null==(s=null==this?void 0:this.lastReply())?void 0:s.getTs())?a:0)<l;if(t||u)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}async loadTimeline(){}},Nt={name:"m.thread"},xt=((Pt=xt||{}).NOT_SENT="not_sent",Pt.ENCRYPTING="encrypting",Pt.SENDING="sending",Pt.QUEUED="queued",Pt.SENT="sent",Pt.CANCELLED="cancelled",Pt),Ut=Object.freeze({visible:!0}),jt=(e=>(e.BeforeRedaction="Event.beforeRedaction",e.VisibilityChange="Event.visibilityChange",e.LocalEventIdReplaced="Event.localEventIdReplaced",e.Status="Event.status",e.Replaced="Event.replaced",e.RelationsCreated="Event.relationsCreated",e))(jt||{}),Bt=class e extends je{constructor(e={}){var t;super(),this.event=e,this.pushDetails={},this._replacingEvent=null,this._localRedactionEvent=null,this._isCancelled=!1,this.visibility=Ut,this.sender=null,this.target=null,this.status=null,this.error=null,this.retried=!1,this.forwardLooking=!0,["state_key","type","sender","room_id","membership"].forEach((t=>{"string"==typeof e[t]&&(e[t]=oe(e[t]))})),["membership","avatar_url","displayname"].forEach((t=>{var n;"string"==typeof(null==(n=e.content)?void 0:n[t])&&(e.content[t]=oe(e.content[t]))})),["rel_type"].forEach((t=>{var n,r;"string"==typeof(null==(r=null==(n=e.content)?void 0:n["m.relates_to"])?void 0:r[t])&&(e.content["m.relates_to"][t]=oe(e.content["m.relates_to"][t]))})),this.txnId=e.txn_id;let n=this.getAge();this.localTimestamp=void 0!==n?Date.now()-n:null!=(t=this.getTs())?t:Date.now(),this.reEmitter=new Ot(this)}getEffectiveEvent(){let e=Object.assign({},this.getContent());return Object.assign({},this.event,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender||this.event.user_id}getType(){return this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e;let t=this.getRoomId();return t?`id=${this.getId()} type=${this.getWireType()} sender=${this.getSender()} room=${t} ts=${null==(e=this.getDate())?void 0:e.toISOString()}`:`msgid=${this.getContent()[Q]} type=${this.getWireType()} sender=${this.getSender()}`}getOriginalContent(){return this._localRedactionEvent?{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(this.isState())return;let t=null==(e=this.getWireContent())?void 0:e["m.relates_to"];if((null==t?void 0:t.rel_type)===Nt.name)return t.event_id;if(this.thread)return this.thread.id;if(void 0!==this.threadId)return this.threadId;let n=this.getUnsigned();return"string"==typeof n[re.name]?n[re.name]:void 0}get isThreadRoot(){return!this.isState()&&(!!this.getServerAggregatedRelation(Nt.name)||this.threadRootId===this.getId())}get replyEventId(){var e,t;return null==(t=null==(e=this.getWireContent()["m.relates_to"])?void 0:e["m.in_reply_to"])?void 0:t.event_id}get relationEventId(){var e,t;return null==(t=null==(e=this.getWireContent())?void 0:e["m.relates_to"])?void 0:t.event_id}getPrevContent(){return this.getUnsigned().prev_content||this.event.prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age||this.event.age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}setRetried(e){this.retried=e}unmarkLocallyRedacted(){let e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,n;let r=null==(t=null==e?void 0:e.visible)||t,i=null!=(n=null==e?void 0:e.reason)?n:null,o=!1;(this.visibility.visible!==r||!this.visibility.visible&&this.visibility.reason!==i)&&(o=!0),o&&(this.visibility=r?Ut:Object.freeze({visible:!1,reason:i}),this.emit("Event.visibilityChange",this,r))}messageVisibility(){return this.visibility}makeRedacted(e,t){var n,r,i;if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(let e in this.event)this.event.hasOwnProperty(e)&&!Ft.has(e)&&delete this.event[e];let o=this.getType()in $t?$t[this.getType()]:{},s=this.getContent();if(!(null==(i=null==(r=null==(n=this.getUnsigned())?void 0:n.redacted_because)?void 0:r.unsigned)?void 0:i["com.reddit.keep_redacted_content"]))for(let e in s)s.hasOwnProperty(e)&&!o[e]&&delete s[e]}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return"m.room.redaction"===this.getType()}asVisibilityChange(){if(!Z.matches(this.getType()))return null;let e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;let t=e.event_id;if(!t)return null;let n=this.getWireContent(),r=!!n.visible,i=n.reason;return i&&"string"!=typeof i?null:{visible:r,reason:i,eventId:t}}isVisibilityEvent(){return Z.matches(this.getType())}getRedactionEvent(){var e;return this.isRedacted()?null!=(e=this.event.unsigned)&&e.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushActions(e){this.pushDetails={actions:e||void 0}}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){let t=this.getUnsigned(),n=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit("Event.localEventIdReplaced",this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit("Event.status",this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)}isRelation(e){var t;let n=null==(t=this.getWireContent())?void 0:t["m.relates_to"];return!(this.isState()&&null!=n&&n.rel_type&&["m.replace","m.thread"].includes(n.rel_type))&&!(null==n||!n.rel_type||!n.event_id||e&&n.rel_type!==e)}getRelation(){var e;return this.isRelation()&&null!=(e=this.getWireContent()["m.relates_to"])?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=null!=e?e:null,this.emit("Event.replaced",this))}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null==(t=this.getUnsigned()["m.relations"])?void 0:t[e]}replacingEventId(){let e=this.getServerAggregatedRelation("m.replace");return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e;let t=this.getServerAggregatedRelation("m.replace");if(t){let e=t.origin_server_ts;if(Number.isFinite(e))return new Date(e)}else if(this._replacingEvent)return null!=(e=this._replacingEvent.getDate())?e:void 0}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){let e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssocation(){return!!this.getAssociatedId()}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){let t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(e=!0){this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){let t=new e(JSON.parse(JSON.stringify(this.event)));for(let[e,n]of Object.entries(this))"event"!==e&&(t[e]=n);return t}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;let t=ce(this.event),n=ce(e.event);return JSON.stringify(t)===JSON.stringify(n)}toJSON(){return this.getEffectiveEvent()}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,["Thread.update"]),this.thread=e,this.setThreadId(null==e?void 0:e.id),e&&this.reEmitter.reEmit(e,["Thread.update"]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}},Ft=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),$t={"m.room.member":{membership:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},qt=(e=>(e.Add="Relations.add",e.Remove="Relations.remove",e.Redaction="Relations.redaction",e))(qt||{}),Kt=class extends je{constructor(e,t,n){super(),this.relationType=e,this.eventType=t,this.altEventTypes=n,this.relationEventIds=new Set,this.relations=new Set,this.annotationsByKey={},this.annotationsBySender={},this.sortedAnnotationsByKey=[],this.targetEvent=null,this.creationEmitted=!1,this.onEventStatus=(e,t)=>{e.isSending()?"cancelled"===t&&(e.removeListener("Event.status",this.onEventStatus),this.removeEvent(e)):e.removeListener("Event.status",this.onEventStatus)},this.onBeforeRedaction=async e=>{if(this.relations.has(e)){if(this.relations.delete(e),"m.annotation"===this.relationType)this.removeAnnotationFromAggregation(e);else if("m.replace"===this.relationType&&this.targetEvent&&!this.targetEvent.isState()){let e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener("Event.beforeRedaction",this.onBeforeRedaction),this.emit("Relations.redaction",e)}}}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;let t=e.getRelation();if(!t)return void De.error("Event must have relation info");let n=t.rel_type,r=e.getType();if(this.relationType===n&&((e,t,n=[])=>[t,...n].includes(e))(r,this.eventType,this.altEventTypes)){if(e.isSending()&&e.on("Event.status",this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),"m.annotation"===this.relationType)this.addAnnotationToAggregation(e);else if("m.replace"===this.relationType&&this.targetEvent&&!this.targetEvent.isState()){let e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on("Event.beforeRedaction",this.onBeforeRedaction),this.emit("Relations.add",e),this.maybeEmitCreated()}else De.error("Event relation info doesn't match this container")}async removeEvent(e){if(this.relations.has(e)){if(this.relations.delete(e),"m.annotation"===this.relationType)this.removeAnnotationFromAggregation(e);else if("m.replace"===this.relationType&&this.targetEvent&&!this.targetEvent.isState()){let e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit("Relations.remove",e)}}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t;let{key:n}=null!=(t=e.getRelation())?t:{};if(!n)return;let r=this.annotationsByKey[n];r||(r=this.annotationsByKey[n]=new Set,this.sortedAnnotationsByKey.push([n,r])),r.add(e),this.sortedAnnotationsByKey.sort(((e,t)=>{let n=e[1];return t[1].size-n.size}));let i=e.getSender(),o=this.annotationsBySender[i];o||(o=this.annotationsBySender[i]=new Set),o.add(e)}removeAnnotationFromAggregation(e){var t;let{key:n}=null!=(t=e.getRelation())?t:{};if(!n)return;let r=this.annotationsByKey[n];r&&(r.delete(e),this.sortedAnnotationsByKey.sort(((e,t)=>{let n=e[1];return t[1].size-n.size})));let i=e.getSender(),o=this.annotationsBySender[i];o&&o.delete(e)}getSortedAnnotationsByKey(){return"m.annotation"!==this.relationType?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return"m.annotation"!==this.relationType?null:this.annotationsBySender}async getLastReplacement(){if("m.replace"!==this.relationType||!this.targetEvent)return null;let e=this.targetEvent.getServerAggregatedRelation("m.replace"),t=null==e?void 0:e.origin_server_ts;return this.getRelations().reduce(((e,n)=>n.getSender()!==this.targetEvent.getSender()||t&&t>n.getTs()||e&&e.getTs()>n.getTs()?e:n),null)}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,"m.replace"===this.relationType&&!this.targetEvent.isState()){let e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit("Event.relationsCreated",this.relationType,this.eventType))}},Wt=class{constructor(e){this.room=e,this.relations=new Map}getChildEventsForEvent(e,t,n){var r,i;return null==(i=null==(r=this.relations.get(e))?void 0:r.get(t))?void 0:i.get(n)}getAllChildEventsForEvent(e){var t;let n=null!=(t=this.relations.get(e))?t:new Map,r=[];for(let e of n.values())for(let t of e.values())r.push(...t.getRelations());return r}aggregateParentEvent(e){let t=this.relations.get(e.getId());if(t)for(let n of t.values())for(let t of n.values())t.setTargetEvent(e)}aggregateChildEvent(e,t){var n,r,i;if(e.isRedacted()||"cancelled"===e.status)return;let o=e.getRelation();if(!o)return;let{event_id:s,rel_type:a}=o,l=e.getType(),u=this.relations.get(s);u||(u=new Map,this.relations.set(s,u));let d=u.get(a);d||(d=new Map,u.set(a,d));let c=d.get(l);if(!c){c=new Kt(a,l),d.set(l,c);let e=null!=(n=this.room)?n:null==t?void 0:t.room,o=null!=(i=null!=(r=null==t?void 0:t.findEventById(s))?r:null==e?void 0:e.findEventById(s))?i:null==e?void 0:e.getPendingEvent(s);o&&c.setTargetEvent(o)}c.addEvent(e)}};Ct=De.log.bind(De);var Gt=(e=>(e.Ignore="ignore",e.Replace="replace",e))(Gt||{}),Vt=class extends je{constructor(e,t={},n){var r,i;super(),this.room=e,this.thread=n,this._eventIdToTimeline=new Map,this.liveTimeline=new wt(this),this.displayPendingEvents=!1!==t.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.relations=null!=(i=null==(r=this.room)?void 0:r.relations)?i:new Wt}getTimelines(){return this.timelines}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){let n=this._eventIdToTimeline.get(e);n&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,n))}resetLiveTimeline(e,t){let n=!t,r=this.liveTimeline,i=n?r.forkLive(wt.FORWARDS):r.fork(wt.FORWARDS);n?(this.timelines=[i],this._eventIdToTimeline=new Map):this.timelines.push(i),t&&r.setPaginationToken(t,wt.FORWARDS),i.setPaginationToken(null!=e?e:null,wt.BACKWARDS),this.liveTimeline=i,this.emit("Room.timelineReset",this.room,this,n)}getTimelineForEvent(e){if(null==e)return null;let t=this._eventIdToTimeline.get(e);return void 0===t?null:t}findEventById(e){let t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))}addTimeline(){let e=new wt(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,n,r){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");let i=t?wt.BACKWARDS:wt.FORWARDS,o=t?wt.FORWARDS:wt.BACKWARDS,s=!1,a=!1;for(let r of e){let e=r.getId(),l=this._eventIdToTimeline.get(e);if(!l){this.addEventToTimeline(r,n,{toStartOfTimeline:t}),a=!0,s=!0;continue}if(a=!1,l==n){Ct("Event "+e+" already in timeline "+n);continue}let u=n.getNeighbouringTimeline(i);if(u){Ct(l==u?"Event "+e+" in neighbouring timeline - switching to "+l:"Event "+e+" already in a different timeline "+l),n=l;continue}De.info("Already have timeline for "+e+" - joining timeline "+n+" to "+l);let d=l===this.liveTimeline,c=n===this.liveTimeline,h=i===wt.BACKWARDS&&d,m=i===wt.FORWARDS&&c;h||m?(h&&De.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+l+")"),m&&De.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+n+")")):(n.setNeighbouringTimeline(l,i),l.setNeighbouringTimeline(n,o),n=l,s=!0)}if(a||!s){if(i===wt.FORWARDS&&n===this.liveTimeline)return De.warn({lastEventWasNew:a,didUpdate:s}),void De.warn(`Refusing to set forwards pagination token of live timeline ${n} to ${r}`);n.setPaginationToken(null!=r?r:null,i)}}addLiveEvent(e,t){var n,r,i;let o=null!=(n=null==t?void 0:t.duplicateStrategy)?n:"ignore",s=null!=(r=null==t?void 0:t.fromCache)&&r,a=null==t?void 0:t.roomState,l=this._eventIdToTimeline.get(e.getId());if(l){let t=null==(i=e.getUnsigned())?void 0:i[G];if("replace"===o||t){Ct("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());let n=l.getEvents();for(let t=0;t<n.length;t++)if(n[t].getId()===e.getId()){a||(a=l.getState(wt.FORWARDS)),wt.setEventMetadata(e,a,!1),n[t]=e;break}t&&(Ct("EventTimelineSet.addLiveEvent: dispatching event for redelivered event "+e.getId()),this.emit("Room.timeline",e,this.room,!1,!1,{timeline:l,liveEvent:!1}))}else Ct("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId())}else this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:s,roomState:a})}addEventToTimeline(e,t,n){var r,i,o;let s=n.toStartOfTimeline,a=null!=(r=n.fromCache)&&r,l=n.roomState;if(t.getTimelineSet()!==this)throw new Error(`EventTimelineSet.addEventToTimeline: Timeline=${t.toString()} does not belong " +\n                "in timelineSet(threadId=${null==(i=this.thread)?void 0:i.id})`);let u=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){let n=`event=${u}`;return e.threadRootId&&(n+=`(belongs to thread=${e.threadRootId})`),void De.warn(`EventTimelineSet.addEventToTimeline: Ignoring ${n} that does not belong in timeline=${t.toString()} timelineSet(threadId=${null==(o=this.thread)?void 0:o.id})`)}t.addEvent(e,{toStartOfTimeline:s,roomState:l}),this._eventIdToTimeline.set(u,t);let d={timeline:t,liveEvent:!s&&t==this.liveTimeline&&!a};this.emit("Room.timeline",e,this.room,!!s,!1,d)}insertEventIntoTimeline(e,t,n){var r,i;if(t.getTimelineSet()!==this)throw new Error(`EventTimelineSet.insertEventIntoTimeline: Timeline=${t.toString()} does not belong " +\n                "in timelineSet(threadId=${null==(r=this.thread)?void 0:r.id})`);let o=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){let n=`event=${o}`;return e.threadRootId&&(n+=`(belongs to thread=${e.threadRootId})`),void De.warn(`EventTimelineSet.insertEventIntoTimeline: Ignoring ${n} that does not belong in timeline=${t.toString()} timelineSet(threadId=${null==(i=this.thread)?void 0:i.id})`)}let s=e.relationEventId;if(!s)return void this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,roomState:n});let a=this.findEventById(s),l=t.getEvents(),u=void 0!==a?l.indexOf(a):0;for(;u<l.length&&!(l[u].getTs()>e.getTs());u++);t.insertEvent(e,u,n),this._eventIdToTimeline.set(o,t);let d={timeline:t,liveEvent:!1};this.emit("Room.timeline",e,this.room,!1,!1,d)}handleRemoteEcho(e,t,n){let r=this._eventIdToTimeline.get(t);r?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(n,r)):this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){let t=this._eventIdToTimeline.get(e);if(!t)return null;let n=t.removeEvent(e);if(n){this._eventIdToTimeline.delete(e);let r={timeline:t};this.emit("Room.timeline",n,this.room,void 0,!0,r)}return n}removeAllEvents(){for(let e of this.timelines)e.removeAllEvents()}compareEventOrdering(e,t){if(e==t)return 0;let n=this._eventIdToTimeline.get(e),r=this._eventIdToTimeline.get(t);if(void 0===n||void 0===r)return null;if(n===r){let r,i,o=n.getEvents();for(let n=0;n<o.length&&(void 0===r||void 0===i);n++){let s=o[n].getId();s==e&&(r=n),s==t&&(i=n)}let s=r-i;return s<0?-1:s>0?1:0}let i=n;for(;i;){if(i===r)return-1;i=i.getNeighbouringTimeline(wt.FORWARDS)}for(i=n;i;){if(i===r)return 1;i=i.getNeighbouringTimeline(wt.BACKWARDS)}return null}canContain(e){var t;if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");let{threadId:n,shouldLiveInRoom:r,shouldLiveInThread:i}=this.room.eventShouldLiveIn(e);return this.thread?this.thread.id===n:(!r&&!i&&De.warn(`EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=${null==(t=this.room)?void 0:t.roomId} eventId=${e.getId()} threadId=${e.threadRootId}`),r)}},Ht=class{constructor(e,t){this.roomId=e}},zt=class{constructor(e){this.onTimelineEvent=e=>{let t=e.getId();if(!t)return;let n=this.danglingReceipts.remove(t);null==n||n.forEach((e=>{e.receipt.thread_id?this.threadedReceipts.set(e.receipt.thread_id,e.eventId,e.receiptType,e.userId,e.receipt.ts,e.synthetic):this.unthreadedReceipts.set(t,e.receiptType,e.userId,e.receipt.ts,e.synthetic)}))},this.room=e,this.threadedReceipts=new Zt(e),this.unthreadedReceipts=new Xt(e),this.danglingReceipts=new en,e.on("Room.timeline",this.onTimelineEvent)}add(e,t){for(let[n,r]of Object.entries(e))for(let[e,i]of Object.entries(r))for(let[r,o]of Object.entries(i))this.room.findEventById(n)?o.thread_id?this.threadedReceipts.set(o.thread_id,n,e,r,o.ts,t):this.unthreadedReceipts.set(n,e,r,o.ts,t):this.danglingReceipts.add(new Yt(n,e,r,o,t))}hasUserReadEvent(e,t){let n=this.unthreadedReceipts.get(e);if(n&&nn(n.eventId,t,this.room))return!0;let r=this.room.findEventById(t);if(!r)return De.warn(`hasUserReadEvent event ID ${t} not found in room ${this.room.roomId}: this shouldn't happen!`),!1;let i=br(r),o=this.threadedReceipts.get(i,e);return!!(o&&nn(o.eventId,t,this.room)||this.userSentLatestEventInThread(i,e))}userSentLatestEventInThread(e,t){var n;let r=e===q?this.room.getLiveTimeline().getEvents():null==(n=this.room.getThread(e))?void 0:n.timeline;return!!(r&&r.length>0&&r[r.length-1].getSender()===t)}},Jt=class{constructor(e,t,n){this.eventId=e,this.receiptType=t,this.ts=n}},Yt=class{constructor(e,t,n,r,i){this.eventId=e,this.receiptType=t,this.userId=n,this.receipt=r,this.synthetic=i}},Qt=class{constructor(e){this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&nn(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return null!=(e=this.synthetic)?e:this.real}getByType(e){return e?this.synthetic:this.real}},Xt=class{constructor(e){this.room=e,this.data=new Map}set(e,t,n,r,i){let o=tn(this.data,n,(()=>new Qt(this.room))),s=o.getByType(i);s&&function(e,t,n){let r=n.compareEventOrdering(e,t);return null!==r&&r>0}(s.eventId,e,this.room)||o.set(i,new Jt(e,t,r))}get(e){var t;return null==(t=this.data.get(e))?void 0:t.get()}},Zt=class{constructor(e){this.room=e,this.data=new Map}set(e,t,n,r,i,o){tn(this.data,e,(()=>new Xt(this.room))).set(t,n,r,i,o)}get(e,t){var n;return null==(n=this.data.get(e))?void 0:n.get(t)}},en=class{constructor(){this.data=new Map}add(e){tn(this.data,e.eventId,(()=>[])).push(e)}remove(e){let t=this.data.get(e);return this.data.delete(e),t}};function tn(e,t,n){let r=e.get(t);if(r)return r;{let r=n();return e.set(t,r),r}}function nn(e,t,n){let r=n.compareEventOrdering(e,t);return null!==r&&r>=0}function rn(e,t,n){let r=e.findEventById(t),i=e.findEventById(n);if(!r||!i)return null;let o=_r(r),s=_r(i);return o&&s?function(e,t,n,r,i){let o=e.getUnfilteredTimelineSet(),s=o.compareEventOrdering(t,n);return null!==s?s:o.getTimelineForEvent(t)===o.getLiveTimeline()?1:o.getTimelineForEvent(n)===o.getLiveTimeline()?-1:on(r,i)}(e,t,n,r,i):function(e,t,n,r){let i=br(n),o=br(r),s=n.getThread();return s&&i===o?s.timelineSet.compareEventOrdering(e,t):on(n,r)}(t,n,r,i)}function on(e,t){let n=e.getTs(),r=t.getTs();return n<r?-1:n>r?1:0}var sn,an,ln="10",un=new Set(["m.reaction","com.reddit.approved","com.reddit.reported","com.reddit.hide_user_content","com.reddit.preview_collapse","com.reddit.url_preview","com.reddit.message.copy.deletion"]),dn=(e=>(e.Highlight="highlight",e.Total="total",e))(dn||{}),cn=((an=cn||{}).MyMembership="Room.myMembership",an.Tags="Room.tags",an.AccountData="Room.accountData",an.AccountDataSynced="Room.accountDataSynced",an.Receipt="Room.receipt",an.Name="Room.name",an.Redaction="Room.redaction",an.RedactionCancelled="Room.redactionCancelled",an.LocalEchoUpdated="Room.localEchoUpdated",an.Timeline="Room.timeline",an.TimelineReset="Room.timelineReset",an.TimelineRefresh="Room.TimelineRefresh",an.OldStateUpdated="Room.OldStateUpdated",an.CurrentStateUpdated="Room.CurrentStateUpdated",an.UnreadNotifications="Room.UnreadNotifications",an.Summary="Room.Summary",an),hn=class extends kt{constructor(e,t,n,r={}){super(),this.roomId=e,this.client=t,this.myUserId=n,this.opts=r,((e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)})(this,sn,!1),this.txnToEvent=new Map,this.notificationCounts={},this.threadNotifications=new Map,this.cachedThreadReadReceipts=new Map,this.oldestThreadedReceiptTs=1/0,this.unthreadedReceipts=new Map,this.threadsTimelineSets=[],this.timelineNeedsRefresh=!1,this.summaryHeroes=null,this.getTypeWarning=!1,this.getVersionWarning=!1,this.tags={},this.accountData=new Map,this.summary=null,this.relations=new Wt(this),this.threads=new Map,this.visibilityEvents=new Map,this.roomReceipts=new zt(this),this.threadsReady=!1,this.updateThreadRootEvents=(e,t,n)=>{var r,i;e.length&&(this.updateThreadRootEvent(null==(r=this.threadsTimelineSets)?void 0:r[0],e,t,n),e.hasCurrentUserParticipated&&this.updateThreadRootEvent(null==(i=this.threadsTimelineSets)?void 0:i[1],e,t,n))},this.updateThreadRootEvent=(e,t,n,r)=>{e&&t.rootEvent&&(r&&e.removeEvent(t.id),e.addLiveEvent(t.rootEvent,{duplicateStrategy:"replace",fromCache:!1,roomState:this.currentState}))},this.applyRedaction=e=>{if(e.isRedaction()){let t=e.event.redacts,n=t?this.findEventById(t):void 0;if(n){let r=n.threadRootId;if(n.makeRedacted(e,this),n.isState()){let e=this.currentState.getStateEvents(n.getType(),n.getStateKey());(null==e?void 0:e.getId())===n.getId()&&this.currentState.setStateEvents([n])}this.emit("Room.redaction",e,this,r),this.visibilityEvents.delete(t),n.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}}},this.setMaxListeners(100),this.reEmitter=new Ot(this),r.pendingEventOrdering=r.pendingEventOrdering||"chronological",this.name=e,this.normalizedName=e,this.timelineSets=[new Vt(this)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this.fixUpLegacyTimelineFields(),"detached"===this.opts.pendingEventOrdering&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then((e=>{let t=this.client.getEventMapper({toDevice:!1});e.forEach((async e=>{let n=t(e);n.setStatus("not_sent"),this.addPendingEvent(n,n.getTxnId())}))}))),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}getCreator(){var e;let t=this.currentState.getStateEvents("m.room.create","");return null!=(e=null==t?void 0:t.getSender())?e:null}getVersion(){var e;let t=this.currentState.getStateEvents("m.room.create","");return t?null!=(e=t.getContent().room_version)?e:"1":(this.getVersionWarning||(De.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);let t=le(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,n;return null!=(n=null==(t=this.pendingEventList)?void 0:t.some((t=>t.getId()===e)))&&n}getPendingEvent(e){var t,n;return null!=(n=null==(t=this.pendingEventList)?void 0:t.find((t=>t.getId()===e)))?n:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}getLastActiveTimestamp(){let e=this.getLiveTimeline().getEvents();return e.length?e[e.length-1].getTs():Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t;let n=this.getLiveTimeline().getEvents(),r=n[n.length-1],i=this.getLastThread();if(!i)return r;let o=i.events[i.events.length-1];return(null!=(e=null==r?void 0:r.getTs())?e:0)>(null!=(t=null==o?void 0:o.getTs())?t:0)?r:o}getLastThread(){return this.getThreads().reduce(((e,t)=>{var n,r;if(!e)return t;let i=t.events[t.events.length-1],o=e.events[e.events.length-1];return(null!=(n=null==i?void 0:i.getTs())?n:0)>=(null!=(r=null==o?void 0:o.getTs())?r:0)?t:e}),void 0)}getMyMembership(){var e;return null!=(e=this.selfMembership)?e:"leave"}updateMyMembership(e){let t=this.selfMembership;this.selfMembership=e,t!==e&&("leave"===e&&this.cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))}async loadMembersFromServer(){let e=this.client.store.getSyncToken();return(await this.client.members(this.roomId,void 0,"leave",null!=e?e:void 0)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);return null===t&&(e=!0,t=await this.loadMembersFromServer(),De.log(`LL: got ${t.length} members from server for room ${this.roomId}`)),{memberEvents:t.filter(Oe).map(this.client.getEventMapper()),fromServer:e}}membersLoaded(){return!this.opts.lazyLoadMembers||this.currentState.outOfBandMembersReady()}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();let e=this.loadMembers().then((e=>(this.currentState.setOutOfBandMembers(e.memberEvents),e.fromServer))).catch((e=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),e}));return e.then((e=>{if(e){let e=this.currentState.getMembers().filter((e=>e.isOutOfBand())).map((e=>{var t;return null==(t=e.events.member)?void 0:t.event}));return De.log(`LL: telling store to write ${e.length} members for room ${this.roomId}`),this.client.store.setOutOfBandMembers(this.roomId,e).catch((e=>{De.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((e=>{De.error(e)})),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=void 0)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch((e=>{De.error(`error after clearing loaded members from room ${this.roomId} after leaving`),De.log(e)}))}resetLiveTimeline(e,t){for(let n of this.timelineSets)n.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);for(let n of this.threads.values())n.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){let e=this.oldState,t=this.currentState;this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(wt.BACKWARDS),this.currentState=this.getLiveTimeline().getState(wt.FORWARDS),e!==this.oldState&&this.emit("Room.OldStateUpdated",this,e,this.oldState),t!==this.currentState&&(this.emit("Room.CurrentStateUpdated",this,t,this.currentState),this.reEmitter.stopReEmitting(t,["RoomState.events","RoomState.members","RoomState.newMember","RoomState.update"]),this.reEmitter.reEmit(this.currentState,["RoomState.events","RoomState.members","RoomState.newMember","RoomState.update"]))}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){let t=this.findEventById(e),n=this.findThreadForEvent(t);return n?n.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(!t){let n=this.getThreads();for(let r=0;r<n.length;r++)if(t=n[r].findEventById(e),t)return t}return t}getUnreadNotificationCount(e="total"){var t;let n=this.getRoomUnreadNotificationCount(e);for(let r of this.threadNotifications.values())n+=null!=(t=r[e])?t:0;return n}getUnreadThreadCount(e="total"){let t=0;for(let n of this.threadNotifications.values())n[e]&&t++;return t}getUnreadThreadIds(e="total"){let t=[];return this.threadNotifications.forEach(((n,r)=>{n[e]&&t.push(r)})),t}getUnreadCountForEventContext(e="total",t){var n;return null!=(n=t.threadRootId&&!t.isThreadRoot?this.getThreadUnreadNotificationCount(t.threadRootId,e):this.getRoomUnreadNotificationCount(e))?n:0}getRoomUnreadNotificationCount(e="total"){var t;return null!=(t=this.notificationCounts[e])?t:0}getThreadUnreadNotificationCount(e,t="total"){var n,r;return null!=(r=null==(n=this.threadNotifications.get(e))?void 0:n[t])?r:0}hasThreadUnreadNotification(){var e,t;for(let n of this.threadNotifications.values())if((null!=(e=n.highlight)?e:0)>0||(null!=(t=n.total)?t:0)>0)return!0;return!1}setThreadUnreadNotificationCount(e,t,n){var r,i;let o={highlight:null==(r=this.threadNotifications.get(e))?void 0:r.highlight,total:null==(i=this.threadNotifications.get(e))?void 0:i.total,[t]:n};this.threadNotifications.set(e,o),this.emit("Room.UnreadNotifications",o,e)}get threadsAggregateNotificationType(){var e,t;let n=null;for(let r of this.threadNotifications.values()){if((null!=(e=r.highlight)?e:0)>0)return"highlight";(null!=(t=r.total)?t:0)>0&&!n&&(n="total")}return n}get isUnreadCountedInGlobal(){return d(this,sn)}resetThreadUnreadNotificationCount(e){if(e)for(let[t]of this.threadNotifications)e.includes(t)||this.threadNotifications.delete(t);else this.threadNotifications.clear();this.emit("Room.UnreadNotifications")}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit("Room.UnreadNotifications",this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setIsUnreadCountedInGlobal(e){let t=null!=e&&e;t!==d(this,sn)&&(((e,t,n)=>{u(e,t,"write to private field"),t.set(e,n)})(this,sn,t),this.emit("Room.UnreadNotifications"))}setSummary(e){let t=e["m.heroes"],n=e["m.joined_member_count"],r=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(r)&&this.currentState.setInvitedMemberCount(r),Array.isArray(t)&&(this.summaryHeroes=t.filter((e=>e!==this.myUserId))),this.emit("Room.Summary",e)}getAvatarUrl(e,t,n,r,i=!0){let o=this.currentState.getStateEvents("m.room.avatar","");if(!o&&!i)return null;let s=o?o.getContent().url:null;return s?Ce(e,s,t,n,r):null}getMxcAvatarUrl(){var e,t;return(null==(t=null==(e=this.currentState.getStateEvents("m.room.avatar",""))?void 0:e.getContent())?void 0:t.url)||null}getCanonicalAlias(){let e=this.currentState.getStateEvents("m.room.canonical_alias","");return e&&e.getContent().alias||null}addEventsToTimeline(e,t,n,r){n.getTimelineSet().addEventsToTimeline(e,t,n,r)}getThread(e){var t;return null!=(t=this.threads.get(e))?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership("join")}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}hasMembershipState(e,t){let n=this.getMember(e);return!!n&&n.membership===t}processThreadRoots(e,t){for(let n of e)wt.setEventMetadata(n,this.currentState,t),this.getThread(n.getId())||this.createThread(n.getId(),n,[],t)}eventShouldLiveIn(e,t,n){var r;if(e.isThreadRoot||null!=n&&n.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};let i,o=e.isRelation(Nt.name),s=e.getAssociatedId(),a=e.threadRootId;return s&&!o&&(a===s||null!=n&&n.has(s))?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:(s&&(i=null!=(r=this.findEventById(s))?r:null==t?void 0:t.find((e=>e.getId()===s))),i&&!o?this.eventShouldLiveIn(i,t,n):null!=a?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:a}:!s||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1})}findThreadForEvent(e){if(!e)return null;let{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t,n=!1){var r;let i=this.getThread(e);if(i)i.addEvents(t,n);else{let i=null!=(r=this.findEventById(e))?r:t.find((t=>t.getId()===e));this.createThread(e,i,t,n)}}processThreadedEvents(e,t){var n;e.forEach(this.applyRedaction);let r={};for(let t of e){let{threadId:e,shouldLiveInThread:i}=this.eventShouldLiveIn(t);i&&!r[e]&&(r[e]=[]),null==(n=r[e])||n.push(t)}Object.entries(r).map((([e,n])=>this.addThreadedEvents(e,n,t)))}createThread(e,t,n=[],r){var i,o,s;if(this.threads.has(e))return this.threads.get(e);if(t){let e=this.relations.getAllChildEventsForEvent(t.getId());null!=e&&e.length&&(n=n.concat(e.filter((e=>!e.isRelation("m.replace")))))}let a=new Dt(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:null!=(i=this.cachedThreadReadReceipts.get(e))?i:[]});this.cachedThreadReadReceipts.delete(e),this.threads.set(a.id,a),a.addEvents(n,!1),this.reEmitter.reEmit(a,["Thread.delete","Thread.update","Thread.newReply","Room.timeline","Room.timelineReset"]);let l=(null==(o=this.lastThread)?void 0:o.rootEvent)&&(null==t?void 0:t.localTimestamp)&&(null==(s=this.lastThread.rootEvent)?void 0:s.localTimestamp)<(null==t?void 0:t.localTimestamp);return(!this.lastThread||l)&&(this.lastThread=a),this.threadsReady&&this.updateThreadRootEvents(a,r,!1),this.emit("Thread.new",a,r),a}processLiveEvent(e){if(this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e),!e.getUnsigned().transaction_id&&e.getSender()===this.myUserId)for(let[t,n]of this.txnToEvent)if(n.getId()===e.getId()){De.debug("processLiveEvent: found sent event without txn ID: ",t,e.getId());let n=e.getUnsigned();n.transaction_id=t,e.setUnsigned(n);break}}addLiveEvent(e,t){let{duplicateStrategy:n,fromCache:r}=t;for(let t of this.timelineSets)t.addLiveEvent(e,{duplicateStrategy:n,fromCache:r});e.sender&&"m.room.redaction"!==e.getType()&&this.addReceipt(Mt(e.sender.userId,e,"m.read"),!0)}addPendingEvent(e,t){if("sending"!==e.status&&"not_sent"!==e.status)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(wt.setEventMetadata(e,this.getLiveTimeline().getState(wt.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some((e=>"not_sent"===e.status))&&(De.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus("not_sent")),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){let t=e.event.redacts,n=this.pendingEventList.find((e=>e.getId()===t));!n&&t&&(n=this.findEventById(t)),n&&(n.markLocallyRedacted(e),this.emit("Room.redaction",e,this,n.threadRootId))}}else for(let t of this.timelineSets)t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1});this.emit("Room.localEchoUpdated",e,this)}savePendingEvents(){if(this.pendingEventList){let e=this.pendingEventList.map((e=>({...e.event,txn_id:e.getTxnId()})));this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){let n=t.getId(),r=e.getId(),i=t.status;De.debug(`Got remote echo for event ${n} -> ${r} old status ${i}`),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(n),t.handleRemoteEcho(e.event);let{shouldLiveInRoom:o,threadId:s}=this.eventShouldLiveIn(e),a=s?this.getThread(s):null;if(null==a||a.setEventMetadata(t),null==a||a.timelineSet.handleRemoteEcho(t,n,r),o)for(let e of this.timelineSets)e.handleRemoteEcho(t,n,r);this.emit("Room.localEchoUpdated",t,this,n,i)}updatePendingEvent(e,t,n){if(De.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${n}`),"sent"==t&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if("sent"==t&&this.getTimelineForEvent(n)){let t=this.findEventById(n);if(!(null==t?void 0:t.getUnsigned().transaction_id)&&t){let n=t.getUnsigned();n.transaction_id=e.getTxnId(),t.setUnsigned(n),this.removeEvent(t.getId()),this.handleRemoteEcho(t,e)}return}let r=e.status,i=e.getId();if(!r)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");let o=mn[r];if(null==o||!o.includes(t))throw new Error(`Invalid EventStatus transition ${r}->${t}`);if(e.setStatus(t),"sent"==t){e.replaceLocalEventId(n);let{shouldLiveInRoom:t,threadId:r}=this.eventShouldLiveIn(e),o=r?this.getThread(r):void 0;if(null==o||o.setEventMetadata(e),null==o||o.timelineSet.replaceEventId(i,n),t)for(let e of this.timelineSets)e.replaceEventId(i,n)}else if("cancelled"==t){if(this.pendingEventList){let e=this.getPendingEvent(i);this.removePendingEvent(i),null!=e&&e.isRedaction()&&this.revertRedactionLocalEcho(e)}this.removeEvent(i)}this.savePendingEvents(),this.emit("Room.localEchoUpdated",e,this,i,r)}revertRedactionLocalEcho(e){let t=e.event.redacts;if(!t)return;let n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),n.isRelation()&&this.aggregateNonLiveRelation(n))}async addLiveEvents(e,t){let{duplicateStrategy:n,fromCache:r}=t||{};if(n&&-1===["replace","ignore"].indexOf(n))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let e=0;e<this.timelineSets.length;e++){let t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(wt.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(wt.FORWARDS)+")");if(t.getNeighbouringTimeline(wt.FORWARDS))throw new Error(`live timeline ${e} is no longer live - it has a neighbouring timeline`)}let i=[...e].sort(((e,t)=>e.getTs()-t.getTs())),o=this.findThreadRoots(i),s={},a={duplicateStrategy:n,fromCache:r},l=[...i],u=[];for(let e of i){let t=new Promise((async t=>{var n,r;if(this.processLiveEvent(e),e.getUnsigned().transaction_id){let n=this.txnToEvent.get(e.getUnsigned().transaction_id);n&&(this.handleRemoteEcho(e,n),t())}if((e.isThreadRoot||e.threadRootId)&&e.getUnsigned()[G]){let t=this.findEventById(null!=(n=e.getId())?n:"");t&&this.handleRemoteEcho(e,t)}let{shouldLiveInRoom:i,shouldLiveInThread:u,threadId:d}=this.eventShouldLiveIn(e,l,o);if(!u&&!i&&e.isRelation()&&!un.has(e.getType())&&"leave"!==this.getMyMembership())try{let t=new Bt(await this.client.fetchRoomEvent(this.roomId,e.relationEventId));if(l.push(t),t.threadRootId){o.add(t.threadRootId);let n=e.getUnsigned();n[re.name]=t.threadRootId,e.setUnsigned(n)}({shouldLiveInRoom:i,shouldLiveInThread:u,threadId:d}=this.eventShouldLiveIn(e,l,o))}catch(e){De.error("Failed to load parent event of unhandled relation",e)}u&&!s[null!=d?d:""]&&(s[null!=d?d:""]=[]),null==(r=s[null!=d?d:""])||r.push(e),i?this.addLiveEvent(e,a):!u&&e.isRelation()&&this.relations.aggregateChildEvent(e),t()}));u.push(t)}r||await Promise.all(u)}partitionThreadedEvents(e){let t=this.findThreadRoots(e);return e.reduce(((n,r)=>{let{shouldLiveInRoom:i,shouldLiveInThread:o,threadId:s}=this.eventShouldLiveIn(r,e,t);return i&&n[0].push(r),o&&(r.setThreadId(null!=s?s:""),n[1].push(r)),!o&&!i&&n[2].push(r),n}),[[],[],[]])}findThreadRoots(e){let t=new Set;for(let n of e){let e=n.threadRootId;null!=e&&t.add(e)}return t}addReceipt(e,t=!1){let n=e.getContent();this.roomReceipts.add(n,t),Object.keys(n).forEach((e=>{Object.keys(n[e]).forEach((r=>{Object.keys(n[e][r]).forEach((i=>{var o,s,a,l;let u=n[e][r][i],d=!u.thread_id||u.thread_id===q,c=d?this:this.threads.get(null!=(o=u.thread_id)?o:"");if(c){if(c.addReceiptToStructure(e,r,i,u,t),!t&&this.client.isInitialSyncComplete()&&i===this.client.getUserId()){let t=c.timeline[c.timeline.length-1];t&&e===t.getId()&&i===t.getSender()&&(c.setUnread("total",0),c.setUnread("highlight",0))}}else this.cachedThreadReadReceipts.set(u.thread_id,[...null!=(s=this.cachedThreadReadReceipts.get(u.thread_id))?s:[],{eventId:e,receiptType:r,userId:i,receipt:u,synthetic:t}]);i===this.client.getUserId()&&!d&&u.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=u.ts),!u.thread_id&&u.ts>(null!=(l=null==(a=this.unthreadedReceipts.get(i))?void 0:a.ts)?l:0)&&this.unthreadedReceipts.set(i,u)}))}))})),this.emit("Room.receipt",e,this)}addEphemeralEvents(e){for(let t of e)"m.typing"===t.getType()?this.currentState.setTypingEvent(t):"m.receipt"===t.getType()&&this.addReceipt(t)}removeEvents(e){for(let t of e)this.removeEvent(t)}removeEvent(e){let t=!1;for(let n of this.timelineSets){let r=n.removeEvent(e);r&&(r.isRedaction()&&this.revertRedactionLocalEcho(r),t=!0)}return t}removeAllEvents(){for(let e of this.timelineSets)e.removeAllEvents()}recalculate(){let e=this.currentState.getStateEvents("m.room.member",this.myUserId);if(e){let t=e.getContent().membership;this.updateMyMembership(t),"invite"===t&&(e.getUnsigned().invite_room_state||[]).forEach((e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new Bt({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,user_id:this.myUserId})])}))}let t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=me(this.name.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase(),this.summary=new Ht(this.roomId,{title:this.name}),t!==this.name&&this.emit("Room.name",this)}addAccountData(e){for(let t of e){let e=t.getType(),n=this.accountData.get(e);this.accountData.set(e,t),this.emit("Room.accountData",t,this,n)}}getAccountData(e){return this.accountData.get(e)}canInvite(e){let t="join"===this.getMyMembership(),n=this.currentState.getStateEvents("m.room.power_levels",""),r=n&&n.getContent(),i=this.getMember(e);return r&&i&&r.invite>i.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getType(){let e=this.currentState.getStateEvents("m.room.create","");if(e)return e.getContent()[J];this.getTypeWarning||(De.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isPeeked(){return this.client.isRoomPeeked(this.roomId)}isSpaceRoom(){return"m.space"===this.getType()}findPredecessor(e=!1){let t=this.getLiveTimeline().getState(wt.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){switch(e.type){case 2:return e.name;case 1:return"Inviting"===e.subtype?`Inviting ${pn(e.names,e.count)}`:pn(e.names,e.count);case 0:return e.oldName?`Empty room (was ${e.oldName})`:"Empty room"}}calculateRoomName(e){let t=this.currentState.getStateEvents("m.room.name","");if(null!=t&&t.getContent().name)return this.roomNameGenerator({type:2,name:t.getContent().name});let n=this.getCanonicalAlias();if(n)return this.roomNameGenerator({type:2,name:n});let r=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1,i=[],o=this.currentState.getStateEvents(X.name,"");Array.isArray(null==o?void 0:o.getContent().service_members)&&(i=o.getContent().service_members);let s=[];if(this.summaryHeroes)this.summaryHeroes.forEach((e=>{if(i.includes(e))return void r--;let t=this.getMember(e);s.push(t?t.name:e)}));else{let t=this.currentState.getMembers().filter((t=>t.userId!==e&&("invite"===t.membership||"join"===t.membership)));t=t.filter((({userId:e})=>!i.includes(e)||(r--,!1))),t.sort(((e,t)=>function(e,t){return Re.compare(e,t)}(e.userId,t.userId))),t=t.slice(0,5),s=t.map((e=>e.name))}if(r)return this.roomNameGenerator({type:1,names:s,count:r});let a,l=s;return l.length||(l=this.currentState.getMembers().filter((t=>t.userId!==e&&"invite"!==t.membership&&"join"!==t.membership)).map((e=>e.name))),l.length&&(a=this.roomNameGenerator({type:1,names:l,count:l.length+1})),this.roomNameGenerator({type:0,oldName:a})}applyNewVisibilityEvent(e){let t=e.asVisibilityChange();if(!t)return;let n=e.getSender();if(!n||!(Z.name&&this.currentState.maySendStateEvent(Z.name,n)||Z.altName&&this.currentState.maySendStateEvent(Z.altName,n)))return;let r=this.visibilityEvents.get(t.eventId);if(r){let t=r.length-1,n=Math.max(0,r.length-30);for(;t>=n&&!(r[t].getTs()<e.getTs());--t);-1===t?r.unshift(e):r.splice(t+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);let i=this.findEventById(t.eventId);i&&i.applyVisibilityEvent(t)}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");let t=e.getRelation(),n=null==t?void 0:t.event_id,r=this.visibilityEvents.get(n);if(!r)return;let i=r.findIndex((t=>t.getId()===e.getId()));if(-1!==i&&(r.splice(i,1),i===r.length)){let e=this.findEventById(n);if(!e)return;if(0===i)this.visibilityEvents.delete(n),e.applyVisibilityEvent();else{let t=r[r.length-1].asVisibilityChange();if(!t)throw new Error("at this stage, visibility changes should be well-formed");e.applyVisibilityEvent(t)}}}applyPendingVisibilityEvents(e){let t=this.visibilityEvents.get(e.getId());if(!t||0==t.length)return;let n=t[t.length-1],r=n.asVisibilityChange();r&&(r.visible,!(n.getTs()<e.getTs())&&e.applyVisibilityEvent(r))}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);let t=this.getThreads().filter((e=>this.getThreadUnreadNotificationCount(e.id,"total")>0));for(let n of t)n.fixupNotifications(e)}compareEventOrdering(e,t){return rn(this,e,t)}};sn=new WeakMap;var mn={encrypting:["sending","not_sent","cancelled"],sending:["encrypting","queued","not_sent","sent"],queued:["sending","not_sent","cancelled"],sent:[],not_sent:["sending","queued","cancelled"],cancelled:[]},vn=(e=>(e[e.EmptyRoom=0]="EmptyRoom",e[e.Generated=1]="Generated",e[e.Actual=2]="Actual",e))(vn||{});function pn(e,t){let n=t-1;return e.length?1===e.length&&n<=1?e[0]:2===e.length&&n<=2?`${e[0]} and ${e[1]}`:n>1?`${e[0]} and ${n} others`:`${e[0]} and 1 other`:"Empty room"}function fn(e){var t,n,r;let i={};return i.room=null!=(t=e.room)?t:{},void 0===e.lazy_load_members||(i.room=e.room||{},i.room.state=(null==(n=e.room)?void 0:n.state)||{},i.room.timeline=(null==(r=e.room)?void 0:r.timeline)||{},i.room.timeline.lazy_load_members=e.lazy_load_members,i.room.state.lazy_load_members=e.lazy_load_members),i}function gn(e){return JSON.stringify(fn(null!=e?e:bn))}function yn(e){var t;return JSON.stringify({lazy_load_members:null!=(t=null==e?void 0:e.lazy_load_members)?t:bn.lazy_load_members})}function En(e){var t;let n=fn(null!=e?e:bn);if(null!=(t=null==n?void 0:n.room)&&t.timeline)return JSON.stringify(n.room.timeline)}var bn={lazy_load_members:!0,room:{timeline:{unread_thread_notifications:!0,not_types:["com.reddit.review_open","com.reddit.review_close"],not_aggregated_relations:["m.annotation","com.reddit.hide_user_content","com.reddit.potentially_toxic","com.reddit.display_settings","com.reddit.review_request"]}}},_n={lazy_load_members:!0,room:{timeline:{unread_thread_notifications:!0,not_types:["com.reddit.review_open","com.reddit.review_close"]}}},Rn=new class extends K{constructor(){super(...arguments),this.preferUnstable=!1}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications"),Tn=(e=>(e.Invite="invite",e.Leave="leave",e.Join="join",e.Peek="peek",e.Inactive="inactive",e))(Tn||{}),Sn="com.reddit.peek",wn="com.reddit.global_navigation_counter",In="com.reddit.invites_counter",On="com.reddit.spam_invites_counter",Mn="com.reddit.threads_counter",Pn="com.reddit.main_timeline_counter",Cn="com.reddit.w3_report_labels",kn=(e=>(e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e))(kn||{});function An(...e){De.log(...e)}var Ln=class e{constructor(e,t,n){var r;this.client=e,this.syncState=null,this.catchingUp=!1,this.running=!1,this.storeIsInvalid=!1,this.opts=(r=t,{pollTimeout:3e4,pendingEventOrdering:"chronological",...r}),this.syncOpts=function(e){return{canResetEntireTimeline:e=>!1,...e}}(n)}createRoom(e){return function(e,t,n){var r;let i=new hn(t,e,e.getUserId(),{lazyLoadMembers:(null!=(r=n.filter)?r:bn).lazy_load_members,pendingEventOrdering:n.pendingEventOrdering});return e.reEmitter.reEmit(i,["Room.name","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.localEchoUpdated","Room.accountData","Room.accountDataSynced","Room.myMembership","Room.timeline","Room.timelineReset","RoomState.events","RoomState.members","RoomState.newMember","RoomState.update"]),i.on("RoomState.newMember",((t,n,r)=>{var i;r.user=null!=(i=e.getUser(r.userId))?i:void 0,e.reEmitter.reEmit(r,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])})),i}(this.client,e,this.opts)}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!=(e=this.syncStateData)?e:null}shouldAbortSync(e){return("M_UNKNOWN_TOKEN"===e.errcode||"M_MISSING_TOKEN"===e.errcode)&&(De.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState("ERROR",{error:e}),!0)}async sync(){this.running=!0,this.abortController=new AbortController,An("Getting saved sync token...");let e=this.client.store.getSavedSyncToken().then((e=>(An("Got saved sync token"),e)));if(this.savedSyncPromise=this.client.store.getSavedSync().then((e=>{if(An(`Got reply from saved sync, exists? ${!!e}`),e)return this.syncFromCache(e)})).catch((e=>{De.error("Getting saved sync failed",e)})),this.client.getPushRules(),!this.currentSyncRequest){let t=await e;this.currentSyncRequest=this.doSyncRequest({filter:gn(this.opts.filter)},t)}return An("Waiting for saved sync before starting sync processing..."),await this.savedSyncPromise,this.doSync({filter:gn(this.opts.filter)})}stop(){var e;An("SyncApi.stop"),this.running=!1,null==(e=this.abortController)||e.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}async syncFromCache(e){var t;An("sync(): not doing HTTP hit, instead returning stored /sync data");let n=e.nextBatch;this.client.store.setSyncToken(n);let r={nextSyncToken:n,catchingUp:!1,fromCache:!0},i={next_batch:n,rooms:e.roomsData,[Sn]:e[Sn],[wn]:e[wn]||0,[In]:e[In]||0,[On]:null!=(t=e[On])?t:-1,[Mn]:e[Mn]||0,[Pn]:e[Pn]||0,[Cn]:e[Cn],account_data:{events:e.accountData}};try{await this.processSyncResponse(r,i)}catch(e){De.error("Error processing cached sync",e)}this.storeIsInvalid||this.updateSyncState("PREPARED",r,i)}async doSync(t){for(var n;this.running;){let r,i=this.client.store.getSyncToken();try{this.currentSyncRequest||(this.currentSyncRequest=this.doSyncRequest(t,i)),r=await this.currentSyncRequest}catch(e){if(await this.onSyncError(e))return;continue}finally{this.currentSyncRequest=void 0}this.client.store.setSyncToken(r.next_batch),e.failedSyncCount=0;let o={oldSyncToken:null!=i?i:void 0,nextSyncToken:r.next_batch,catchingUp:this.catchingUp};try{"restarted"===(null==(n=r["com.reddit.w3_report_labels"])?void 0:n.response_type)&&(this.opts.enableSyncRestart&&(await this.client.store.resetAllData(),o.oldSyncToken=void 0),this.client.emit("restartSync")),await this.processSyncResponse(o,r)}catch(e){De.error("Caught /sync error",e),this.client.emit("sync.unexpectedError",e)}await this.client.store.setSyncData(r),o.catchingUp=this.catchingUp,t.hasSyncedBefore||(this.updateSyncState("PREPARED",o),t.hasSyncedBefore=!0),this.updateSyncState("SYNCING",o,r)}this.running||(An("Sync no longer running: exiting."),this.updateSyncState("STOPPED"))}doSyncRequest(e,t){var n;let r=this.getSyncParams(e,t);return this.client.http.authedRequest("GET","/sync",r,void 0,{localTimeoutMs:r.timeout+8e4,abortSignal:null==(n=this.abortController)?void 0:n.signal})}getSyncParams(e,t){let n=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this.catchingUp)&&(this.catchingUp=!0,n=0);let r={filter:e.filter,timeout:n};return t?r.since=t:r._cacheBuster=Date.now(),["ERROR"].includes(this.getSyncState())&&(r.timeout=0),r}async onSyncError(t){if(!this.running)return An("Sync no longer running: exiting"),this.updateSyncState("STOPPED"),!0;if(De.error("/sync error %s",t),"M_FORBIDDEN"===t.errcode&&"chat_policy_enforcement"===t.data["com.reddit.error.code"])return this.client.emit("chat_policy_enforcement"),!0;if(this.shouldAbortSync(t))return!0;if("M_LIMIT_EXCEEDED"===t.errcode)return new Promise((e=>{var n;setTimeout((()=>{e(!1)}),(null==(n=t.data)?void 0:n.retry_after_ms)||1e3)}));if(e.failedSyncCount++,De.log("Number of consecutive failed sync requests:",e.failedSyncCount),this.currentSyncRequest=void 0,e.failedSyncCount>3)return this.updateSyncState("ERROR",{error:t}),!0;let n=2**e.failedSyncCount*1e3;return await new Promise((e=>setTimeout(e,n))),!1}async processSyncResponse(e,t){var n,r;let i=this.client;if(Array.isArray(null==(n=t.presence)?void 0:n.events)&&t.presence.events.filter(Oe).map(i.getEventMapper()).forEach((function(e){let t=i.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=Rt.createUser(e.getSender(),i),t.setPresenceEvent(e),i.store.storeUser(t)),i.emit("event",e)})),Array.isArray(null==(r=t.account_data)?void 0:r.events)){let e=t.account_data.events.filter(Oe).map(i.getEventMapper()),n=e.reduce(((e,t)=>(e[t.getType()]=i.store.getAccountData(t.getType()),e)),{});i.store.storeAccountDataEvents(e),e.forEach((function(e){if("m.push_rules"===e.getType()){let t=e.getContent();i.setPushRules(t)}let t=n[e.getType()];return i.emit("accountData",e,t),e}))}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){let e=t.to_device.events.filter(Oe),n=[];e.map(i.getEventMapper({toDevice:!0})).map((e=>{if("m.key.verification.cancel"===e.getType()){let t=e.getContent().transaction_id;t&&n.push(t)}return e})).forEach((function(e){let t=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=t.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){let r=t.transaction_id;n.includes(r)&&e.flagCancelled()}i.emit("toDeviceEvent",e)}else De.log("Ignoring undecryptable to-device event from "+e.getSender())}))}else this.catchingUp=!1;this.handlePeekUpdates(t),!this.opts.disableHideUserContentEventsProcessing&&!e.fromCache&&this.handleHideUserContentEvents(t);let o=[],s=[],a=[],l=[];t.rooms&&(t.rooms.invite&&(o=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(s=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(a=this.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.inactive&&(l=this.mapSyncResponseToRoomArray(t.rooms.inactive)));let u=[],d=be(o,(async e=>{let t=e.room,n=this.mapSyncEventsFormat(e.invite_state,t);t.setIsUnreadCountedInGlobal(e["com.reddit.is_counted_in_global_navigation_counter"]),await this.injectRoomEvents(t,n),t.recalculate(),n.forEach((function(e){i.emit("event",e)}))}));u.push(d);let c=be(s,(async t=>{await this.handleRoomUpdates(e,t)}));u.push(c);let h=be(a,(async e=>{let t=e.room,n=this.mapSyncEventsFormat(e.state,t),r=this.mapSyncEventsFormat(e.timeline,t),o=this.mapSyncEventsFormat(e.account_data);await this.injectRoomEvents(t,n,r),t.addAccountData(o),t.recalculate(),n.forEach((function(e){i.emit("event",e)})),r.forEach((function(e){i.emit("event",e)})),o.forEach((function(e){i.emit("event",e)})),i.emit("Room.accountDataSynced",t)}));u.push(h);let m=be(l,(async e=>{let t=e.room;t.removeAllListeners(),t.removeAllEvents(),await t.clearLoadedMembersIfNeeded();let n=t.roomId;i.store.removeRoom(n),i.emit("deleteRoom",n)}));u.push(m);let v=Promise.all(u).then((()=>{if(!t.rooms.peek)return;return be(this.mapSyncResponseToRoomArray(t.rooms.peek||{}),(async t=>{var n;!t.isBrandNewRoom&&"invite"===t.room.getMyMembership()&&t.timeline.prev_batch&&!(null!=(n=t.room.getLiveTimeline().getState("b"))&&n.paginationToken)&&t.room.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,"b"),await this.handleRoomUpdates(e,t)}))}));u.push(v),await Promise.all(u)}handlePeekUpdates(e){var t,n;Object.entries(e[Sn]||{}).forEach((([e,t])=>{this.client.store.storePeek(e,t)}));for(let n of Object.keys((null==(t=e.rooms)?void 0:t.leave)||{}))this.client.store.getRoomPeek(n)&&(this.client.store.storePeek(n),this.client.emit("unpeekRoom",n));for(let t of Object.keys((null==(n=e.rooms)?void 0:n.join)||{}))this.client.store.getRoomPeek(t)&&this.client.store.storePeek(t)}async handleHideUserContentEvents(e){var t,n,r,i,o,s,a,l,u,d,c,h;let m=[...Object.values((null==(t=e.rooms)?void 0:t.join)||{}),...Object.values((null==(n=e.rooms)?void 0:n.peek)||{}),...Object.values((null==(r=e.rooms)?void 0:r.leave)||{})],v=new Set;for(let e of m){for(let t of(null==(i=e.timeline)?void 0:i.events)||[])if("com.reddit.hide_user_content"===t.type){let e=t.content.remove&&t.content.target_user_id;e&&v.add(e)}else if("m.room.member"===t.type){let e=null==(s=null==(o=t.unsigned)?void 0:o["m.relations"])?void 0:s["com.reddit.hide_user_content"],n=t.state_key;null!=e&&e.remove&&n&&v.add(n)}for(let t of(null==(l=null==(a=e.timeline)?void 0:a.updates)?void 0:l.full)||[]){if("m.room.member"!==t.type)continue;let e=null==(d=null==(u=t.unsigned)?void 0:u["m.relations"])?void 0:d["com.reddit.hide_user_content"],n=t.state_key;null==e||!e.remove||!n||v.add(n)}}if(0!==v.size){for(let e of m)e.timeline.events&&(e.timeline.events=e.timeline.events.filter((e=>!Pe(e,v)))),null!=(h=null==(c=e.timeline)?void 0:c.updates)&&h.full&&(e.timeline.updates.full=e.timeline.updates.full.filter((e=>!Pe(e,v)))),e.state.events=e.state.events.filter((e=>!Pe(e,v)));await this.client.store.deleteUserData(Array.from(v))}}async handleRoomUpdates(e,t){var n,r,i,o,s,a,l,u,d,c,h,m,v,p,f,g,y,E;let b=this.client,_=t.room,R=this.mapSyncEventsFormat(t.state,_),T=this.mapSyncEventsFormat(t.timeline,_),S=e=>(null!=e.unsigned||(e.unsigned={}),e.unsigned[G]=!0,e),w=e=>!!t.room.findEventById(e.event_id)||t.room.getThreads().some((t=>t.id===e.event_id)),I=null==(i=null==(r=null==(n=t.timeline)?void 0:n.updates)?void 0:r.full)?void 0:i.filter(w).map(S),O=null==(a=null==(s=null==(o=t.timeline)?void 0:o.updates)?void 0:s.partial)?void 0:a.filter(w).map(S),M=I?this.mapSyncEventsFormat({events:I},_):[],P=O?this.mapSyncEventsFormat({events:O},_):[];T.push(...M,...P);let C=[...null!=(d=null==(u=null==(l=t.timeline)?void 0:l.updates)?void 0:u.full)?d:[],...null!=(m=null==(h=null==(c=t.timeline)?void 0:c.updates)?void 0:h.partial)?m:[]].filter((e=>"m.room.member"===e.type)).map(S);R.push(...this.mapSyncEventsFormat({events:C},_));let k=this.mapSyncEventsFormat(t.ephemeral),A=this.mapSyncEventsFormat(t.account_data);t.unread_notifications&&(_.setUnreadNotificationCount("total",null!=(v=t.unread_notifications.notification_count)?v:0),_.setUnreadNotificationCount("highlight",null!=(p=t.unread_notifications.highlight_count)?p:0),_.setIsUnreadCountedInGlobal(t.unread_notifications["com.reddit.is_counted_in_global_navigation_counter"]));let L=null!=(f=t[Rn.name])?f:t[Rn.altName];if(L){_.resetThreadUnreadNotificationCount(Object.keys(L));for(let[e,t]of Object.entries(L))_.setThreadUnreadNotificationCount(e,"total",null!=(g=t.notification_count)?g:0),_.setThreadUnreadNotificationCount(e,"highlight",null!=(y=t.highlight_count)?y:0)}else _.resetThreadUnreadNotificationCount();if(t.timeline=t.timeline||{},t.isBrandNewRoom)null!==t.timeline.prev_batch&&_.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,wt.BACKWARDS);else if(t.timeline.limited){let n=!0;for(let e=T.length-1;e>=0;e--){let t=T[e].getId();if(_.getTimelineForEvent(t)){An(`Already have event ${t} in limited sync - not resetting`),n=!1,T.splice(0,e);break}}n&&_.resetLiveTimeline(t.timeline.prev_batch,this.syncOpts.canResetEntireTimeline(_.roomId)?null:null!=(E=e.oldSyncToken)?E:null)}try{await this.injectRoomEvents(_,R,T,e.fromCache)}catch(e){De.error(`Failed to process events on room ${_.roomId}:`,e)}t.summary&&_.setSummary(t.summary),k.forEach((e=>e.event.room_id=_.roomId)),_.addEphemeralEvents(k),_.addAccountData(A),_.recalculate();let D=e=>b.emit("event",e);R.forEach(D),T.forEach(D),k.forEach(D),A.forEach(D),b.emit("Room.accountDataSynced",_)}mapSyncResponseToRoomArray(e){let t=this.client;return Object.keys(e).filter((e=>!Ie(e))).map((n=>{let r=t.store.getRoom(n),i=!1;return r||(r=this.createRoom(n),i=!0,t.store.storeRoom(r),t.emit("Room",r)),{...e[n],room:r,isBrandNewRoom:i}}))}mapSyncEventsFormat(e,t){if(!e||!Array.isArray(e.events))return[];let n=this.client.getEventMapper({});return e.events.filter(Oe).map((function(e){return t&&(e.room_id=t.roomId),n(e)}))}async injectRoomEvents(e,t,n,r=!1){let i=e.getLiveTimeline(),o=0==i.getEvents().length;if(o){for(let e of t)await this.client.getPushActionsForEvent(e);i.initialiseState(t)}e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),await e.addLiveEvents(n||[],{fromCache:r})}updateSyncState(e,t,n){let r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit("sync",this.syncState,r,t,n)}};Ln.failedSyncCount=0;var Dn=Ln;var Nn=class{constructor(){this.accountData=new Map,this.fromToken=null}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}async storeRoomEvents(e,t){}getRoomPeek(e){return null}storePeek(e,t){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}resetAllData(){return Promise.resolve()}deleteUserData(e){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}async getCurrentUser(){return Promise.resolve(void 0)}async storeCurrentUser(e){return Promise.resolve()}async getPendingEvents(e){return[]}setPendingEvents(e,t){return Promise.resolve()}async saveToDeviceBatches(e){return Promise.resolve()}getOldestToDeviceBatch(){return Promise.resolve(null)}async removeToDeviceBatch(e){return Promise.resolve()}async destroy(){}},xn=(e=>(e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce",e))(xn||{}),Un=(e=>(e.Highlight="highlight",e.Sound="sound",e.RedditSilent="com.reddit.silent",e))(Un||{}),jn=(e=>(e.ExactEquals="==",e.LessThan="<",e.GreaterThan=">",e.GreaterThanOrEqual=">=",e.LessThanOrEqual="<=",e))(jn||{}),Bn="2";function Fn(e){return"==2"===e||"2"===e}var $n,qn,Kn=((qn=Kn||{}).EventMatch="event_match",qn.EventPropertyIs="event_property_is",qn.EventPropertyContains="event_property_contains",qn.ContainsDisplayName="contains_display_name",qn.RoomMemberCount="room_member_count",qn.SenderNotificationPermission="sender_notification_permission",qn.CallStarted="call_started",qn.CallStartedPrefix="org.matrix.msc3914.call_started",qn),Wn=(e=>(e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride",e))(Wn||{}),Gn=(($n=Gn||{}).Master=".m.rule.master",$n.IsUserMention=".m.rule.is_user_mention",$n.IsRoomMention=".m.rule.is_room_mention",$n.ContainsDisplayName=".m.rule.contains_display_name",$n.ContainsUserName=".m.rule.contains_user_name",$n.AtRoomNotification=".m.rule.roomnotif",$n.DM=".m.rule.room_one_to_one",$n.EncryptedDM=".m.rule.encrypted_room_one_to_one",$n.Message=".m.rule.message",$n.EncryptedMessage=".m.rule.encrypted",$n.InviteToSelf=".m.rule.invite_for_me",$n.MemberEvent=".m.rule.member_event",$n.IncomingCall=".m.rule.call",$n.SuppressNotices=".m.rule.suppress_notices",$n.Tombstone=".m.rule.tombstone",$n.PollStart=".m.rule.poll_start",$n.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",$n.PollEnd=".m.rule.poll_end",$n.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",$n.PollStartOneToOne=".m.rule.poll_start_one_to_one",$n.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",$n.PollEndOneToOne=".m.rule.poll_end_one_to_one",$n.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",$n),Vn=["override","content","room","sender","underride"],Hn=[{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.reaction"}],actions:["dont_notify"]},{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.room.server_acl"},{kind:"event_match",key:"state_key",pattern:""}],actions:[]}],zn=[{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"org.matrix.msc3401.call"},{kind:"call_started"}],actions:["notify",{set_tweak:"sound",value:"default"}]}],Jn=class e{constructor(e){this.client=e,this.parsedKeys=new Map}static actionListToActionsObject(e){let t={notify:!1,tweaks:{}};for(let n of e)"notify"===n?t.notify=!0:"object"==typeof n&&(void 0===n.value&&(n.value=!0),t.tweaks[n.set_tweak]=n.value);return t}static rewriteDefaultRules(e,t=void 0){var n;let r=JSON.parse(JSON.stringify(e));r||(r={}),r.global||(r.global={}),r.global.override||(r.global.override=[]),r.global.underride||(r.global.underride=[]);let i=r.global.override;for(let e of Hn){let n,r=i.find((t=>t.rule_id===e.rule_id));if(".m.rule.is_user_mention"===e.rule_id){if(!t)continue;n=JSON.parse(JSON.stringify(e)),n.conditions[0].value=t}else n=e;if(r)r.default=n.default,r.conditions=n.conditions,r.actions=n.actions;else{let e=n.rule_id;De.warn(`Adding default global override for ${e}`),i.push(n)}}let o=null!=(n=r.global.underride)?n:[];for(let e of zn){let t=o.find((t=>t.rule_id===e.rule_id));if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{let t=e.rule_id;De.warn(`Adding default global underride for ${t}`),o.push(e)}}return r}updateCachedPushRuleKeys(t){t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]),t.global.room||(t.global.room=[]),t.global.sender||(t.global.sender=[]),t.global.underride||(t.global.underride=[]);let n=new Set(this.parsedKeys.keys());for(let r of[t.global.override,t.global.room,t.global.sender,t.global.underride])for(let t of r)if(t.conditions)for(let r of t.conditions)"event_match"===r.kind&&(n.delete(r.key),this.parsedKeys.set(r.key,e.partsForDottedKey(r.key)));n.forEach((e=>this.parsedKeys.delete(e)))}matchingRuleFromKindSet(e,t){for(let n of Vn){let r=t[n];if(r)for(let t of r){if(!t.enabled)continue;let r=this.templateRuleToRaw(n,t);if(r&&this.ruleMatchesEvent(r,e))return{...t,kind:n}}}return null}templateRuleToRaw(e,t){let n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":n.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;n.conditions.push({kind:"event_match",key:"room_id",value:t.rule_id});break;case"sender":if(!t.rule_id)return null;n.conditions.push({kind:"event_match",key:"user_id",value:t.rule_id});break;case"content":if(!t.pattern)return null;n.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return n}eventFulfillsCondition(e,t){switch(e.kind){case"event_match":return this.eventFulfillsEventMatchCondition(e,t);case"event_property_is":return this.eventFulfillsEventPropertyIsCondition(e,t);case"event_property_contains":return this.eventFulfillsEventPropertyContains(e,t);case"contains_display_name":return this.eventFulfillsDisplayNameCondition(e,t);case"room_member_count":return this.eventFulfillsRoomMemberCountCondition(e,t);case"sender_notification_permission":return this.eventFulfillsSenderNotifPermCondition(e,t);case"call_started":case"org.matrix.msc3914.call_started":return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){let n=e.key;if(!n)return!1;let r=this.client.getRoom(t.getRoomId());return!(null==r||!r.currentState)&&r.currentState.mayTriggerNotifOfType(n,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;let n=this.client.getRoom(t.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;let r=n.currentState.getJoinedMemberCount(),i=e.is.match(/^([=<>]*)(\d*)$/);if(!i)return!1;let o=i[1],s=parseInt(i[2]);if(isNaN(s))return!1;switch(o){case"":case"==":return r==s;case"<":return r<s;case">":return r>s;case"<=":return r<=s;case">=":return r>=s;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var n;let r=t.getContent();if(!r||!r.body||"string"!=typeof r.body)return!1;let i=this.client.getRoom(t.getRoomId()),o=null==(n=null==i?void 0:i.currentState)?void 0:n.getMember(this.client.credentials.userId);if(!o)return!1;let s=o.name,a=new RegExp("(^|\\W)"+fe(s)+"(\\W|$)","i");return r.body.search(a)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;let n=this.valueForDottedKey(e.key,t);if("string"!=typeof n)return!1;if(e.value)return e.value===n;if("string"!=typeof e.pattern)return!1;let r="content.body"===e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!n.match(r)}eventFulfillsEventPropertyIsCondition(e,t){return!(!e.key||void 0===e.value)&&e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||void 0===e.value)return!1;let n=this.valueForDottedKey(e.key,t);return!!Array.isArray(n)&&n.includes(e.value)}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||de(t.getPrevContent(),{}))}createCachedRegex(t,n,r){return e.cachedGlobToRegex[n]||(e.cachedGlobToRegex[n]=new RegExp(t+ge(n)+r,"i")),e.cachedGlobToRegex[n]}static partsForDottedKey(e){let t=[],n="",r=!1;for(let i of e)r?(n+="\\"===i||"."===i?i:"\\"+i,r=!1):"."==i?(t.push(n),n=""):"\\"==i?r=!0:n+=i;return r&&(n+="\\"),t.push(n),t}valueForDottedKey(t,n){let r=this.parsedKeys.get(t);void 0===r&&(r=e.partsForDottedKey(t),this.parsedKeys.set(t,r));let i,o=r[0],s=0;for("content"===o?(i=n.getContent(),++s):"type"===o?(i=n.getType(),++s):i=n.event;s<r.length;++s){if(null==i)return;i=i[r[s]]}return i}matchingRuleForEventWithRulesets(e,t){return t&&e.getSender()!==this.client.getSafeUserId()?this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(t,n){let r=this.matchingRuleForEventWithRulesets(t,n);if(!r)return{};let i=e.actionListToActionsObject(r.actions);return void 0===i.tweaks.highlight&&(i.tweaks.highlight="content"==r.kind),{actions:i,rule:r}}ruleMatchesEvent(e,t){var n;return!(null!=(n=e.conditions)&&n.some((e=>!this.eventFulfillsCondition(e,t))))}async actionsAndRuleForEvent(e){let t=await this.client.getPushRules();return this.pushActionsForEventAndRulesets(e,t)}async getPushRuleById(e){var t;let n=await this.getPushRuleAndKindById(e);return null!=(t=null==n?void 0:n.rule)?t:null}async getPushRuleAndKindById(e){let t=await this.client.getPushRules();for(let n of["global"])if(void 0!==(null==t?void 0:t[n]))for(let r of Vn)if(void 0!==t[n][r])for(let i of t[n][r]){let t=(new Date).getTime(),n=i["com.reddit.expiration_ts"],o=n&&n<t;if(i.rule_id===e&&!o)return{rule:i,kind:r}}return null}};Jn.cachedGlobToRegex={};var Yn=Jn,Qn={};function Xn(e){return{msgtype:"m.text",body:e}}function Zn(e){return{msgtype:"m.emote",body:e}}function er(e){if("function"==typeof Buffer)return Buffer.from(e).toString("base64");if("function"==typeof btoa&&e instanceof Uint8Array)return btoa(e.reduce(((e,t)=>e+String.fromCharCode(t)),""));throw new Error("No base64 impl found!")}function tr(e){return er(e).replace(/={1,2}$/,"")}function nr(e){return tr(e).replace("+","-").replace("/","_")}function rr(e){if("function"==typeof Buffer)return Buffer.from(e,"base64");if("function"==typeof atob){let t=function*(){let t=atob(e.replace("-","+").replace("_","/"));for(let e=0;e<t.length;++e)yield t.charCodeAt(e)};return Uint8Array.from(t())}throw new Error("No base64 impl found!")}a(Qn,{makeEmoteMessage:()=>Zn,makeTextMessage:()=>Xn});var ir;function or(e){return function(e,t){let n="";for(let r=0;r<e;++r)n+=t.charAt(Math.floor(Math.random()*t.length));return n}(e,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789")}null==(ir=globalThis.window)||ir.crypto;var sr,ar=class{constructor(e){this.client=e,this.sending=!1,this.running=!0,this.retryTimeout=null,this.retryAttempts=0,this.sendQueue=async()=>{if(null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.sending||!this.running)return;let e;De.debug("Attempting to send queued to-device messages"),this.sending=!0;try{for(;this.running&&(e=await this.client.store.getOldestToDeviceBatch(),null!==e);)await this.sendBatch(e),await this.client.store.removeToDeviceBatch(e.id),this.retryAttempts=0;if(!this.running)return;De.debug("All queued to-device messages sent")}catch(t){++this.retryAttempts;let n=bt.RETRY_BACKOFF_RATELIMIT(null,this.retryAttempts,t);if(-1===n)return void(4===Math.floor(t.httpStatus/100)?(De.error("Fatal error when sending to-device message - dropping to-device batch!",t),await this.client.store.removeToDeviceBatch(e.id)):De.info("Automatic retry limit reached for to-device messages."));De.info(`Failed to send batch of to-device messages. Will retry in ${n}ms`,t),this.retryTimeout=setTimeout(this.sendQueue,n)}finally{this.sending=!1}},this.onResumedSync=(e,t)=>{"SYNCING"===e&&"SYNCING"!==t&&(De.info("Resuming queue after resumed sync"),this.sendQueue())}}start(){this.running=!0,this.sendQueue(),this.client.on("sync",this.onResumedSync)}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener("sync",this.onResumedSync)}async queueBatch(e){let t=[];for(let n=0;n<e.batch.length;n+=20){let r={eventType:e.eventType,batch:e.batch.slice(n,n+20),txnId:this.client.makeTxnId()};t.push(r);let i=r.batch.map((e=>`${e.userId}/${e.deviceId} (msgid ${e.payload[Q]})`));De.info(`Enqueuing batch of to-device messages. type=${e.eventType} txnid=${r.txnId}`,i)}await this.client.store.saveToDeviceBatches(t),this.sendQueue()}async sendBatch(e){let t=new Me((()=>new Map));for(let n of e.batch)t.getOrCreate(n.userId).set(n.deviceId,n.payload);De.info(`Sending batch of ${e.batch.length} to-device messages with ID ${e.id} and txnId ${e.txnId}`),await this.client.sendToDevice(e.eventType,t,e.txnId)}},lr=l(N()),ur=new lr.UnstableValue("m.policies","org.matrix.msc3847.policies"),dr=new lr.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),cr=class{constructor(e){this.client=e}async addRule(e,t,n){let r=await this.getOrCreateTargetRoom();return(await this.client.sendStateEvent(r.roomId,e,{entity:t,reason:n,recommendation:"m.ban"})).event_id}async removeRule(e){await this.client.redactEvent(e.getRoomId(),e.getId())}async addSource(e){await this.client.joinRoom(e);let t=(await this.getOrCreateSourceRooms()).map((e=>e.roomId));return!t.includes(e)&&(t.push(e),await this.withIgnoreInvitesPolicies((e=>{e.sources=t})),!0)}async getRuleForInvite({sender:e,roomId:t}){let n=await this.getOrCreateSourceRooms(),r=e.split(":")[1],i=t.split(":")[1];for(let o of n){let n=o.getUnfilteredTimelineSet().getLiveTimeline().getState(wt.FORWARDS);for(let{scope:o,entities:s}of[{scope:"m.policy.room",entities:[t]},{scope:"m.policy.user",entities:[e]},{scope:"m.policy.server",entities:[r,i]}]){let e=n.getStateEvents(o);for(let t of e){let e=t.getContent();if("m.ban"!=(null==e?void 0:e.recommendation))continue;let n,r=null==e?void 0:e.entity;if(r){try{n=new RegExp(ge(r))}catch{continue}for(let e of s)if(e&&n.test(e))return t}}}}return null}async getOrCreateTargetRoom(){let e=this.getIgnoreInvitesPolicies().target;if("string"!=typeof e&&(e=null),e){let t=this.client.getRoom(e);if(t)return t;e=null}return e=(await this.client.createRoom({name:"Individual Policy Room",preset:"private_chat"})).room_id,await this.withIgnoreInvitesPolicies((t=>{t.target=e})),this.client.getRoom(e)}async getOrCreateSourceRooms(){let e=this.getIgnoreInvitesPolicies().sources,t=!1;Array.isArray(e)||(t=!0,e=[]);let n=e.filter((e=>"string"==typeof e)).map((e=>this.client.getRoom(e))).filter((e=>!!e));if(n.length!=e.length&&(t=!0),0==n.length){t=!0,n=[await this.getOrCreateTargetRoom()]}return t&&await this.withIgnoreInvitesPolicies((t=>{t.sources=e})),n}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}async withIgnoreInvitesPolicies(e){let{policies:t,ignoreInvitesPolicies:n}=this.getPoliciesAndIgnoreInvitesPolicies();e(n),t[dr.name]=n,await this.client.setAccountData(ur.name,t)}getPoliciesAndIgnoreInvitesPolicies(){var e;let t={};for(let n of[ur.name,ur.altName]){if(!n)continue;let r=null==(e=this.client.getAccountData(n))?void 0:e.getContent();if(r){t=r;break}}let n={},r=!1;for(let e of[dr.name,dr.altName]){if(!e)continue;let i=t[e];if(i&&"object"==typeof i){n=i,r=!0;break}}return r||(t[dr.name]=n),{policies:t,ignoreInvitesPolicies:n}}},hr=class extends Dn{constructor(){super(...arguments),this.isRequestRunning=!1,this.receivedData=new Uint8Array(0),this.unprocessedChunks=[]}async doSyncRequest(e,t){return this.isRequestRunning||this.startSyncRequest(e,t),this.unprocessedChunks.shift()||(this.activeChunkRequest||(this.activeChunkRequest=Ee()),this.activeChunkRequest.promise)}getSyncParams(e,t){let n=super.getSyncParams(e,this.lastReceivedSyncToken||t);return 0===n.timeout&&"SYNCING"!==this.getSyncState()&&(n.timeout=1),n}async startSyncRequest(e,t){var n,r;this.isRequestRunning=!0,this.receivedData=new Uint8Array(0);try{let i=this.getSyncParams(e,t),o={...i,streaming:!0},s=await this.client.http.authedRequest("GET","/sync",o,void 0,{localTimeoutMs:i.timeout+8e4,abortSignal:null==(n=this.abortController)?void 0:n.signal,onlyData:!1});if(!s.body)return;let a=s.body.getReader();for(;null==(r=this.abortController)||!r.signal.aborted;){let e=await a.read();if(e.done)break;let t=new Uint8Array(this.receivedData.length+e.value.length);t.set(this.receivedData,0),t.set(e.value,this.receivedData.length),this.receivedData=t,this.checkForSyncChunks()}}catch(e){e instanceof Error&&"TypeError"===e.name&&e.message.includes("input stream")?this.receivedData=new Uint8Array(0):this.activeChunkRequest&&(this.activeChunkRequest.reject(e),this.activeChunkRequest=void 0)}finally{this.isRequestRunning=!1}this.activeChunkRequest&&this.startSyncRequest(e,t)}checkForSyncChunks(){let e=null,t=0,n=[13,10];for(let r=0;r<=this.receivedData.length-n.length;r++)if(n.every(((e,t)=>this.receivedData.at(r+t)===e))){e=new Uint8Array(this.receivedData.buffer.slice(0,r)),t=r+n.length;break}if(!e)return;let r=new TextDecoder("utf-8"),i=parseInt(r.decode(e),16);if(i&&this.receivedData.length>=t+i){let e=new Uint8Array(this.receivedData.buffer.slice(t,t+i));this.receivedData=new Uint8Array(this.receivedData.buffer.slice(t+i+n.length)),this.addSyncChunk(JSON.parse(r.decode(e))),this.checkForSyncChunks()}}addSyncChunk(e){this.lastReceivedSyncToken=e.next_batch,this.activeChunkRequest?(this.activeChunkRequest.resolve(e),this.activeChunkRequest=void 0):this.unprocessedChunks.push(e)}},mr=new W("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),vr=(e=>(e.Chronological="chronological",e.Detached="detached",e))(vr||{}),pr=(e=>(e.Stable="stable",e.Unstable="unstable",e))(pr||{}),fr=new K("m.get_login_token","org.matrix.msc3882.get_login_token"),gr="$",yr=((sr=yr||{}).Sync="sync",sr.Event="event",sr.ToDeviceEvent="toDeviceEvent",sr.AccountData="accountData",sr.Room="Room",sr.DeleteRoom="deleteRoom",sr.UnpeekRoom="unpeekRoom",sr.SyncUnexpectedError="sync.unexpectedError",sr.PushRules="pushRules",sr.RestartSync="restartSync",sr.PolicyError="chat_policy_enforcement",sr),Er=class extends je{constructor(e){var t,n;super(),this.reEmitter=new Ot(this),this.clientRunning=!1,this.urlPreviewCache={},this.ongoingScrollbacks={},this.syncedLeftRooms=!1,this.pushProcessor=new Yn(this),this.txnCtr=0,this.pendingEventEncryption=new Map,this.reduceEventFetchingStrategy=void 0,this.fixupRoomNotifications=()=>{var e;if(this.isInitialSyncComplete()){let t=(null!=(e=this.getRooms())?e:[]).filter((e=>e.getUnreadNotificationCount("total")>0));for(let e of t){let t=this.getSafeUserId();e.fixupNotifications(t)}this.off("sync",this.fixupRoomNotifications)}},this.deferredFetchRoomEventMap=new Map,this.logger=null!=(t=e.logger)?t:De,e.baseUrl=null!=(n=e.baseUrl)&&n.endsWith("/")?n.slice(0,-1):n,this.baseUrl=e.baseUrl,this.store=e.store||new Nn,this.sessionId=or(10);let r=e.userId||null;this.credentials={userId:r},this.http=new Et(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:"/_matrix/client/v3",onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,logger:this.logger}),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((async e=>{let t=this.getRoom(e.getRoomId());"sending"!==e.status&&this.updatePendingEventStatus(t,e,"sending");let n=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,"sent",n.event_id),n})),this.on("sync",this.fixupRoomNotifications),this.toDeviceMessageQueue=new ar(this),this.ignoredInvites=new cr(this),this.setMaxListeners(0)}getUserCreator(){return e=>Rt.createUser(e,this)}set store(e){this._store=e,this._store.setUserCreator(this.getUserCreator())}get store(){return this._store}async startClient(e){if(this.clientRunning)return;this.clientRunning=!0;let t=this.getUserId();t&&this.store.storeUser(new Rt(t)),this.syncApi&&(this.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop()),this.clientOpts=null!=e?e:{},this.reduceEventFetchingStrategy=this.clientOpts.reduceEventFetchingStrategy,this.clientOpts.streamingSync?this.syncApi=new hr(this,this.clientOpts,this.buildSyncApiOptions()):this.syncApi=new Dn(this,this.clientOpts,this.buildSyncApiOptions()),this.syncApi.sync().catch((e=>this.logger.info("Sync startup aborted with an error:",e))),this.toDeviceMessageQueue.start()}buildSyncApiOptions(){return{canResetEntireTimeline:e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e)}}stopClient(){var e;this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,null==(e=this.syncApi)||e.stop(),this.syncApi=void 0,void 0!==this.clientWellKnownIntervalID&&window.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop())}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");let e=[];return e.push(this.store.deleteAllData()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){let e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getSyncState(){var e,t;return null!=(t=null==(e=this.syncApi)?void 0:e.getSyncState())?t:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){let e=this.getSyncState();return!!e&&("PREPARED"===e||"SYNCING"===e)}getRoomList(e){let{include:t,membership:n,...r}=e,i=r,o=Object.keys(t||{}).join(",");o&&(i.include=o);let s=Object.keys(n||{}).join(",");return s&&(i.membership=s),this.http.authedRequest("GET","/rooms",i,void 0,{prefix:"/_matrix/client/v3"})}async storeInactiveRoom(e){if(this.getRoom(e.room_id))return;if(!this.syncApi)throw new Error("syncApi is not available. The inactive room cannot be stored.");let t=this.syncApi.createRoom(e.room_id),n=this.getEventMapper({}),r=e=>e.filter(Oe).map((e=>(t&&(e.room_id=t.roomId),n(e)))),i=r(e.state||[]),o=r(e.chunk||[]);if(i){let e=t.getLiveTimeline();for(let e of i)await this.getPushActionsForEvent(e);e.initialiseState(i),t.recalculate()}e.chunk&&(await t.addLiveEvents(o),e.end&&t.getLiveTimeline().setPaginationToken(e.end,wt.BACKWARDS)),this.store.storeRoom(t),this.emit("Room",t);for(let e of[...i,...o])this.emit("event",e)}getMediaConfig(){return this.http.authedRequest("GET","/config",void 0,void 0,{prefix:"/_matrix/media/v3"})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){let n=ae("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return st(5,(()=>this.http.authedRequest("PUT",n,void 0,t)))}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){var t;if(this.isInitialSyncComplete()){let t=this.store.getAccountData(e);return t?t.getContent():null}let n=ae("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest("GET",n)}catch(e){if("M_NOT_FOUND"===(null==(t=e.data)?void 0:t.errcode))return null;throw e}}async joinRoom(e,t={}){void 0===t.syncRoom&&(t.syncRoom=!0);let n=this.getRoom(e);if(null!=n&&n.hasMembershipState(this.credentials.userId,"join"))return n;let r={};t.viaServers&&(r.server_name=t.viaServers);let i=ae("/join/$roomid",{$roomid:e}),o=(await this.http.authedRequest("POST",i,r,{})).room_id,s=this.getRoom(o);if(null!=s&&s.hasMembershipState(this.credentials.userId,"join"))return s;let a=new Dn(this,this.clientOpts,this.buildSyncApiOptions()).createRoom(o);return t.syncRoom,a}cancelPendingEvent(e){if(!["queued","not_sent","encrypting"].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);"encrypting"===e.status?this.pendingEventEncryption.delete(e.getId()):this.scheduler&&"queued"===e.status&&this.scheduler.removeEventFromQueue(e);let t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,"cancelled")}setRoomName(e,t){return this.sendStateEvent(e,"m.room.name",{name:t})}setRoomAccountData(e,t,n){let r=ae("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest("PUT",r,void 0,n)}async setPowerLevel(e,t,n){var r,i,o;let s;if(this.clientRunning&&this.isInitialSyncComplete()&&(s=null==(o=null==(i=null==(r=this.getRoom(e))?void 0:r.currentState)?void 0:i.getStateEvents("m.room.power_levels",""))?void 0:o.getContent()),!s)try{s=await this.getStateEvent(e,"m.room.power_levels","")}catch(e){if(!(e instanceof Xe&&"M_NOT_FOUND"===e.errcode))throw e;s={}}s=ue(s),null!=s&&s.users||(s.users={});let a=Array.isArray(t)?t:[t];for(let e of a)null==n?delete s.users[e]:s.users[e]=n;return this.sendStateEvent(e,"m.room.power_levels",s,"")}sendEvent(e,t,n,r,i){var o,s,a,l,u;let d,c,h,m;if(null!=t&&t.startsWith(gr)||null===t?(m=i,h=r,c=n,d=t):(m=r,h=n,c=t,d=null),d&&(null==(o=h["m.relates_to"])||!o.rel_type)){let t=!(null==(s=h["m.relates_to"])||!s["m.in_reply_to"]);h["m.relates_to"]={...h["m.relates_to"],rel_type:Nt.name,event_id:d,is_falling_back:!t};let n=null==(a=this.getRoom(e))?void 0:a.getThread(d);n&&!t&&(h["m.relates_to"]["m.in_reply_to"]={event_id:null!=(u=null==(l=n.lastReply((e=>e.isRelation(Nt.name)&&!e.status)))?void 0:l.getId())?u:d})}return this.sendCompleteEvent(e,d,{type:c,content:h},m)}sendCompleteEvent(e,t,n,r){r||(r=this.makeTxnId());let i=new Bt(Object.assign(n,{event_id:"~"+e+":"+r,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),o=this.getRoom(e),s=t?null==o?void 0:o.getThread(t):void 0;s&&i.setThread(s),this.reEmitter.reEmit(i,["Event.replaced","Event.visibilityChange"]),null==o||o.reEmitter.reEmit(i,["Event.beforeRedaction"]);let a=i.getAssociatedId();if(null!=a&&a.startsWith("~")){let e=null==o?void 0:o.getPendingEvents().find((e=>e.getId()===a));null==e||e.once("Event.localEventIdReplaced",(()=>{i.updateAssociatedId(e.getId())}))}let l=i.getType();return this.logger.debug(`sendEvent of type ${l} in ${e} with txnId ${r}`),i.setTxnId(r),i.setStatus("sending"),null==o||o.addPendingEvent(i,r),s&&s.updateLocalEvent(i),"not_sent"===i.status?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(o,i)}encryptAndSendEvent(e,t){return Promise.resolve().then((()=>{let n=null;return this.scheduler&&(n=this.scheduler.queueEvent(t),n&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,"queued")),n||(n=this.sendEventHttpRequest(t),e&&(n=n.then((n=>(e.updatePendingEvent(t,"sent",n.event_id),n))))),n})).catch((n=>{this.logger.error("Error sending event",n.stack||n);try{t.error=n,this.updatePendingEventStatus(e,t,"not_sent")}catch(e){this.logger.error("Exception in error handler!",e.stack||n)}throw n instanceof Xe&&(n.event=t),n}))}updatePendingEventStatus(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));let n,r={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),n=ae(t,r)}else n=e.isRedaction()?ae("/rooms/$roomId/redact/$redactsEventId/$txnId",{$redactsEventId:e.event.redacts,...r}):ae("/rooms/$roomId/send/$eventType/$txnId",r);return this.http.authedRequest("PUT",n,void 0,e.getWireContent()).then((t=>(this.logger.debug(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t)))}sendUrlPreview(e,t,n){let r=ae("/rooms/$roomId/send/com.reddit.url_preview",{$roomId:e});return this.http.authedRequest("POST",r,void 0,{url:n,"m.relates_to":{event_id:t,rel_type:"com.reddit.url_preview"}}).then((t=>(this.logger.debug(`Event sent to ${e} with event id ${t.event_id}`),t)))}redactEvent(e,t,n,r,i){null!=n&&n.startsWith(gr)||(i=r,r=n,n=t,t=null);let o={reason:null==i?void 0:i.reason};if(void 0!==(null==i?void 0:i.with_rel_types))throw new Error(`Server does not support relation based redactions roomId ${e} eventId ${n} txnId: ${r} threadId ${t}`);return this.sendCompleteEvent(e,t,{type:"m.room.redaction",content:o,redacts:n},r)}sendMessage(e,t,n,r){"string"!=typeof t&&null!==t&&(r=n,n=t,t=null);let i=n;return this.sendEvent(e,t,"m.room.message",i,r)}sendTextMessage(e,t,n,r){(null==t||!t.startsWith(gr))&&null!==t&&(r=n,n=t,t=null);let i=Xn(n);return this.sendMessage(e,t,i,r)}sendEmoteMessage(e,t,n,r){(null==t||!t.startsWith(gr))&&null!==t&&(r=n,n=t,t=null);let i=Zn(n);return this.sendMessage(e,t,i,r)}sendImageMessage(e,t,n,r,i="Image"){(null==t||!t.startsWith(gr))&&null!==t&&(i=r||"Image",r=n,n=t,t=null);let o={msgtype:"m.image",url:n,info:r,body:i};return this.sendMessage(e,t,o)}sendStickerMessage(e,t,n,r,i="Sticker",o){(null==t||!t.startsWith(gr))&&null!==t&&(i=r||"Sticker",r=n,n=t,t=null);let s={url:n,info:r,body:i};return this.sendEvent(e,t,"m.sticker",s,o)}async sendReceipt(e,t,n,r=!1,i){let o=ae("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),s=r?n:{...n,thread_id:i||br(e)},a=this.http.authedRequest("POST",o,void 0,s||{}),l=this.getRoom(e.getRoomId());return l&&this.credentials.userId&&l.addLocalEchoReceipt(this.credentials.userId,e,t,r),a}async sendReadReceipt(e,t="m.read",n=!1,r){if(!e)return;let i=e.getId(),o=this.getRoom(e.getRoomId());if(null!=o&&o.hasPendingEvent(i))throw new Error(`Cannot set read receipt to a pending event (${i})`);return this.sendReceipt(e,t,{},n,r)}getUrlPreview(e){let t=new URL(e);if(t.hash="",(e=t.toString())in this.urlPreviewCache)return this.urlPreviewCache[e];let n=this.http.authedRequest("GET","/preview_url/",{url:e},void 0,{prefix:"/_matrix/media/v3",priority:"low"});return this.urlPreviewCache[e]=n,n}sendTyping(e,t,n){let r=ae("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),i={typing:t};return t&&(i.timeout=n||2e4),this.http.authedRequest("PUT",r,void 0,i)}invite(e,t,n){return this.membershipChange(e,t,"invite",n)}leave(e){return this.membershipChange(e,void 0,"leave")}ban(e,t,n){return this.membershipChange(e,t,"ban",n)}unban(e,t){let n=ae("/rooms/$roomId/unban",{$roomId:e}),r={user_id:t};return this.http.authedRequest("POST",n,void 0,r)}kick(e,t,n){let r=ae("/rooms/$roomId/kick",{$roomId:e}),i={user_id:t,reason:n};return this.http.authedRequest("POST",r,void 0,i)}membershipChange(e,t,n,r){let i=ae("/rooms/$room_id/$membership",{$room_id:e,$membership:n});return this.http.authedRequest("POST",i,void 0,{user_id:t,reason:r})}async getPushActionsForEvent(e){if(!e.getPushActions()){let{actions:t,rule:n}=await this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,n)}return e.getPushActions()}async getPushDetailsForEvent(e,t=!1){if(!e.getPushDetails()||t){let{actions:t,rule:n}=await this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,n)}return e.getPushDetails()}mxcUrlToHttp(e,t,n,r,i){return Ce(this.baseUrl,e,t,n,r,i)}getEventMapper(e){return function(e,t){let n=!!t.preventReEmit;return function r(i){t.toDevice&&delete i.room_id;let o,s=e.getRoom(i.room_id);s&&void 0===i.state_key&&(o=s.findEventById(i.event_id)),!o||o.status?o=new Bt(i):(o.setUnsigned({...o.getUnsigned(),...i.unsigned}),n=!0);let a=o.getServerAggregatedRelation("m.replace");if(null!=a&&a.content){let e=r(a);o.makeReplaced(e)}let l=null==s?void 0:s.findThreadForEvent(o);return l&&o.setThread(l),n||(e.reEmitter.reEmit(o,["Event.replaced","Event.visibilityChange"]),null==s||s.reEmitter.reEmit(o,["Event.beforeRedaction"])),o}}(this,e||{})}async getEventTimeline(e,t){var n,r,i,o;if(null==e||!e.room)throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread)return this.getThreadTimeline(e,t);let s,a=ae("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),l=yn(null==(n=this.clientOpts)?void 0:n.filter);l&&(s={filter:l});let u=await this.http.authedRequest("GET",a,s);if(!u.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);let d=this.getEventMapper(),c=d(u.event);if(c.isRelation(Nt.name))return void this.logger.warn("Tried loading a regular timeline at the position of a thread event");let h=[...u.events_after.reverse().map(d),c,...u.events_before.map(d)],m=e.getTimelineForEvent(h[0].getId());m?m.getState(wt.BACKWARDS).setUnknownStateEvents(u.state.map(d)):(m=e.addTimeline(),m.initialiseState(u.state.map(d)),m.getState(wt.FORWARDS).paginationToken=u.end);let[v,p,f]=e.room.partitionThreadedEvents(h);return e.addEventsToTimeline(v,!0,m,u.start),f.forEach((t=>e.relations.aggregateChildEvent(t))),null!=(o=null!=(i=e.getTimelineForEvent(t))?i:null==(r=e.room.findThreadForEvent(c))?void 0:r.liveTimeline)?o:m}async getThreadTimeline(e,t){var n,r,i,o;if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");let s=ae("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),a={limit:"0"},l=yn(null==(n=this.clientOpts)?void 0:n.filter);l&&(a.filter=l);let u=await this.http.authedRequest("GET",s,a),d=this.getEventMapper(),c=d(u.event);if(!e.canContain(c))return;let h=e.thread,m=await this.fetchRelations(e.room.roomId,h.id,Nt.name,null,{dir:"b",from:u.start,recurse:void 0}),v=[],p=u.end;for(;p;){let t=await this.fetchRelations(e.room.roomId,h.id,Nt.name,null,{dir:"f",from:p,recurse:void 0});p=null!=(r=t.next_batch)?r:null,v.push(...t.chunk)}let f=[...v.reverse().map(d),c,...m.chunk.map(d)];for(let t of f)await(null==(i=e.thread)?void 0:i.processEvent(t));let g=e.getLiveTimeline();if(g.getState(wt.BACKWARDS).setUnknownStateEvents(u.state.map(d)),e.addEventsToTimeline(f,!0,g,null),!m.next_batch){let t=await this.fetchRoomEvent(e.room.roomId,h.id);e.addEventsToTimeline([d(t)],!0,g,null)}return g.setPaginationToken(null!=(o=m.next_batch)?o:null,"b"),g.setPaginationToken(null,"f"),g}async getLatestTimeline(e){var t,n,r;if(!e.room)throw new Error("getLatestTimeline only supports room timelines");let i;if(e.thread)i=null==(t=(await this.fetchRelations(e.room.roomId,e.thread.id,Nt.name,null,{dir:"b",limit:1,recurse:void 0})).chunk)?void 0:t[0];else{let t=ae("/rooms/$roomId/messages",{$roomId:e.room.roomId}),o={dir:"b"},s=yn(null==(n=this.clientOpts)?void 0:n.filter);s&&(o.filter=s),i=null==(r=(await this.http.authedRequest("GET",t,o)).chunk)?void 0:r[0]}if(!i)throw new Error("No message returned when trying to construct getLatestTimeline");return this.getEventTimeline(e,i.event_id)}createMessagesRequest(e,t,n=30,r){var i;let o=ae("/rooms/$roomId/messages",{$roomId:e}),s={limit:n.toString(),dir:r};t&&(s.from=t);let a=En(null==(i=this.clientOpts)?void 0:i.filter);return a&&(s.filter=a),this.http.authedRequest("GET",o,s)}paginateEventTimeline(e,t){var n,r;let i,o=this.getRoom(e.getRoomId()),s=e.getTimelineSet().thread,a=(t=t||{}).backwards||!1,l=a?wt.BACKWARDS:wt.FORWARDS,u=e.getPaginationToken(l),d=e.paginationRequests[l];if(d)return d;if(s){let o=this.getRoom(null!=(n=e.getRoomId())?n:void 0);if(!o)throw new Error("Unknown room "+e.getRoomId());i=this.fetchRelations(null!=(r=e.getRoomId())?r:"",s.id,Nt.name,null,{dir:l,limit:t.limit,from:null!=u?u:void 0,recurse:void 0}).then((async t=>{var n;let r=this.getEventMapper(),i=t.chunk.filter(Oe).map(r);for(let e of i.slice().reverse()){await(null==s?void 0:s.processEvent(e));let t=e.getSender();(!a||null===(null==s?void 0:s.getEventReadUpTo(t)))&&o.addLocalEchoReceipt(t,e,"m.read")}let u=t.next_batch,d=e.getTimelineSet();if(d.addEventsToTimeline(i,a,e,null!=u?u:null),!u&&a&&"v2"!==this.reduceEventFetchingStrategy){let t=await this.fetchRoomEvent(null!=(n=e.getRoomId())?n:"",s.id);d.addEventsToTimeline([r(t)],!0,e,null)}return a&&!u&&e.setPaginationToken(null,l),!!u})).finally((()=>{e.paginationRequests[l]=null})),e.paginationRequests[l]=i}else{if(!o)throw new Error("Unknown room "+e.getRoomId());i=this.createMessagesRequest(e.getRoomId(),u,t.limit,l).then((t=>(this.applyMessages(o,e,l,t),!(void 0===t.end||t.end===t.start)))).catch((t=>{throw"M_INVALID_ARGUMENT_VALUE"===t.errcode&&t.message.includes("Invalid from parameter: token")&&e.setPaginationToken(null,l),t})).finally((()=>{e.paginationRequests[l]=null})),e.paginationRequests[l]=i}return i}applyMessages(e,t,n,r){var i,o,s,a,l,u;if(r.state){let e=t.getState(n),i=r.state.filter(Oe).map(this.getEventMapper());e.setUnknownStateEvents(i)}let d=r.end,c=(r.chunk||[]).filter(Oe).map(this.getEventMapper()),h=t.getTimelineSet(),[m,,v]=e.partitionThreadedEvents(c);h.addEventsToTimeline(m,"b"===n,t,d),v.forEach((t=>e.relations.aggregateChildEvent(t)));let p=null!=(s=null==(o=null==(i=r.updates)?void 0:i.full)?void 0:o.filter(Oe))?s:[],f=null!=(u=null==(l=null==(a=r.updates)?void 0:a.partial)?void 0:l.filter(Oe))?u:[],g=p.concat(f).filter((t=>!!e.findEventById(t.event_id))).map(this.getEventMapper());e.addLiveEvents(g),this.store.storeRoomEvents(e.roomId,r);let y=void 0===r.end||r.end===r.start;"b"===n&&y&&t.setPaginationToken(null,n)}async peekInRoom(e,{stateSupport:t=!1}={}){var n;let r=ae(t?"/peek/$roomid?state=true":"/peek/$roomid",{$roomid:e}),i=await this.http.authedRequest("POST",r),o=i.room_id;this.store.storePeek(o,{peek_start_ts:Date.now(),peek_expiry_ts:i.peek_expiry_ts});let s=this.getRoom(o);if(s||(s=new Dn(this,this.clientOpts,this.buildSyncApiOptions()).createRoom(o),this.store.storeRoom(s),this.emit("Room",s)),(e=>!!e.start)(i)){let e=s.getLiveTimeline(),t=(i.state||[]).filter(Oe).map(this.getEventMapper());null==(n=e.getState("f"))||n.setUnknownStateEvents(t),e.setPaginationToken(i.end||null,"b"),this.applyMessages(s,e,"b",i),s.recalculate()}return s}async unpeekRoom(e){if(!this.isRoomPeeked(e))return;let t=ae("/rooms/$roomid/unpeek",{$roomid:e});await this.http.authedRequest("POST",t)}isRoomPeeked(e){let t=this.store.getRoomPeek(e);return!!(t&&t.peek_expiry_ts>Date.now())}async getRoomPushRule(e,t){var n,r;return null==(r=null==(n=(await this.getPushRules())[e])?void 0:n.room)?void 0:r.find((e=>e.rule_id===t))}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return null!=(e=this.http.opts.refreshToken)?e:null}setAccessToken(e){this.http.opts.accessToken=e}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}login(e,t){return this.http.authedRequest("POST","/login",void 0,{...t,type:e}).then((e=>(e.access_token&&e.user_id&&(this.http.opts.accessToken=e.access_token,this.credentials={userId:e.user_id}),e)))}async createRoom(e){return this.http.authedRequest("POST","/createRoom",void 0,e)}fetchRelations(e,t,n,r,i={dir:"b"}){let o=se(i),s="/rooms/$roomId/relations/$eventId";null!==n?(s+="/$relationType",null!==r&&(s+="/$eventType")):null!==r&&(this.logger.warn(`eventType: ${r} ignored when fetching\n            relations as relationType is null`),r=null);let a=ae(s+"?"+o,{$roomId:e,$eventId:t,$relationType:n,$eventType:r});return this.http.authedRequest("GET",a,void 0,void 0,{prefix:"/_matrix/client/v1"})}fetchRoomEvent(e,t){let n=ae("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t}),r=this.deferredFetchRoomEventMap.get(n);return r||(r=this.http.authedRequest("GET",n).then((e=>(this.deferredFetchRoomEventMap.delete(n),e))).catch((e=>{throw this.deferredFetchRoomEventMap.delete(n),e})),this.deferredFetchRoomEventMap.set(n,r)),r}members(e,t,n,r){let i={};t&&(i.membership=t),n&&(i.not_membership=n),r&&(i.at=r);let o=ae("/rooms/$roomId/members?"+se(i),{$roomId:e});return this.http.authedRequest("GET",o)}getStateEvent(e,t,n){let r={$roomId:e,$eventType:t,$stateKey:n},i=ae("/rooms/$roomId/state/$eventType",r);return void 0!==n&&(i=ae(i+"/$stateKey",r)),this.http.authedRequest("GET",i)}sendStateEvent(e,t,n,r="",i={}){let o={$roomId:e,$eventType:t,$stateKey:r},s=ae("/rooms/$roomId/state/$eventType",o);return void 0!==r&&(s=ae(s+"/$stateKey",o)),this.http.authedRequest("PUT",s,void 0,n,i)}searchUserDirectory({term:e,limit:t}){let n={search_term:e};return void 0!==t&&(n.limit=t),this.http.authedRequest("POST","/user_directory/search",void 0,n)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){let n=t?ae("/profile/$userId/$info",{$userId:e,$info:t}):ae("/profile/$userId",{$userId:e});return this.http.authedRequest("GET",n)}async getPushRules(){return this.pushRules?this.pushRules:(this.fetchPushRulesPromise||(this.fetchPushRulesPromise=this.fetchPushRules(),this.fetchPushRulesPromise.finally((()=>{this.fetchPushRulesPromise=void 0}))),await this.fetchPushRulesPromise,this.getPushRules())}async getPushRuleById(e){return this.pushProcessor.getPushRuleById(e)}async fetchPushRules(){let e=await this.http.authedRequest("GET","/pushrules/");this.setPushRules(e)}setPushRules(e){this.pushRules=Yn.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules),this.emit("pushRules",this.pushRules)}addPushRule(e,t,n,r){let i=ae("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest("PUT",i,void 0,r)}deletePushRule(e,t,n){let r=ae("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this.http.authedRequest("DELETE",r)}sendToDevice(e,t,n){let r=ae("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),i={messages:we(t)},o=new Map;for(let[e,n]of t)o.set(e,Array.from(n.keys()));return this.logger.debug(`PUT ${r}`,o),this.http.authedRequest("PUT",r,void 0,i)}reportEvent(e,t,n,r){let i=ae("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest("POST",i,void 0,{score:n,reason:r})}async whoami(){return this.http.authedRequest("GET","/account/whoami")}};function br(e){return _r(e)?q:e.threadRootId}function _r(e){return!(e.threadRootId&&!e.isThreadRoot)||(e.isRelation()?!e.isRelation(Nt.name)&&e.relationEventId===e.threadRootId:(De.warn(`Event is not a relation or a thread root, but still has a threadRootId! id=${e.getId()}`),!0))}var Rr=class{constructor(){this.unthreadedReadReceipts=new Map,this.threadedReadReceipts=new Me((()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,n){this.threadedReadReceipts.getOrCreate(e).set(t,n)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(let e of this.threadedReadReceipts.values())for(let t of e.entries())yield t}consumeEphemeralEvents(e){null==e||e.forEach((e=>{"m.receipt"!==e.type||!e.content||Object.keys(e.content).forEach((t=>{Object.entries(e.content[t]).forEach((([n,r])=>{if(Te(n))for(let i of Object.keys(r)){let r=e.content[t][n][i],o={data:e.content[t][n][i],type:n,eventId:t};r.thread_id?this.setThreaded(r.thread_id,i,o):this.setUnthreaded(i,o)}}))}))}))}buildAccumulatedReceiptEvent(e){let t={type:"m.receipt",room_id:e,content:{}},n=new Me((()=>new Me((()=>new Map))));for(let[e,t]of this.allUnthreaded())n.getOrCreate(t.eventId).getOrCreate(t.type).set(e,t.data);for(let[e,t]of this.allThreaded())n.getOrCreate(t.eventId).getOrCreate(t.type).set(e,t.data);return t.content=we(n),n.size>0?t:null}};var Tr=class{constructor(e={}){this.accountData={},this.inviteRooms={},this.joinRooms={},this.peekRooms={},this.syncRedditData={},this.nextBatch=null,this.opts={maxTimelineEntries:250,...e}}accumulate(e,t=!1){this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch,this.syncRedditData[Sn]=e[Sn],[wn,In,On,Mn,Pn].forEach((t=>{let n=e[t];void 0!==n&&Number.isFinite(n)&&(this.syncRedditData[t]=n)})),e[Cn]&&(this.syncRedditData[Cn]=e[Cn])}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach((e=>{this.accountData[e.type]=e}))}accumulateRooms(e,t=!1){if(e.rooms)for(let n of["invite","join","leave","peek","inactive"]){let r=e.rooms[n];r&&Object.keys(r).forEach((e=>{this.accumulateRoom(e,n,r[e],t)}))}}async accumulateRoomEvents(e,t){var n,r;let i=this.joinRooms[e]||this.peekRooms[e];if(i&&(null==(n=i._timeline[0])?void 0:n.token)===t.start&&!(i._timeline.length>=this.opts.maxTimelineEntries))for(let e=t.chunk.length-1;e>=0;e--){let n=t.chunk[e],o=Object.assign({},n);void 0!==o.unsigned&&(o.unsigned=Object.assign({},o.unsigned));let s=n.unsigned?n.unsigned.age:n.age;void 0!==s&&(o._localTs=Date.now()-s),i._timeline.unshift({event:o,token:0===e&&null!=(r=t.end)?r:null})}}accumulateRoom(e,t,n,r=!1){switch(t){case"invite":this.accumulateInviteState(e,n);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this.peekRooms[e]&&(this.joinRooms[e]=this.peekRooms[e],delete this.peekRooms[e]),this.joinRooms[e]||(this.joinRooms[e]=this.getEmptyRoom()),this.accumulateJoinState(this.joinRooms[e],n,r);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e],this.peekRooms[e]&&delete this.peekRooms[e];break;case"peek":this.peekRooms[e]||(this.peekRooms[e]=this.getEmptyRoom()),this.accumulateJoinState(this.peekRooms[e],n,r);break;case"inactive":delete this.inviteRooms[e],delete this.joinRooms[e],delete this.peekRooms[e];break;default:De.error("Unknown category: ",t)}}accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});let n=this.inviteRooms[e];t.invite_state.events.forEach((e=>{let t=!1;for(let r=0;r<n.invite_state.events.length;r++){let i=n.invite_state.events[r];i.type===e.type&&i.state_key==e.state_key&&(n.invite_state.events[r]=e,t=!0)}t||n.invite_state.events.push(e)}))}accumulateJoinState(e,t,n=!1){var r,i,o,s,a,l,u,d,c,h,m,v,p;if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((t=>{e._accountData[t.type]=t})),t.unread_notifications&&(e._unreadNotifications=t.unread_notifications),e._unreadThreadNotifications=null!=(i=null!=(r=t[Rn.stable])?r:t[Rn.unstable])?i:void 0,t.summary){let n="m.heroes",r="m.invited_member_count",i="m.joined_member_count",l=e._summary,u=t.summary;l[n]=null!=(o=u[n])?o:l[n],l[i]=null!=(s=u[i])?s:l[i],l[r]=null!=(a=u[r])?a:l[r]}if(e._receipts.consumeEphemeralEvents(null==(l=t.ephemeral)?void 0:l.events),t.timeline&&t.timeline.limited&&(e._timeline=[]),null==(d=null==(u=t.state)?void 0:u.events)||d.forEach((t=>{Sr(e._currentState,t)})),null==(h=null==(c=t.timeline)?void 0:c.events)||h.forEach(((r,i)=>{var o;let s;if(Sr(e._currentState,r),n)s=r;else{s=Object.assign({},r),void 0!==s.unsigned&&(s.unsigned=Object.assign({},s.unsigned));let e=r.unsigned?r.unsigned.age:r.age;void 0!==e&&(s._localTs=Date.now()-e)}e._timeline.push({event:s,token:0===i&&null!=(o=t.timeline.prev_batch)?o:null})})),null==(p=null==(v=null==(m=t.timeline)?void 0:m.updates)?void 0:v.full)||p.forEach((t=>{e._timeline.push({event:t,token:null})})),e._timeline.length>this.opts.maxTimelineEntries){for(let t=e._timeline.length-this.opts.maxTimelineEntries;t<e._timeline.length;t++)if(e._timeline[t].token){e._timeline=e._timeline.slice(t,e._timeline.length);break}}}getEmptyRoom(){return{_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new Rr}}getJSON(e=!1){let t={join:{},invite:{},peek:{},leave:{}};Object.keys(this.inviteRooms).forEach((e=>{t.invite[e]=this.inviteRooms[e]})),Object.keys(this.joinRooms).forEach((n=>{t.join[n]=this.roomToJSON(n,this.joinRooms[n],e)})),Object.keys(this.peekRooms).forEach((n=>{t.peek[n]=this.roomToJSON(n,this.peekRooms[n],e)}));let n=[];return Object.keys(this.accountData).forEach((e=>{n.push(this.accountData[e])})),{...this.syncRedditData,nextBatch:this.nextBatch,roomsData:t,accountData:n}}roomToJSON(e,t,n=!1){let r={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:t._unreadNotifications,unread_thread_notifications:t._unreadThreadNotifications,summary:t._summary};Object.keys(t._accountData).forEach((e=>{r.account_data.events.push(t._accountData[e])}));let i=t._receipts.buildAccumulatedReceiptEvent(e);i&&r.ephemeral.events.push(i),t._timeline.forEach((e=>{if(!r.timeline.prev_batch){if(!e.token)return;r.timeline.prev_batch=e.token}let t;var i;!n&&("_localTs"in(i=e.event)&&void 0!==i._localTs)?(t=Object.assign({},e.event),void 0!==t.unsigned&&(t.unsigned=Object.assign({},t.unsigned)),delete t._localTs,t.unsigned=t.unsigned||{},t.unsigned.age=Date.now()-e.event._localTs):t=e.event,r.timeline.events.push(t)}));let o=Object.create(null);for(let e=r.timeline.events.length-1;e>=0;e--){let t=r.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;let n=ue(t);n.unsigned&&(n.unsigned.prev_content&&(n.content=n.unsigned.prev_content),n.unsigned.prev_sender&&(n.sender=n.unsigned.prev_sender)),Sr(o,n)}return Object.keys(t._currentState).forEach((e=>{Object.keys(t._currentState[e]).forEach((n=>{let i=t._currentState[e][n];o[e]&&o[e][n]&&(i=o[e][n]),r.state.events.push(i)}))})),r}getNextBatchToken(){return this.nextBatch}};function Sr(e,t){null===t.state_key||void 0===t.state_key||!t.type||(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}var wr=(e=>(e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified",e))(wr||{}),Ir=class{constructor(e){this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||0,this.signatures=e.signatures||new Map,this.displayName=e.displayName}getFingerprint(){return this.keys.get(`ed25519:${this.deviceId}`)}getIdentityKey(){return this.keys.get(`curve25519:${this.deviceId}`)}},Or=class{constructor(e,t,n={}){var r;this.client=e,this.timelineSet=t,this.eventCount=0,this.windowLimit=n.windowLimit||1e3,null==(r=t.room)||r.on("Room.timeline",this.onTimelineEvent.bind(this))}load(e,t=20){let n=n=>{if(!n)throw new Error("No timeline given to initFields");let r,i=n.getEvents();if(e){if(r=i.findIndex((t=>t.getId()===e)),r<0)throw new Error("getEventTimeline result didn't include requested event")}else r=i.length;let o=Math.min(i.length,r+Math.ceil(t/2)),s=Math.max(0,o-t);this.start=new Mr(n,s-n.getBaseIndex()),this.end=new Mr(n,o-n.getBaseIndex()),this.eventCount=o-s};return this.timelineSet.getTimelineForEvent(e)?(n(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(n):(n(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){var t,n;if(e==wt.BACKWARDS)return null!=(t=this.start)?t:null;if(e==wt.FORWARDS)return null!=(n=this.end)?n:null;throw new Error("Invalid direction '"+e+"'")}extend(e,t){let n=this.getTimelineIndex(e);if(!n)return!1;let r=e==wt.BACKWARDS?n.retreat(t):n.advance(t);if(r){this.eventCount+=r,this.eventCount;let t=this.eventCount-this.windowLimit;return t>0&&this.unpaginate(t,e!=wt.BACKWARDS),!0}return!1}onTimelineEvent(e,t,n,r){r&&this.onEventRemoved()}onEventRemoved(){let e=this.getEvents();e.length>0&&void 0===e[e.length-1]&&this.end&&this.end.index--}canPaginate(e){let t=this.getTimelineIndex(e);if(!t)return!1;if(e==wt.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;let n=t.timeline.getNeighbouringTimeline(e),r=t.timeline.getPaginationToken(e);return!!n||!!r}async paginate(e,t,n=!0,r=10){let i=this.getTimelineIndex(e);if(!i)return!1;if(i.pendingPaginate)return i.pendingPaginate;if(this.extend(e,t))return!0;if(!n||0===r)return!1;if(!i.timeline.getPaginationToken(e))return!1;let o=this.client.paginateEventTimeline(i.timeline,{backwards:e==wt.BACKWARDS,limit:t}).finally((()=>{i.pendingPaginate=void 0})).then((n=>n?this.paginate(e,t,!0,r-1):this.paginate(e,t,!1,0)));return i.pendingPaginate=o,o}unpaginate(e,t){let n=t?this.start:this.end;if(!n)throw new Error(`Attempting to unpaginate startOfTimeline=${t} but don't have this direction`);if(e>this.eventCount||e<0)throw new Error(`Attemting to unpaginate ${e} events, but only have ${this.eventCount} in the timeline`);for(;e>0;){let r=t?n.advance(e):n.retreat(e);if(r<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=r,this.eventCount-=r,this.eventCount}}getEvents(){var e,t;if(!this.start)return[];let n=[],r=this.start.timeline;for(;r;){let i=r.getEvents(),o=0,s=i.length;r===this.start.timeline&&(o=this.start.index+r.getBaseIndex()),r===(null==(e=this.end)?void 0:e.timeline)&&(s=this.end.index+r.getBaseIndex());for(let e=o;e<s;e++)n.push(i[e]);if(r===(null==(t=this.end)?void 0:t.timeline))break;r=r.getNeighbouringTimeline(wt.FORWARDS)}return n.filter((e=>!!e))}},Mr=class{constructor(e,t){this.timeline=e,this.index=t}minIndex(){return-1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;let n=this.timeline.getNeighbouringTimeline(e<0?wt.BACKWARDS:wt.FORWARDS);return n?(this.timeline=n,this.index=e<0?this.maxIndex():this.minIndex(),this.advance(e)):0}retreat(e){return-1*this.advance(-1*e)}},Pr=(e=>(e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM",e))(Pr||{});var Cr=[e=>{e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]}),e.createObjectStore("current_user",{keyPath:["clobber"]})},e=>{e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")},e=>{e.createObjectStore("client_options",{keyPath:["clobber"]})},e=>{e.createObjectStore("to_device_queue",{autoIncrement:!0})}],kr=Cr.length;function Ar(e,t,n){let r=e.openCursor(t);return new Promise(((e,t)=>{let i=[];r.onerror=()=>{t(new Error("Query failed: "+r.error))},r.onsuccess=()=>{let t=r.result;t?(i.push(n(t)),t.continue()):e(i)}}))}function Lr(e){return new Promise(((t,n)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function Dr(e){return new Promise(((t,n)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){n(e.error)}}))}function Nr(e){return new Promise(((t,n)=>{e.onsuccess=()=>t(e),e.onerror=e=>n(e)}))}function xr(e){return Dr(e).then((t=>e.result))}var Ur=class{constructor(e,t="default"){this.indexedDB=e,this.disconnected=!0,this._isNewlyCreated=!1,this.pendingUserPresenceData=[],this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new Tr}static exists(e,t){return function(e,t){return new Promise(((n,r)=>{let i=!0,o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>r(o.error),o.onsuccess=()=>{o.result.close(),i||e.deleteDatabase(t),n(i)},o.onerror=()=>r(o.error)}))}(e,t="matrix-js-sdk:"+(t||"default"))}connect(e){if(!this.disconnected)return De.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,De.log("LocalIndexedDBStoreBackend.connect: connecting...");let t=this.indexedDB.open(this.dbName,kr);return t.onupgradeneeded=e=>{let n=t.result,r=e.oldVersion;De.log(`LocalIndexedDBStoreBackend.connect: upgrading from ${r}`),r<1&&(this._isNewlyCreated=!0),Cr.forEach(((e,t)=>{r<=t&&e(n)}))},t.onblocked=()=>{De.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},De.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),Dr(t).then((async()=>{De.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=t.result,this.db.onversionchange=e=>{var t;e.newVersion&&(null==(t=this.db)||t.close(),this.disconnected=!0,this.db=void 0)},this.db.onclose=()=>{this.disconnected=!0,this.db=void 0,null==e||e()},await this.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then((([e,t])=>{De.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,[Sn]:t[Sn],[wn]:t[wn],[In]:t[In],[On]:t[On],[Mn]:t[Mn],[Pn]:t[Pn],[Cn]:t[Cn],account_data:{events:e}},!0)}))}getOutOfBandMembers(e){return new Promise(((t,n)=>{let r=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),o=r.openCursor(i),s=[],a=!1;o.onsuccess=()=>{let e=o.result;if(!e)return s.length||a?t(s):t(null);let n=e.value;n.oob_written?a=!0:s.push(n),e.continue()},o.onerror=e=>{n(e)}})).then((t=>(De.log(`LL: got ${null==t?void 0:t.length} membershipEvents from storage for room ${e} ...`),t)))}async setOutOfBandMembers(e,t){De.log(`LL: backend about to store ${t.length} members for ${e}`);let n=this.db.transaction(["oob_membership_events"],"readwrite"),r=n.objectStore("oob_membership_events");t.forEach((e=>{r.put(e)}));let i={room_id:e,oob_written:!0,state_key:0};r.put(i),await Lr(n),De.log(`LL: backend done storing for ${e}!`)}async clearOutOfBandMembers(e){let t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),n=IDBKeyRange.only(e),r=xr(t.openKeyCursor(n,"next")).then((e=>(null==e?void 0:e.primaryKey)[1])),i=xr(t.openKeyCursor(n,"prev")).then((e=>(null==e?void 0:e.primaryKey)[1])),[o,s]=await Promise.all([r,i]),a=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),l=IDBKeyRange.bound([e,o],[e,s]);De.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,o],[e,s]),await Nr(a.delete(l))}async resetDatabase(){let e=this.db;if(!e)throw new Error("Cannot reset database: not connected");await new Promise(((t,n)=>{let r=e.transaction(e.objectStoreNames,"readwrite"),i=new Set(["client_options"]);for(let t of e.objectStoreNames)i.has(t)||r.objectStore(t).clear();r.oncomplete=()=>{t()},r.onerror=()=>n(r.error)})),this.syncAccumulator=new Tr}clearDatabase(){return new Promise((e=>{var t;De.log(`Removing indexeddb instance: ${this.dbName}`),null==(t=this.db)||t.close();let n=this.indexedDB.deleteDatabase(this.dbName);n.onblocked=()=>{De.log(`can't yet delete indexeddb ${this.dbName} because it is open elsewhere`)},n.onerror=()=>{De.warn(`unable to delete js-sdk store indexeddb: ${n.error}`),e()},n.onsuccess=()=>{De.log(`Removed indexeddb instance: ${this.dbName}`),e()}}))}async deleteAllUserEvents(e){var t,n,r,i;let o=await this.getSavedSync();if(!o)return!1;let s=[...Object.values((null==(t=o.roomsData)?void 0:t.join)||{}),...Object.values((null==(n=o.roomsData)?void 0:n.peek)||{}),...Object.values((null==(r=o.roomsData)?void 0:r.leave)||{})],a=new Set(e),l=!1;for(let e of s)e.timeline.events=e.timeline.events.filter((e=>{let t=Pe(e,a);return l||(l=t),!t})),null!=(i=e.timeline.updates)&&i.full&&(e.timeline.updates.full=e.timeline.updates.full.filter((e=>{let t=Pe(e,a);return l||(l=t),!t}))),e.state.events=e.state.events.filter((e=>{let t=Pe(e,a);return l||(l=t),!t}));return!!l&&(await this.persistSyncData(o),!0)}async deleteUserData(e){(await Promise.all([this.deleteUserIdFromAccountData(e),this.deleteUserPresenceEvents(e),this.deleteAllUserEvents(e)])).some(Boolean)&&(this.syncAccumulator=new Tr,await this.init())}getSavedSync(e=!0){let t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(ue(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then((()=>{this.syncAccumulator.accumulate(e)}))}async syncToDatabase(e){return this.syncToDatabasePromise?(De.warn("Skipping syncToDatabase() as persist already in flight"),this.pendingUserPresenceData.push(...e),this.syncToDatabasePromise):(e.unshift(...this.pendingUserPresenceData),this.syncToDatabasePromise=this.doSyncToDatabase(e),this.syncToDatabasePromise)}async doSyncToDatabase(e){try{let t=this.syncAccumulator.getJSON(!0);this.dedupJoinedRoomsSyncData(t.roomsData),await Promise.all([this.persistUserPresenceEvents(e),this.persistAccountData(t.accountData),this.persistSyncData(t)])}finally{this.syncToDatabasePromise=void 0}}dedupJoinedRoomsSyncData(e){Object.values(e.join).forEach((e=>{let t=new Map;e.timeline.events.forEach((e=>{t.set(e.event_id,e)}));let n=Array.from(t.values());e.timeline.events=n}))}persistSyncData({nextBatch:e,roomsData:t,[Sn]:n,[wn]:r,[In]:i,[On]:o,[Mn]:s,[Pn]:a,[Cn]:l}){return De.log("Persisting sync data up to",e),_e((()=>{let u=this.db.transaction(["sync"],"readwrite");return u.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,[Sn]:n,[wn]:r,[In]:i,[On]:o,[Mn]:s,[Pn]:a,[Cn]:l}),Lr(u).then((()=>{De.log("Persisted sync data up to",e)}))}))}persistAccountData(e){return _e((()=>{let t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(let t of e)n.put(t);return Lr(t).then()}))}async deleteUserIdFromAccountData(e){return _e((async()=>{let t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData"),r=(await Nr(n.get(["m.direct"]))).result;if(!r)return!1;let i=!1;for(let t of e)r.content[t]&&(i=!0,delete r.content[t]);return i&&n.put(r),await Lr(t),i}))}persistUserPresenceEvents(e){return _e((()=>{let t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(let t of e)n.put({userId:t[0],event:t[1]});return Lr(t).then()}))}getUserPresenceEvents(){return _e((()=>Ar(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,(e=>[e.value.userId,e.value.event]))))}deleteUserPresenceEvents(e){return _e((async()=>{let t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(let t of e)n.delete([t]);return await Lr(t),!1}))}loadAccountData(){return De.log("LocalIndexedDBStoreBackend: loading account data..."),_e((()=>Ar(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,(e=>e.value)).then((e=>(De.log("LocalIndexedDBStoreBackend: loaded account data"),e)))))}loadSyncData(){return De.log("LocalIndexedDBStoreBackend: loading sync data..."),_e((()=>Ar(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,(e=>e.value)).then((e=>(De.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&De.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))))}getClientOptions(){return Promise.resolve().then((()=>Ar(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,(e=>{var t;return null==(t=e.value)?void 0:t.options})).then((e=>e[0]))))}async storeClientOptions(e){let t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await Lr(t)}getCurrentUser(){return Promise.resolve().then((()=>Ar(this.db.transaction(["current_user"],"readonly").objectStore("current_user"),void 0,(e=>e.value)).then((e=>{var t;return null==(t=e[0])?void 0:t.userId}))))}async storeCurrentUser(e){let t=this.db.transaction(["current_user"],"readwrite");t.objectStore("current_user").put({clobber:"-",userId:e}),await Lr(t)}async storeRoomEvents(e,t){await Promise.resolve(),await this.syncAccumulator.accumulateRoomEvents(e,t)}async saveToDeviceBatches(e){let t=this.db.transaction(["to_device_queue"],"readwrite"),n=t.objectStore("to_device_queue");for(let t of e)n.add(t);await Lr(t)}async getOldestToDeviceBatch(){let e=this.db.transaction(["to_device_queue"],"readonly").objectStore("to_device_queue"),t=await xr(e.openCursor());if(!t)return null;let n=t.value;return{id:t.key,txnId:n.txnId,eventType:n.eventType,batch:n.batch}}async removeToDeviceBatch(e){let t=this.db.transaction(["to_device_queue"],"readwrite");t.objectStore("to_device_queue").delete(e),await Lr(t)}async destroy(){var e;null==(e=this.db)||e.close()}},jr=class{constructor(e,t,n){this.workerFactory=e,this.dbName=t,this.onWorkerError=n,this.nextSeq=0,this.inFlight={},this.onWorkerMessage=e=>{var t;let n=e.data;if("closed"==n.command)null==(t=this.onClose)||t.call(this);else if("cmd_success"==n.command||"cmd_fail"==n.command){if(void 0===n.seq)return void De.error("Got reply from worker with no seq");let e=this.inFlight[n.seq];if(void 0===e)return void De.error("Got reply for unknown seq "+n.seq);if(delete this.inFlight[n.seq],"cmd_success"==n.command)e.resolve(n.result);else{let t=new Error(n.error.message);t.name=n.error.name,e.reject(t)}}else De.warn("Unrecognised message from worker: ",n)}}connect(e){return this.onClose=e,this.ensureStarted().then((()=>this.doCmd("connect")))}clearDatabase(){return this.ensureStarted().then((()=>this.doCmd("clearDatabase")))}resetDatabase(){return this.ensureStarted().then((()=>this.doCmd("resetDatabase")))}async deleteUserData(e){await this.ensureStarted(),await this.doCmd("deleteUserData",[e])}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getCurrentUser(){return this.doCmd("getCurrentUser")}async storeCurrentUser(e){return this.doCmd("storeCurrentUser",[e])}async storeRoomEvents(e,t){return this.doCmd("storeRoomEvents",[e,t])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}async saveToDeviceBatches(e){return this.doCmd("saveToDeviceBatches",[e])}async getOldestToDeviceBatch(){return this.doCmd("getOldestToDeviceBatch")}async removeToDeviceBatch(e){return this.doCmd("removeToDeviceBatch",[e])}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.onWorkerError&&(this.worker.onerror=this.onWorkerError),this.startPromise=this.doCmd("setupWorker",[this.dbName]).then((()=>{De.log("IndexedDB worker is ready")}))),this.startPromise}doCmd(e,t){return Promise.resolve().then((()=>{var n;let r=this.nextSeq++,i=Ee();return this.inFlight[r]=i,null==(n=this.worker)||n.postMessage({command:e,seq:r,args:t}),i.promise}))}async destroy(){var e;null==(e=this.worker)||e.terminate()}},Br=class extends Ye{constructor(e){var t;super(e),this.startedUp=!1,this.syncTs=0,this.userModifiedMap={},this.emitter=new je,this.on=this.emitter.on.bind(this.emitter),this.onClose=()=>{this.emitter.emit("closed")},this.getSavedSync=this.degradable((()=>this.backend.getSavedSync()),"getSavedSync"),this.isNewlyCreated=this.degradable((()=>this.backend.isNewlyCreated()),"isNewlyCreated"),this.getSavedSyncToken=this.degradable((()=>this.backend.getNextBatchToken()),"getSavedSyncToken"),this.deleteAllData=this.degradable((()=>(super.deleteAllData(),this.backend.clearDatabase().then((()=>{De.log("Deleted indexeddb data.")}),(e=>{throw De.error(`Failed to delete indexeddb data: ${e}`),e}))))),this.reallySave=this.degradable((()=>{this.syncTs=Date.now();let e=[];for(let t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)})),this.setSyncData=this.degradable((async e=>{await this.backend.setSyncData(e),this.save()}),"setSyncData"),this.getCurrentUser=this.degradable((()=>this.backend.getCurrentUser())),this.storeCurrentUser=this.degradable((e=>(super.storeCurrentUser(e),this.backend.storeCurrentUser(e))),"storeCurrentUser"),this.storeRoomEvents=this.degradable((async(e,t)=>{await this.backend.storeRoomEvents(e,t),this.save()}),"storeRoomEvents"),this.getOutOfBandMembers=this.degradable((e=>this.backend.getOutOfBandMembers(e)),"getOutOfBandMembers"),this.setOutOfBandMembers=this.degradable(((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t))),"setOutOfBandMembers"),this.clearOutOfBandMembers=this.degradable((e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e))),"clearOutOfBandMembers"),this.getClientOptions=this.degradable((()=>this.backend.getClientOptions()),"getClientOptions"),this.storeClientOptions=this.degradable((e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e))),"storeClientOptions"),e.workerFactory?this.backend=new jr(e.workerFactory,e.dbName,e.onWorkerError):this.backend=new Ur(null!=(t=e.indexedDB)?t:globalThis.indexedDB,e.dbName)}static exists(e,t){return Ur.exists(e,t)}startup(){return this.startedUp?(De.log("IndexedDBStore.startup: already started"),Promise.resolve()):(De.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then((()=>(De.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents()))).then((e=>{De.log("IndexedDBStore.startup: processing presence events"),e.forEach((([e,t])=>{if(!this.createUser)throw new Error("createUser is undefined, it should be set with setUserCreator()!");let n=this.createUser(e);t&&n.setPresenceEvent(new Bt(t)),this.userModifiedMap[n.userId]=n.getLastModifiedTime(),this.storeUser(n)})),this.startedUp=!0})))}destroy(){return this.backend.destroy()}resetAllData(){return super.resetAllData(),this.backend.resetDatabase().then((()=>{De.log("Reset indexeddb data.")}),(e=>{throw De.error(`Failed to reset indexeddb data: ${e}`),e}))}async deleteUserData(e){return await super.deleteUserData(e),this.backend.deleteUserData(e).then((()=>{De.log(`Deleted indexeddb data for user ${e}`)}),(t=>{throw De.error(`Failed to delete indexeddb data for user ${e}: ${t}`),t}))}async save(e=!1){if(window.clearTimeout(this.debouncedSaveTimerId),e||Date.now()-this.syncTs>3e4)return this.reallySave();this.debouncedSaveTimerId=window.setTimeout((()=>{this.reallySave()}),1e4)}degradable(e,t){let n=t?super[t]:null;return async(...t)=>{try{return await e.call(this,...t)}catch(e){De.error("IndexedDBStore failure, degrading to MemoryStore",e),this.emitter.emit("degraded",e);try{De.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),De.log("IndexedDBStore delete after degrading succeeded")}catch(e){De.warn("IndexedDBStore delete after degrading failed",e)}if(n)return n.call(this,...t)}}}async getPendingEvents(e){if(!this.localStorage)return super.getPendingEvents(e);let t=this.localStorage.getItem(Fr(e));if(t)try{return JSON.parse(t)}catch(e){De.error("Could not parse persisted pending events",e)}return[]}async setPendingEvents(e,t){if(!this.localStorage)return super.setPendingEvents(e,t);t.length>0?this.localStorage.setItem(Fr(e),JSON.stringify(t)):this.localStorage.removeItem(Fr(e))}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}};function Fr(e){return`mx_pending_events_${e}`}var $r=l(N());var qr=new $r.UnstableValue("m.message","org.matrix.msc1767.message"),Kr=new $r.UnstableValue("m.text","org.matrix.msc1767.text"),Wr=new $r.UnstableValue("m.html","org.matrix.msc1767.html"),Gr=new $r.NamespacedValue("m.reference");function Vr(e,t){if("string"==typeof e)return"string"==typeof t?t===e:t.matches(e);if("string"==typeof t)return e.matches(t);{let n=t,r=e;return n.matches(r.name)||function(e){return null!=e}(r.altName)&&n.matches(r.altName)}}var Hr=(e=>(e.Global="Global",e.SetItemError="setItem",e.GetItemError="getItem",e.RemoveItemError="removeItem",e.ClearError="clear",e.QuotaExceededError="QuotaExceededError",e))(Hr||{});function zr(e){var t,n;return e.store=null!=(t=e.store)?t:new Ye({localStorage:window.localStorage}),e.scheduler=null!=(n=e.scheduler)?n:new bt,e}function Jr(e){return new Er(zr(e))}if(new class extends je{},globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");return globalThis.__js_sdk_entrypoint=!0,globalThis.matrixcs=x,{get Category(){return Tn},get ClientEvent(){return yr},get ClientPrefix(){return ut},get ConditionKind(){return Kn},get ConditionOperator(){return jn},get ConnectionError(){return Ze},get ContentHelpers(){return Qn},get DEFAULT_FILTER(){return bn},get DEFAULT_FILTER_WITHOUT_NOT_AGGREGATED_RELATIONS(){return _n},get DMMemberCountCondition(){return Bn},get Device(){return Ir},get DeviceVerification(){return wr},get Direction(){return Tt},get DuplicateStrategy(){return Gt},get EVENT_VISIBILITY_CHANGE_TYPE(){return Z},get EventEmitterEvents(){return Ue},get EventRedeliveredKey(){return G},get EventStatus(){return xt},get EventTimeline(){return wt},get EventTimelineSet(){return Vt},get EventType(){return V},get FeatureSupport(){return Lt},get GET_LOGIN_TOKEN_CAPABILITY(){return fr},get GLOBAL_COUNTER_KEY(){return wn},get HTTPError(){return Qe},get HttpApiEvent(){return et},get INVITES_COUNTER_KEY(){return In},get IdentityPrefix(){return dt},get IndexedDBStore(){return Br},get JoinRule(){return Ge},get KNOWN_SAFE_ROOM_VERSION(){return ln},get LOCAL_NOTIFICATION_SETTINGS_PREFIX(){return ne},get LocalStorageErrors(){return Hr},get MAIN_ROOM_TIMELINE(){return q},get MAIN_TIMELINE_COUNTER_KEY(){return Pn},get M_HTML(){return Wr},get M_MESSAGE(){return qr},get M_TEXT(){return Kr},get MatrixClient(){return Er},get MatrixError(){return Xe},get MatrixEvent(){return Bt},get MatrixEventEvent(){return jt},get MatrixHttpApi(){return Et},get MatrixScheduler(){return bt},get MediaPrefix(){return ct},get MemoryStore(){return Ye},get Method(){return yt},get MsgType(){return z},get NotificationCountType(){return dn},get PEEK_KEY(){return Sn},get PUSHER_DEVICE_ID(){return te},get PUSHER_ENABLED(){return ee},get PendingEventOrdering(){return vr},get PowerLevelActions(){return He},get Preset(){return We},get PushRuleActionName(){return xn},get PushRuleKind(){return Wn},get REFERENCE_RELATION(){return Gr},get ReceiptType(){return $},get RelationType(){return H},get Relations(){return Kt},get RelationsEvent(){return qt},get RestrictedAllowType(){return Ve},get Room(){return hn},get RoomCreateTypeField(){return J},get RoomEvent(){return cn},get RoomMember(){return Fe},get RoomMemberEvent(){return Be},get RoomNameType(){return vn},get RoomState(){return Je},get RoomStateEvent(){return ze},get RoomSummary(){return Ht},get RoomType(){return Y},get RoomVersionStability(){return pr},get RuleId(){return Gn},get SERVICE_TYPES(){return Pr},get SPAM_INVITES_COUNTER_KEY(){return On},get SyncAccumulator(){return Tr},get SyncState(){return kn},get THREADS_COUNTER_KEY(){return Mn},get THREAD_RELATION_TYPE(){return Nt},get Thread(){return Dt},get ThreadEvent(){return At},get TimelineIndex(){return Mr},get TimelineWindow(){return Or},get ToDeviceMessageId(){return Q},get TweakName(){return Un},get TypedEventEmitter(){return je},get UNREAD_THREAD_NOTIFICATIONS(){return Rn},get UNSIGNED_THREAD_ID_FIELD(){return re},get UNSTABLE_ELEMENT_FUNCTIONAL_USERS(){return X},get UNSTABLE_MSC3852_LAST_SEEN_UA(){return mr},get User(){return Rt},get UserEvent(){return _t},get Visibility(){return Ke},get W3_REPORTING_LABEL_KEY(){return Cn},amendClientOpts:zr,anySignal:rt,createClient:Jr,decodeBase64:rr,encodeBase64:er,encodeUnpaddedBase64:tr,encodeUnpaddedBase64Url:nr,getHttpUriForMxc:Ce,getSerializedMessagesFilter:yn,getSerializedSyncFilter:gn,getSerializedTimelineFilter:En,getSyncFilter:fn,inMainTimelineForReceipt:_r,isDmMemberCountCondition:Fn,isEventTypeSame:Vr,parseErrorResponse:it,retryNetworkOperation:st,threadIdForReceipt:br,timeoutSignal:nt}}));

SML.di("./Dw4vb8Yfbm.js",import.meta.url,"Dw4vb8Yfbm");SML.di("./5r73EsgItq.js",import.meta.url,"5r73EsgItq");SML.di("./CPSOeCrm6v.js",import.meta.url,"CPSOeCrm6v");SML.di("./C3-eAP6Oln.js",import.meta.url,"C3-eAP6Oln");
SML.dm("CO-yX3kl_0",["Dw4vb8Yfbm","5r73EsgItq","CPSOeCrm6v","C3-eAP6Oln"],(async(e,t,s,i)=>{let o=class extends t.s{constructor(){super(...arguments),this.isVisible=!1,this.handleScroll=e=>{const t=e.target.scrollTop;this.isVisible=t>60}}connectedCallback(){super.connectedCallback();const e=this.closest('[slot="pdp-panel"]');e?.addEventListener("scroll",this.handleScroll)}disconnectedCallback(){super.disconnectedCallback();const e=this.closest('[slot="pdp-panel"]');e?.removeEventListener("scroll",this.handleScroll)}render(){return this.isVisible?t.x`<div class="bg-neutral-background z-2 flex justify-end absolute right-md shadow-md p-2xs rounded-full mt-sm"> <slot name="pagination"></slot> <slot name="close"></slot> </div>`:t.A}};o.styles=[e.t],e._([e.h()],o.prototype,"isVisible",void 0),o=e._([e.e("mod-queue-pdp-floating-ctas")],o);let a=class extends t.s{constructor(){super(...arguments),this.isSetup=!1,this.hasPrevious=!1,this.hasNext=!1,this.feedData=[],this.currentIndex=-1,this.setup=()=>{const e=Array.from(document.querySelectorAll("[slot=mod-queue-feed] mod-queue-list-item, [slot=mod-queue-feed] shreddit-post, [slot=mod-queue-feed] shreddit-profile-comment")).map((e=>e.getAttribute("comment-id")||e.getAttribute("id"))).filter(Boolean);e.length>0&&(this.feedData=e,this.currentIndex=this.feedData.findIndex((e=>e===this.thingId)),this.hasPrevious=this.currentIndex>0,this.hasNext=this.currentIndex+1<this.feedData.length,this.isSetup=!0)},this.handlePreviousBtnClick=()=>{const e=this.feedData[this.currentIndex-1],t=document.querySelector(`[slot=mod-queue-feed] mod-queue-list-item[id="${e}"] a[slot=full-post-link], [slot=mod-queue-feed] shreddit-post[id="${e}"] a[slot=full-post-link], [slot=mod-queue-feed] shreddit-profile-comment[comment-id="${e}"] *`);t?.click()},this.handleNextBtnClick=()=>{const e=this.feedData[this.currentIndex+1],t=document.querySelector(`[slot=mod-queue-feed] mod-queue-list-item[id="${e}"] a[slot=full-post-link], [slot=mod-queue-feed] shreddit-post[id="${e}"] a[slot=full-post-link], [slot=mod-queue-feed] shreddit-profile-comment[comment-id="${e}"] *`);t?.click()}}connectedCallback(){super.connectedCallback(),this.setup()}render(){return this.isSetup?t.x`<div class="flex"> ${e.o({appearance:"plain",attributes:{type:"button","aria-label":"Previous post",disabled:!this.hasPrevious,onclick:this.handlePreviousBtnClick},leadingIcon:s.c({size:t.I.Small}),size:e.q.Small})} ${e.o({appearance:"plain",attributes:{type:"button","data-label":"pdp-post-close","aria-label":"Next post",disabled:!this.hasNext,onclick:this.handleNextBtnClick},leadingIcon:i.c({size:t.I.Small}),size:e.q.Small})} </div>`:t.A;}};a.styles=[e.t],e._([e.n({type:String,attribute:"thing-id"})],a.prototype,"thingId",void 0),e._([e.h()],a.prototype,"isSetup",void 0),e._([e.h()],a.prototype,"hasPrevious",void 0),e._([e.h()],a.prototype,"hasNext",void 0),e._([e.h()],a.prototype,"feedData",void 0),e._([e.h()],a.prototype,"currentIndex",void 0),a=e._([e.e("mod-queue-pdp-pagination-buttons")],a)}));
SML.di("./Dw4vb8Yfbm.js",import.meta.url,"Dw4vb8Yfbm");SML.di("./CK4gRenw1f.js",import.meta.url,"CK4gRenw1f");SML.di("./5r73EsgItq.js",import.meta.url,"5r73EsgItq");SML.di("./CwJMtJ-bLN.js",import.meta.url,"CwJMtJ-bLN");SML.di("./C17omQ_RhR.js",import.meta.url,"C17omQ_RhR");SML.di("./Dh8G_lEIvS.js",import.meta.url,"Dh8G_lEIvS");
SML.dm("Cv9IgiePU4",["Dw4vb8Yfbm","CK4gRenw1f","5r73EsgItq","CwJMtJ-bLN","C17omQ_RhR","Dh8G_lEIvS"],(async(t,e,r)=>{let i=class extends r.s{constructor(){super(...arguments),this.subredditName="",this.userName="",this.thingId="",this.subredditId="",this.userId="",this.forceOpen=!1,this.postId="",this.conversationId="",this.isUserDeleted=!1,this.triggerSource=e.a.USERNAME,this.openModNotes=async e=>{const{subredditName:r,userName:i,thingId:s,subredditId:o,userId:d,triggerSource:n,postId:p}=this,u=e??n;t.p(t.T.ModNotesRailOpen,{subredditName:r,userName:this.isUserDeleted?"deleted":i,thingId:s,subredditId:o,userId:this.isUserDeleted?"deleted":d,triggerSource:u,postId:p,conversationId:this.conversationId})},this.handleAnchorClick=t=>{t instanceof MouseEvent&&0!==t.button||t.ctrlKey||t.metaKey||(t.preventDefault(),this.openModNotes())},this.preventAnchorClick=t=>{const e=t.target;if(e instanceof HTMLSlotElement){e.assignedElements().forEach((t=>{(t instanceof HTMLAnchorElement||this.forceOpen||this.isUserDeleted)&&(t.onclick=this.handleAnchorClick,t.ontouchstart=this.handleAnchorClick)}))}}}render(){return this.isUserDeleted||this.subredditName&&this.subredditId&&this.userName&&this.userId?r.x` <slot @slotchange="${this.preventAnchorClick}"></slot> `:r.x`<slot></slot>`}};return t._([t.n({type:String,attribute:"subreddit-name"})],i.prototype,"subredditName",void 0),t._([t.n({type:String,attribute:"user-name"})],i.prototype,"userName",void 0),t._([t.n({type:String,attribute:"thing-id"})],i.prototype,"thingId",void 0),t._([t.n({type:String,attribute:"subreddit-id"})],i.prototype,"subredditId",void 0),t._([t.n({type:String,attribute:"user-id"})],i.prototype,"userId",void 0),t._([t.n({type:Boolean,attribute:"force-open"})],i.prototype,"forceOpen",void 0),t._([t.n({type:String,attribute:"post-id"})],i.prototype,"postId",void 0),t._([t.n({type:String,attribute:"conversation-id"})],i.prototype,"conversationId",void 0),t._([t.n({type:Boolean,attribute:"is-user-deleted"})],i.prototype,"isUserDeleted",void 0),t._([t.n({type:String,attribute:"trigger-source"})],i.prototype,"triggerSource",void 0),i=t._([t.e("mod-notes-opener")],i),{get ModNotesOpener(){return i}}}));